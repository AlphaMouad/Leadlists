<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BROTATO ULTIMATE - Potato Survival</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            color: #fff;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Glassmorphism Screens */
        .screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(12px);
            padding: 2.5rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), inset 0 0 0 1px rgba(255, 215, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
            max-width: 95%;
            animation: fadeIn 0.3s ease;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(180deg, #FFD700 0%, #B8860B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            letter-spacing: -2px;
        }

        .subtitle {
            font-size: 0.8rem;
            margin-bottom: 2rem;
            color: #888;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Buttons */
        .btn {
            padding: 1rem 2.5rem;
            margin: 0.8rem;
            font-size: 0.9rem;
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #444;
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            box-shadow: 0 4px 0 #000;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            color: #FFD700;
            border-color: #FFD700;
            box-shadow: 0 6px 0 #000, 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #000;
        }

        .btn-primary {
            background: linear-gradient(180deg, #FFD700 0%, #B8860B 100%);
            color: #000;
            border: none;
            box-shadow: 0 4px 0 #8B4513;
        }

        .btn-primary:hover {
            color: #000;
            box-shadow: 0 6px 0 #8B4513, 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(180deg, #444 0%, #333 100%);
            border: 1px solid #666;
        }

        .btn-danger {
            background: linear-gradient(180deg, #ff4444 0%, #cc0000 100%);
            border: none;
            color: #fff;
            box-shadow: 0 4px 0 #8b0000;
        }

        .btn-danger:hover {
            box-shadow: 0 6px 0 #8b0000, 0 0 15px rgba(255, 68, 68, 0.4);
        }

        .controls {
            margin-top: 2rem;
            color: #888;
            font-size: 0.7rem;
            line-height: 1.8;
            border-top: 1px solid #333;
            padding-top: 1rem;
        }

        /* HUD */
        #hud {
            position: absolute;
            top: -100px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 16px 16px;
            font-size: 0.8rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .hud-left {
            display: flex;
            gap: 1.5rem;
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: #ddd;
        }

        .hud-item span:first-child {
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
        }

        #timer {
            font-size: 1.4rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Canvas */
        #gameCanvas {
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            display: block;
            background: #111;
        }

        #weaponsDisplay {
            position: absolute;
            bottom: -100px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .weapon-badge {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            color: #000;
            font-size: 0.6rem;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        /* Overlays */
        #shopOverlay, #levelUpOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            border-radius: 8px;
            z-index: 50;
            overflow-y: auto;
            padding: 2rem;
        }

        .shop-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: -1px;
        }

        .shop-grid {
            gap: 2rem;
        }

        .shop-section h3 {
            color: #888;
            margin-bottom: 1rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .shop-items {
            gap: 0.8rem;
        }

        .shop-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.8rem;
            font-size: 0.6rem;
            color: #aaa;
            transition: all 0.2s;
        }

        .shop-btn:not(:disabled):hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #FFD700;
            transform: scale(1.02);
            color: #fff;
        }

        /* Characters */
        .character-select {
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.2s;
            padding: 1.5rem;
        }

        .character-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #FFD700;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .character-card.selected {
            background: rgba(255, 215, 0, 0.1);
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .character-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }

        .character-name {
            font-size: 0.8rem;
            color: #fff;
            margin-bottom: 0.8rem;
        }

        .character-trait {
            font-size: 0.5rem;
            color: #888;
            line-height: 1.6;
        }

        .achievements, .stats-display, .level-up-choices {
            gap: 1rem;
        }

        .achievement, .stat-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
        }

        .achievement.unlocked {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .level-up-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.2s;
            padding: 1.5rem;
        }

        .level-up-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.08);
        }

        .progress-bar {
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            height: 12px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .notification {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #FFD700;
            color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -45%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Menu Screen -->
        <div id="menuScreen" class="screen">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ü•î</div>
            <h1>BROTATO</h1>
            <p class="subtitle">ULTIMATE EDITION</p>
            <button class="btn btn-primary" onclick="showCharacterSelect()">JOUER</button>
            <button class="btn btn-secondary" onclick="showAchievements()">SUCCES</button>
            <button class="btn btn-secondary" onclick="showStats()">STATS</button>
            <div class="controls">
                <p>üéÆ ZQSD/WASD - DEPLACER</p>
                <p>üî´ TIR AUTOMATIQUE</p>
                <p>‚ö° NOUVELLES FEATURES!</p>
                <p>üèÜ 6 PERSONNAGES</p>
                <p>üíé 40+ UPGRADES</p>
                <p>üéØ SYSTEME XP</p>
            </div>
        </div>

        <!-- Character Select -->
        <div id="characterScreen" class="screen hidden">
            <h1>CHOIX HERO</h1>
            <div class="character-select" id="characterSelect"></div>
            <button class="btn btn-primary" onclick="startGameWithCharacter()">COMMENCER</button>
            <button class="btn btn-danger" onclick="backToMenu()">RETOUR</button>
        </div>

        <!-- Achievements Screen -->
        <div id="achievementsScreen" class="screen hidden">
            <h1>SUCCES</h1>
            <div class="achievements" id="achievementsList"></div>
            <button class="btn" onclick="backToMenu()" style="margin-top: 1rem;">RETOUR</button>
        </div>

        <!-- Stats Screen -->
        <div id="statsScreen" class="screen hidden">
            <h1>STATISTIQUES</h1>
            <div class="stats-display" id="statsDisplay"></div>
            <button class="btn" onclick="backToMenu()" style="margin-top: 1rem;">RETOUR</button>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="screen hidden">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üíÄ</div>
            <h1 style="color: #FF4444;">GAME OVER</h1>
            <div style="font-size: 1.2rem; margin: 1rem 0; color: #FFD700;">
                VAGUE: <span id="finalWave">0</span>
            </div>
            <div style="font-size: 1.2rem; margin: 1rem 0; color: #90EE90;">
                SCORE: <span id="finalScore">0</span>
            </div>
            <div style="font-size: 1rem; margin: 1rem 0; color: #DEB887;">
                XP: <span id="finalXP">0</span>
            </div>
            <div id="newAchievements" style="margin: 1rem 0; font-size: 0.6rem; color: #FFD700;"></div>
            <button class="btn btn-primary" onclick="startGameWithCharacter()">REJOUER</button>
            <button class="btn btn-danger" onclick="backToMenu()">MENU</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- HUD -->
            <div id="hud">
                <div class="hud-left">
                    <div class="hud-item">
                        <span>üéØ</span>
                        <span>V.<span id="waveNumber">1</span></span>
                    </div>
                    <div class="hud-item">
                        <span style="color: #FF6B6B;">‚ù§Ô∏è</span>
                        <span id="hpDisplay">100/100</span>
                    </div>
                    <div class="hud-item">
                        <span style="color: #FFD700;">üí∞</span>
                        <span id="coinsDisplay">0</span>
                    </div>
                    <div class="hud-item">
                        <span>‚≠ê</span>
                        <span>Nv.<span id="playerLevel">1</span></span>
                    </div>
                    <div class="hud-item">
                        <span>üìä</span>
                        <span id="scoreDisplay">0</span>
                    </div>
                    <div class="hud-item">
                        <span>üî•</span>
                        <span id="killStreak">0</span>
                    </div>
                </div>
                <div id="timer">25s</div>
            </div>

            <!-- XP Bar -->
            <div style="position: absolute; top: -25px; left: 0; right: 0;">
                <div class="progress-bar">
                    <div class="progress-fill" id="xpBar"></div>
                </div>
            </div>

            <!-- Canvas -->
            <canvas id="gameCanvas" width="1200" height="700"></canvas>

            <!-- Weapons Display -->
            <div id="weaponsDisplay"></div>

            <!-- Shop Overlay -->
            <div id="shopOverlay">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üõí</div>
                <h2 class="shop-title">BOUTIQUE</h2>
                <div class="shop-grid">
                    <div class="shop-section">
                        <h3>ARMES (<span id="weaponCount">1</span>/6)</h3>
                        <div class="shop-items" id="weaponsShop"></div>
                    </div>
                    <div class="shop-section">
                        <h3>AMELIORATIONS</h3>
                        <div class="shop-items" id="itemsShop"></div>
                    </div>
                </div>
                <p style="margin-top: 1rem; color: #DEB887; font-size: 0.7rem;">
                    VAGUE DANS <span id="shopTimer">15</span>s
                </p>
            </div>

            <!-- Level Up Overlay -->
            <div id="levelUpOverlay">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚≠ê</div>
                <h2 class="shop-title">NIVEAU SUPERIEUR!</h2>
                <p style="color: #DEB887; margin-bottom: 1rem; font-size: 0.7rem;">Choisissez une amelioration</p>
                <div class="level-up-choices" id="levelUpChoices"></div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // ==================== CONSTANTS ====================
        const CANVAS_WIDTH = 1200;
        const CANVAS_HEIGHT = 700;
        const WAVE_DURATION = 25000;
        const SHOP_DURATION = 15000;

        // ==================== CHARACTERS ====================
        const CHARACTERS = {
            brotato: {
                name: 'BROTATO',
                icon: 'ü•î',
                color: '#D4A574',
                trait: 'Equilibre - Stats normales',
                stats: { maxHp: 100, speed: 3, damage: 1, attackSpeed: 1, range: 1, crit: 0, armor: 0, regen: 0, luck: 0 }
            },
            tank: {
                name: 'TANK TATO',
                icon: 'üõ°Ô∏è',
                color: '#A9A9A9',
                trait: '+50 HP, +5 Armure, -20% Vitesse',
                stats: { maxHp: 150, speed: 2.4, damage: 1, attackSpeed: 1, range: 1, crit: 0, armor: 5, regen: 1, luck: 0 }
            },
            speedy: {
                name: 'SPEED TATO',
                icon: '‚ö°',
                color: '#FFD700',
                trait: '+50% Vitesse, +30% Vit.Atk, -30 HP',
                stats: { maxHp: 70, speed: 4.5, damage: 1, attackSpeed: 1.3, range: 1, crit: 0.1, armor: 0, regen: 0, luck: 0 }
            },
            sniper: {
                name: 'SNIPER TATO',
                icon: 'üéØ',
                color: '#4169E1',
                trait: '+50% Portee, +30% Crit, -30% Vit.Atk',
                stats: { maxHp: 100, speed: 3, damage: 1.3, attackSpeed: 0.7, range: 1.5, crit: 0.3, armor: 0, regen: 0, luck: 0 }
            },
            lucky: {
                name: 'LUCKY TATO',
                icon: 'üçÄ',
                color: '#32CD32',
                trait: '+50% Chance, +2 Regen, 50% prix boutique',
                stats: { maxHp: 100, speed: 3, damage: 1, attackSpeed: 1, range: 1, crit: 0.15, armor: 0, regen: 2, luck: 0.5 }
            },
            berserker: {
                name: 'BERSERKER',
                icon: 'üò°',
                color: '#DC143C',
                trait: '+50% Degats, +20% Vit.Atk, -2 Armure',
                stats: { maxHp: 100, speed: 3, damage: 1.5, attackSpeed: 1.2, range: 1, crit: 0.2, armor: -2, regen: 0, luck: 0 }
            }
        };

        // ==================== WEAPONS ====================
        const WEAPONS = {
            pistol: { name: 'PISTOLET', damage: 15, speed: 400, range: 250, color: '#FFD700', price: 0, emoji: 'üî´' },
            rifle: { name: 'FUSIL', damage: 25, speed: 600, range: 300, color: '#FF8C42', price: 15, emoji: 'üî´' },
            smg: { name: 'SMG', damage: 10, speed: 200, range: 200, color: '#4ECDC4', price: 20, emoji: 'üî´' },
            shotgun: { name: 'SHOTGUN', damage: 40, speed: 800, range: 150, color: '#95E1D3', price: 25, emoji: 'üí•' },
            sniper: { name: 'SNIPER', damage: 100, speed: 1200, range: 450, color: '#F38181', price: 35, emoji: 'üéØ' },
            flamethrower: { name: 'FLAMMES', damage: 8, speed: 100, range: 180, color: '#FF6B35', price: 30, emoji: 'üî•' },
            laser: { name: 'LASER', damage: 30, speed: 300, range: 350, color: '#00FFFF', price: 40, emoji: '‚ö°' },
            rocket: { name: 'ROCKET', damage: 150, speed: 1500, range: 400, color: '#FF1493', price: 50, emoji: 'üöÄ' },
            minigun: { name: 'MINIGUN', damage: 12, speed: 150, range: 250, color: '#FF4500', price: 45, emoji: 'üî´' },
            crossbow: { name: 'ARBALETE', damage: 60, speed: 900, range: 400, color: '#8B4513', price: 38, emoji: 'üèπ' }
        };

        // ==================== ITEMS ====================
        const ITEMS = [
            // HP & Defense
            { id: 'hp1', name: '+20 HP MAX', stat: 'maxHp', value: 20, price: 10, icon: '‚ù§Ô∏è', tier: 1 },
            { id: 'hp2', name: '+50 HP MAX', stat: 'maxHp', value: 50, price: 25, icon: '‚ù§Ô∏è', tier: 2 },
            { id: 'armor1', name: '+3 ARMURE', stat: 'armor', value: 3, price: 12, icon: 'üõ°Ô∏è', tier: 1 },
            { id: 'armor2', name: '+7 ARMURE', stat: 'armor', value: 7, price: 28, icon: 'üõ°Ô∏è', tier: 2 },
            { id: 'regen1', name: '+2 REGEN/s', stat: 'regen', value: 2, price: 15, icon: 'üíö', tier: 1 },
            { id: 'regen2', name: '+5 REGEN/s', stat: 'regen', value: 5, price: 35, icon: 'üíö', tier: 2 },
            
            // Speed
            { id: 'speed1', name: '+15% VITESSE', stat: 'speed', value: 0.15, price: 12, icon: '‚ö°', tier: 1 },
            { id: 'speed2', name: '+30% VITESSE', stat: 'speed', value: 0.3, price: 28, icon: '‚ö°', tier: 2 },
            { id: 'speed3', name: '+50% VITESSE', stat: 'speed', value: 0.5, price: 50, icon: '‚ö°', tier: 3 },
            
            // Damage
            { id: 'dmg1', name: '+25% DEGATS', stat: 'damage', value: 0.25, price: 15, icon: '‚öîÔ∏è', tier: 1 },
            { id: 'dmg2', name: '+50% DEGATS', stat: 'damage', value: 0.5, price: 35, icon: '‚öîÔ∏è', tier: 2 },
            { id: 'dmg3', name: '+100% DEGATS', stat: 'damage', value: 1, price: 60, icon: '‚öîÔ∏è', tier: 3 },
            
            // Range
            { id: 'range1', name: '+20% PORTEE', stat: 'range', value: 0.2, price: 12, icon: 'üéØ', tier: 1 },
            { id: 'range2', name: '+40% PORTEE', stat: 'range', value: 0.4, price: 28, icon: 'üéØ', tier: 2 },
            { id: 'range3', name: '+70% PORTEE', stat: 'range', value: 0.7, price: 50, icon: 'üéØ', tier: 3 },
            
            // Attack Speed
            { id: 'atk1', name: '+15% VIT.ATK', stat: 'attackSpeed', value: 0.15, price: 15, icon: 'üí®', tier: 1 },
            { id: 'atk2', name: '+35% VIT.ATK', stat: 'attackSpeed', value: 0.35, price: 32, icon: 'üí®', tier: 2 },
            { id: 'atk3', name: '+60% VIT.ATK', stat: 'attackSpeed', value: 0.6, price: 55, icon: 'üí®', tier: 3 },
            
            // Crit
            { id: 'crit1', name: '+10% CRIT', stat: 'crit', value: 0.1, price: 18, icon: 'üí•', tier: 1 },
            { id: 'crit2', name: '+20% CRIT', stat: 'crit', value: 0.2, price: 40, icon: 'üí•', tier: 2 },
            { id: 'crit3', name: '+35% CRIT', stat: 'crit', value: 0.35, price: 70, icon: 'üí•', tier: 3 },
            
            // Luck
            { id: 'luck1', name: '+15% CHANCE', stat: 'luck', value: 0.15, price: 20, icon: 'üçÄ', tier: 1 },
            { id: 'luck2', name: '+30% CHANCE', stat: 'luck', value: 0.3, price: 45, icon: 'üçÄ', tier: 2 },
            
            // Special
            { id: 'lifesteal', name: '+5% VOL VIE', stat: 'lifesteal', value: 0.05, price: 40, icon: 'ü©∏', tier: 2 },
            { id: 'dodge', name: '+10% ESQUIVE', stat: 'dodge', value: 0.1, price: 35, icon: 'üí®', tier: 2 },
            { id: 'thorns', name: '+15 EPINES', stat: 'thorns', value: 15, price: 30, icon: 'üåµ', tier: 2 },
            { id: 'magnet', name: '+30% AIMANT', stat: 'magnet', value: 0.3, price: 25, icon: 'üß≤', tier: 1 }
        ];

        // ==================== ACHIEVEMENTS ====================
        const ACHIEVEMENTS = [
            { id: 'wave5', name: 'SURVIVANT', desc: 'Atteindre vague 5', check: () => gameData.maxWave >= 5 },
            { id: 'wave10', name: 'GUERRIER', desc: 'Atteindre vague 10', check: () => gameData.maxWave >= 10 },
            { id: 'wave20', name: 'LEGENDE', desc: 'Atteindre vague 20', check: () => gameData.maxWave >= 20 },
            { id: 'kills100', name: 'TUEUR', desc: '100 ennemis tues', check: () => gameData.totalKills >= 100 },
            { id: 'kills500', name: 'MASSACREUR', desc: '500 ennemis tues', check: () => gameData.totalKills >= 500 },
            { id: 'coins1000', name: 'RICHE', desc: 'Gagner 1000 pieces', check: () => gameData.totalCoins >= 1000 },
            { id: 'allweapons', name: 'ARSENAL', desc: '6 armes en meme temps', check: () => gameData.had6Weapons },
            { id: 'noarmor', name: 'VERRE', desc: 'Vague 10 sans armure', check: () => gameData.wave10NoArmor },
            { id: 'speed', name: 'SONIC', desc: '200% vitesse', check: () => gameData.had200Speed },
            { id: 'allchars', name: 'COLLECTION', desc: 'Jouer tous les heros', check: () => Object.keys(CHARACTERS).every(c => gameData.playedCharacters[c]) }
        ];

        // ==================== GAME DATA ====================
        let gameData = {
            maxWave: 0,
            totalKills: 0,
            totalCoins: 0,
            totalGames: 0,
            totalScore: 0,
            had6Weapons: false,
            wave10NoArmor: false,
            had200Speed: false,
            playedCharacters: {},
            unlockedAchievements: {}
        };

        // Load saved data
        if (localStorage.getItem('brotatoData')) {
            gameData = { ...gameData, ...JSON.parse(localStorage.getItem('brotatoData')) };
        }

        // ==================== GAME STATE ====================
        let gameState = 'menu';
        let freezeFrame = 0;
        let selectedCharacter = 'brotato';
        let wave = 1;
        let timer = WAVE_DURATION;
        let coins = 0;
        let score = 0;
        let playerXP = 0;
        let playerLevel = 1;
        let killStreak = 0;
        let maxKillStreak = 0;

        // Player
        let player = null;

        // Game objects
        let enemies = [];
        let projectiles = [];
        let particles = [];
        let droppedCoins = [];
        let droppedXP = [];
        let floatingTexts = [];

        // Input
        const keysPressed = {};
        const lastShot = {};

        // Canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ==================== UTILITY FUNCTIONS ====================
        function saveGameData() {
            localStorage.setItem('brotatoData', JSON.stringify(gameData));
        }

        function showNotification(text) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = text;
            document.getElementById('notificationContainer').appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function spawnFloatingText(x, y, text, color, size = 12) {
            floatingTexts.push({
                x, y, text, color, size,
                vy: -2,
                life: 60,
                opacity: 1
            });
        }

        function checkAchievements() {
            const newAchievements = [];
            ACHIEVEMENTS.forEach(ach => {
                if (!gameData.unlockedAchievements[ach.id] && ach.check()) {
                    gameData.unlockedAchievements[ach.id] = true;
                    newAchievements.push(ach.name);
                    showNotification('üèÜ ' + ach.name);
                }
            });
            return newAchievements;
        }

        function getXPForLevel(level) {
            return Math.floor(100 * Math.pow(1.5, level - 1));
        }

        function addXP(amount) {
            playerXP += amount;
            const xpNeeded = getXPForLevel(playerLevel);
            
            while (playerXP >= xpNeeded) {
                playerXP -= xpNeeded;
                playerLevel++;
                showLevelUp();
            }
            
            updateXPBar();
        }

        function updateXPBar() {
            const xpNeeded = getXPForLevel(playerLevel);
            const percent = (playerXP / xpNeeded) * 100;
            document.getElementById('xpBar').style.width = percent + '%';
        }

        // ==================== UI FUNCTIONS ====================
        function showCharacterSelect() {
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('characterScreen').classList.remove('hidden');
            
            const container = document.getElementById('characterSelect');
            container.innerHTML = '';
            
            Object.entries(CHARACTERS).forEach(([key, char]) => {
                const card = document.createElement('div');
                card.className = 'character-card';
                if (key === selectedCharacter) card.classList.add('selected');
                
                card.innerHTML = `
                    <div class="character-icon">${char.icon}</div>
                    <div class="character-name">${char.name}</div>
                    <div class="character-trait">${char.trait}</div>
                `;
                
                card.onclick = () => {
                    selectedCharacter = key;
                    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                };
                
                container.appendChild(card);
            });
        }

        function showAchievements() {
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('achievementsScreen').classList.remove('hidden');
            
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            
            ACHIEVEMENTS.forEach(ach => {
                const div = document.createElement('div');
                div.className = 'achievement';
                if (gameData.unlockedAchievements[ach.id]) div.classList.add('unlocked');
                
                div.innerHTML = `
                    <span>${gameData.unlockedAchievements[ach.id] ? '‚úÖ' : 'üîí'}</span>
                    <div>
                        <div style="color: #FFD700;">${ach.name}</div>
                        <div style="color: #DEB887;">${ach.desc}</div>
                    </div>
                `;
                
                list.appendChild(div);
            });
        }

        function showStats() {
            document.getElementById('menuScreen').classList.add('hidden');
            document.getElementById('statsScreen').classList.remove('hidden');
            
            const display = document.getElementById('statsDisplay');
            display.innerHTML = `
                <div class="stat-item">üìä PARTIES: ${gameData.totalGames}</div>
                <div class="stat-item">üéØ VAGUE MAX: ${gameData.maxWave}</div>
                <div class="stat-item">üíÄ KILLS: ${gameData.totalKills}</div>
                <div class="stat-item">üí∞ PIECES: ${gameData.totalCoins}</div>
                <div class="stat-item">‚≠ê SCORE TOTAL: ${gameData.totalScore}</div>
                <div class="stat-item">üèÜ SUCCES: ${Object.keys(gameData.unlockedAchievements).length}/${ACHIEVEMENTS.length}</div>
            `;
        }

        function backToMenu() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('menuScreen').classList.remove('hidden');
        }

        // ==================== EVENT LISTENERS ====================
        window.addEventListener('keydown', (e) => {
            keysPressed[e.key.toLowerCase()] = true;
        });

        window.addEventListener('keyup', (e) => {
            keysPressed[e.key.toLowerCase()] = false;
        });

        // ==================== DRAWING FUNCTIONS ====================
        function drawPotato(x, y, radius, color, angle = 0) {
            ctx.save();
            ctx.translate(x, y);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(0, radius + 5, radius * 0.8, radius * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.rotate(angle);
            
            // Body (slightly wobbling)
            const time = Date.now() * 0.005;
            const stretch = Math.sin(time) * 0.05;

            ctx.fillStyle = color;
            ctx.strokeStyle = '#4a2c0f';
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            ctx.ellipse(0, 0, radius * (1.1 + stretch), radius * (0.95 - stretch), 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Texture/spots
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath();
            ctx.arc(-radius*0.3, -radius*0.2, radius*0.15, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(radius*0.4, radius*0.3, radius*0.1, 0, Math.PI*2);
            ctx.fill();

            // Eyes (Tracking nearest enemy)
            let lookX = 0, lookY = 0;
            let nearestDist = Infinity;
            enemies.forEach(e => {
                const d = Math.hypot(e.x - x, e.y - y);
                if (d < nearestDist) {
                    nearestDist = d;
                    lookX = (e.x - x) / d;
                    lookY = (e.y - y) / d;
                }
            });
            // Default look forward if no enemies
            if (nearestDist === Infinity) {
                if (keysPressed['d']) lookX = 1;
                else if (keysPressed['q']) lookX = -1;
                if (keysPressed['s']) lookY = 1;
                else if (keysPressed['z']) lookY = -1;
            }

            const eyeOffset = radius * 0.15;
            
            // White of eyes
            ctx.fillStyle = '#fff';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            
            ctx.beginPath();
            ctx.ellipse(-radius*0.3, -radius*0.1, radius*0.25, radius*0.3, 0, 0, Math.PI*2);
            ctx.fill(); ctx.stroke();
            
            ctx.beginPath();
            ctx.ellipse(radius*0.3, -radius*0.1, radius*0.25, radius*0.3, 0, 0, Math.PI*2);
            ctx.fill(); ctx.stroke();

            // Pupils
            ctx.fillStyle = '#000';
            const pupilSize = radius * 0.1;
            ctx.beginPath();
            ctx.arc(-radius*0.3 + lookX*eyeOffset, -radius*0.1 + lookY*eyeOffset, pupilSize, 0, Math.PI*2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(radius*0.3 + lookX*eyeOffset, -radius*0.1 + lookY*eyeOffset, pupilSize, 0, Math.PI*2);
            ctx.fill();
            
            // Eyebrows (Angry if enemies nearby)
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            if (nearestDist < 300) {
                ctx.beginPath();
                ctx.moveTo(-radius*0.5, -radius*0.5);
                ctx.lineTo(-radius*0.1, -radius*0.3);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(radius*0.5, -radius*0.5);
                ctx.lineTo(radius*0.1, -radius*0.3);
                ctx.stroke();
            }

            // Weapon holding hands
            if (player && player.weapons && player.weapons.length > 0) {
                ctx.fillStyle = color;
                ctx.strokeStyle = '#4a2c0f';
                // Just draw two simple hands
                ctx.beginPath();
                ctx.arc(-radius*0.9, radius*0.2, 8, 0, Math.PI*2);
                ctx.fill(); ctx.stroke();

                ctx.beginPath();
                ctx.arc(radius*0.9, radius*0.2, 8, 0, Math.PI*2);
                ctx.fill(); ctx.stroke();
            }

            ctx.restore();
        }

        function drawEnemyBlob(x, y, radius, color, isHit) {
            ctx.save();
            ctx.translate(x, y);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(0, radius*0.8, radius*0.8, radius*0.3, 0, 0, Math.PI*2);
            ctx.fill();

            // Flash white if hit
            if (isHit) {
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#fff';
            } else {
                ctx.fillStyle = color;
                ctx.strokeStyle = '#000';
            }

            ctx.lineWidth = 2;
            
            // Wobbly shape
            const time = Date.now();
            ctx.beginPath();
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const wobble = Math.sin(time * 0.01 + i * 2) * radius * 0.15;
                const r = radius + wobble;
                const px = Math.cos(angle) * r;
                const py = Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Face
            if (!isHit) {
                ctx.fillStyle = '#000';

                // Eyes
                ctx.beginPath();
                ctx.ellipse(-radius*0.3, -radius*0.2, radius*0.15, radius*0.2, 0, 0, Math.PI*2);
                ctx.fill();

                ctx.beginPath();
                ctx.ellipse(radius*0.3, -radius*0.2, radius*0.15, radius*0.2, 0, 0, Math.PI*2);
                ctx.fill();

                // Mouth (Angry)
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-radius*0.3, radius*0.2);
                ctx.quadraticCurveTo(0, radius*0.05, radius*0.3, radius*0.2);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // ==================== GAME LOGIC ====================
        function initPlayer(charKey) {
            const char = CHARACTERS[charKey];
            const baseStats = { ...char.stats };
            
            player = {
                x: CANVAS_WIDTH / 2,
                y: CANVAS_HEIGHT / 2,
                radius: 25,
                vx: 0,
                vy: 0,
                hp: baseStats.maxHp,
                maxHp: baseStats.maxHp,
                speed: baseStats.speed,
                baseSpeed: baseStats.speed,
                weapons: ['pistol'],
                stats: baseStats,
                angle: 0,
                character: charKey,
                color: char.color
            };
        }

        function startGameWithCharacter() {
            gameState = 'playing';
            wave = 1;
            timer = WAVE_DURATION;
            coins = 10;
            score = 0;
            playerXP = 0;
            playerLevel = 1;
            killStreak = 0;
            maxKillStreak = 0;
            
            initPlayer(selectedCharacter);
            
            enemies = [];
            projectiles = [];
            particles = [];
            droppedCoins = [];
            droppedXP = [];
            
            gameData.playedCharacters[selectedCharacter] = true;
            gameData.totalGames++;
            saveGameData();

            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateHUD();
            updateWeaponsDisplay();
            updateXPBar();
            gameLoop();
        }

        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch(side) {
                case 0: x = Math.random() * CANVAS_WIDTH; y = -30; break;
                case 1: x = CANVAS_WIDTH + 30; y = Math.random() * CANVAS_HEIGHT; break;
                case 2: x = Math.random() * CANVAS_WIDTH; y = CANVAS_HEIGHT + 30; break;
                case 3: x = -30; y = Math.random() * CANVAS_HEIGHT; break;
            }

            let type = 'normal';
            let radius = 18;
            let hp = 30 + (wave * 15);
            let speed = 1 + (wave * 0.08);
            let color = `hsl(${120 + Math.random() * 60}, 60%, 40%)`;

            // Elite Variants
            const rand = Math.random();
            if (wave >= 3 && rand < 0.2) {
                type = 'rusher';
                radius = 12;
                hp *= 0.6;
                speed *= 1.6;
                color = '#FF4444';
            } else if (wave >= 5 && rand > 0.85) {
                type = 'tank';
                radius = 32;
                hp *= 3;
                speed *= 0.5;
                color = '#555';
            }

            enemies.push({
                id: Math.random(),
                x, y,
                radius,
                hp,
                maxHp: hp,
                speed,
                color,
                type,
                xpValue: 5 + Math.floor(wave / 2),
                hitFlash: 0
            });
        }

        function shoot(weapon) {
            const weaponData = WEAPONS[weapon];
            const now = Date.now();
            const cooldown = weaponData.speed / player.stats.attackSpeed;
            
            if (!lastShot[weapon] || now - lastShot[weapon] > cooldown) {
                lastShot[weapon] = now;

                let nearestEnemy = null;
                let minDist = Infinity;
                
                enemies.forEach(enemy => {
                    const dist = Math.hypot(enemy.x - player.x, enemy.y - player.y);
                    if (dist < minDist && dist < weaponData.range * player.stats.range) {
                        minDist = dist;
                        nearestEnemy = enemy;
                    }
                });

                if (nearestEnemy) {
                    const angle = Math.atan2(nearestEnemy.y - player.y, nearestEnemy.x - player.x);
                    const isCrit = Math.random() < player.stats.crit;
                    
                    projectiles.push({
                        id: Math.random(),
                        x: player.x,
                        y: player.y,
                        vx: Math.cos(angle) * 10,
                        vy: Math.sin(angle) * 10,
                        damage: weaponData.damage * player.stats.damage * (isCrit ? 2.5 : 1),
                        color: weaponData.color,
                        isCrit,
                        range: weaponData.range * player.stats.range,
                        startX: player.x,
                        startY: player.y
                    });
                }
            }
        }

        function updateHUD() {
            document.getElementById('waveNumber').textContent = wave;
            document.getElementById('hpDisplay').textContent = `${Math.round(player.hp)}/${player.maxHp}`;
            document.getElementById('coinsDisplay').textContent = coins;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('playerLevel').textContent = playerLevel;
            document.getElementById('killStreak').textContent = killStreak;
            document.getElementById('timer').textContent = Math.ceil(timer / 1000) + 's';
            document.getElementById('timer').style.color = timer < 5000 ? '#FF4444' : '#FFD700';
        }

        function updateWeaponsDisplay() {
            const display = document.getElementById('weaponsDisplay');
            display.innerHTML = '';
            player.weapons.forEach(weapon => {
                const badge = document.createElement('div');
                badge.className = 'weapon-badge';
                badge.style.background = WEAPONS[weapon].color;
                badge.style.boxShadow = `0 0 12px ${WEAPONS[weapon].color}`;
                badge.textContent = WEAPONS[weapon].emoji + ' ' + WEAPONS[weapon].name;
                display.appendChild(badge);
            });
            
            if (player.weapons.length >= 6) {
                gameData.had6Weapons = true;
            }
        }

        function applyDiscount(price) {
            return Math.floor(price * (1 - player.stats.luck / 2));
        }

        function buyWeapon(weaponKey) {
            const weapon = WEAPONS[weaponKey];
            const finalPrice = applyDiscount(weapon.price);
            
            if (coins >= finalPrice && player.weapons.length < 6 && !player.weapons.includes(weaponKey)) {
                coins -= finalPrice;
                player.weapons.push(weaponKey);
                updateWeaponsDisplay();
                updateShop();
            }
        }

        function buyItem(item) {
            const finalPrice = applyDiscount(item.price);
            
            if (coins >= finalPrice) {
                coins -= finalPrice;
                
                if (item.stat === 'maxHp') {
                    player.maxHp += item.value;
                    player.hp += item.value;
                } else if (item.stat === 'speed') {
                    player.speed = player.baseSpeed * (1 + item.value);
                    player.baseSpeed = player.speed;
                    if (player.speed >= player.baseSpeed * 2) {
                        gameData.had200Speed = true;
                    }
                } else if (player.stats.hasOwnProperty(item.stat)) {
                    player.stats[item.stat] += item.value;
                } else {
                    player.stats[item.stat] = item.value;
                }
                
                updateShop();
            }
        }

        function updateShop() {
            updateHUD();
            
            const weaponsShop = document.getElementById('weaponsShop');
            weaponsShop.innerHTML = '';
            document.getElementById('weaponCount').textContent = player.weapons.length;
            
            Object.entries(WEAPONS).filter(([key]) => !player.weapons.includes(key)).forEach(([key, weapon]) => {
                const finalPrice = applyDiscount(weapon.price);
                const btn = document.createElement('button');
                btn.className = 'shop-btn';
                const canBuy = coins >= finalPrice && player.weapons.length < 6;
                btn.disabled = !canBuy;
                btn.style.background = canBuy ? weapon.color : '#3d2a14';
                btn.style.borderColor = weapon.color;
                btn.style.color = canBuy ? '#2d1b00' : '#8B4513';
                
                const priceText = finalPrice < weapon.price ? 
                    `<span style="text-decoration:line-through;color:#888;">${weapon.price}</span> ${finalPrice}üí∞` : 
                    `${finalPrice}üí∞`;
                
                btn.innerHTML = `<span>${weapon.emoji} ${weapon.name}</span><span style="color: #FFD700">${priceText}</span>`;
                btn.onclick = () => buyWeapon(key);
                weaponsShop.appendChild(btn);
            });

            const itemsShop = document.getElementById('itemsShop');
            itemsShop.innerHTML = '';
            
            ITEMS.forEach(item => {
                const finalPrice = applyDiscount(item.price);
                const btn = document.createElement('button');
                btn.className = 'shop-btn';
                const canBuy = coins >= finalPrice;
                btn.disabled = !canBuy;
                
                const tierColor = item.tier === 3 ? '#FF69B4' : item.tier === 2 ? '#9370DB' : '#90EE90';
                btn.style.background = canBuy ? tierColor : '#3d2a14';
                btn.style.borderColor = '#8B4513';
                btn.style.color = canBuy ? '#2d1b00' : '#8B4513';
                
                const priceText = finalPrice < item.price ? 
                    `<span style="text-decoration:line-through;color:#888;">${item.price}</span> ${finalPrice}üí∞` : 
                    `${finalPrice}üí∞`;
                
                btn.innerHTML = `<span>${item.icon} ${item.name}</span><span style="color: #FFD700">${priceText}</span>`;
                btn.onclick = () => buyItem(item);
                itemsShop.appendChild(btn);
            });
        }

        function showLevelUp() {
            gameState = 'levelup';
            document.getElementById('levelUpOverlay').style.display = 'flex';
            
            const choices = document.getElementById('levelUpChoices');
            choices.innerHTML = '';
            
            // Generate 3 random upgrades
            const availableUpgrades = [...ITEMS];
            const selectedUpgrades = [];
            
            for (let i = 0; i < 3 && availableUpgrades.length > 0; i++) {
                const idx = Math.floor(Math.random() * availableUpgrades.length);
                selectedUpgrades.push(availableUpgrades.splice(idx, 1)[0]);
            }
            
            selectedUpgrades.forEach(item => {
                const card = document.createElement('div');
                card.className = 'level-up-card';
                
                const tierColor = item.tier === 3 ? '#FF69B4' : item.tier === 2 ? '#9370DB' : '#90EE90';
                card.style.borderColor = tierColor;
                
                card.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${item.icon}</div>
                    <div style="font-size: 0.6rem; color: #FFD700; margin-bottom: 0.5rem;">${item.name}</div>
                    <div style="font-size: 0.5rem; color: #DEB887;">GRATUIT!</div>
                `;
                
                card.onclick = () => {
                    if (item.stat === 'maxHp') {
                        player.maxHp += item.value;
                        player.hp += item.value;
                    } else if (item.stat === 'speed') {
                        player.speed = player.baseSpeed * (1 + item.value);
                        player.baseSpeed = player.speed;
                    } else if (player.stats.hasOwnProperty(item.stat)) {
                        player.stats[item.stat] += item.value;
                    } else {
                        player.stats[item.stat] = item.value;
                    }
                    
                    document.getElementById('levelUpOverlay').style.display = 'none';
                    gameState = 'playing';
                    showNotification('‚≠ê ' + item.name);
                };
                
                choices.appendChild(card);
            });
        }

        // ==================== RENDERING SYSTEM ====================
        const Camera = {
            x: 0,
            y: 0,
            shake: 0,
            update: function() {
                if (this.shake > 0) {
                    this.x = (Math.random() - 0.5) * this.shake;
                    this.y = (Math.random() - 0.5) * this.shake;
                    this.shake *= 0.9;
                    if (this.shake < 0.5) this.shake = 0;
                } else {
                    this.x = 0;
                    this.y = 0;
                }
            }
        };

        const Renderer = {
            drawBackground: function() {
                ctx.fillStyle = '#1a0f00';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                // Advanced background pattern
                ctx.save();
                ctx.fillStyle = 'rgba(139, 69, 19, 0.1)';
                for (let i = 0; i < CANVAS_WIDTH; i += 60) {
                    for (let j = 0; j < CANVAS_HEIGHT; j += 60) {
                        if ((i + j) % 120 === 0) {
                            ctx.beginPath();
                            ctx.arc(i, j, 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
                ctx.restore();

                // Grid
                ctx.strokeStyle = 'rgba(139, 69, 19, 0.08)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < CANVAS_WIDTH; i += 100) {
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, CANVAS_HEIGHT);
                }
                for (let i = 0; i < CANVAS_HEIGHT; i += 100) {
                    ctx.moveTo(0, i);
                    ctx.lineTo(CANVAS_WIDTH, i);
                }
                ctx.stroke();
            },

            render: function() {
                ctx.save();
                ctx.translate(Camera.x, Camera.y);

                this.drawBackground();

                // Coins
                droppedCoins.forEach(coin => {
                    ctx.save();
                    ctx.translate(coin.x, coin.y);
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 12);
                    gradient.addColorStop(0, 'rgba(255, 215, 0, 0.6)');
                    gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-12, -12, 24, 24);

                    ctx.fillStyle = '#FFD700';
                    ctx.strokeStyle = '#DAA520';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.restore();
                });

                // XP orbs
                droppedXP.forEach(xp => {
                    ctx.save();
                    ctx.translate(xp.x, xp.y);
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 12);
                    gradient.addColorStop(0, 'rgba(144, 238, 144, 0.6)');
                    gradient.addColorStop(1, 'rgba(144, 238, 144, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(-12, -12, 24, 24);

                    ctx.fillStyle = '#90EE90';
                    ctx.strokeStyle = '#228B22';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.restore();
                });

                // Enemies
                enemies.forEach(enemy => {
                    drawEnemyBlob(enemy.x, enemy.y, enemy.radius, enemy.color, enemy.hitFlash > 0);
                    // Health bar
                    const hpPercent = enemy.hp / enemy.maxHp;
                    ctx.fillStyle = 'rgba(0,0,0,0.7)';
                    ctx.fillRect(enemy.x - 22, enemy.y - 30, 44, 6);
                    ctx.fillStyle = hpPercent > 0.5 ? '#90EE90' : hpPercent > 0.25 ? '#FFD93D' : '#FF6B6B';
                    ctx.fillRect(enemy.x - 22, enemy.y - 30, 44 * hpPercent, 6);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(enemy.x - 22, enemy.y - 30, 44, 6);
                });

                // Projectiles
                projectiles.forEach(proj => {
                    ctx.fillStyle = proj.color;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    const size = proj.isCrit ? 8 : 5;
                    const gradient = ctx.createRadialGradient(proj.x, proj.y, 0, proj.x, proj.y, size * 2);
                    gradient.addColorStop(0, proj.color);
                    gradient.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(proj.x - size * 2, proj.y - size * 2, size * 4, size * 4);

                    ctx.fillStyle = proj.color;
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();

                    if (proj.isCrit) {
                        ctx.fillStyle = '#FFD700';
                        ctx.font = '12px Press Start 2P';
                        ctx.fillText('CRIT!', proj.x + 10, proj.y - 10);
                    }
                });

                // Particles
                particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 30;
                    ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
                    ctx.globalAlpha = 1;
                });

                // Floating Texts
                floatingTexts.forEach(t => {
                    ctx.save();
                    ctx.fillStyle = t.color;
                    ctx.globalAlpha = t.opacity;
                    ctx.font = `bold ${t.size}px "Press Start 2P"`;
                    ctx.textAlign = 'center';
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 3;
                    ctx.strokeText(t.text, t.x, t.y);
                    ctx.fillText(t.text, t.x, t.y);
                    ctx.restore();
                });

                // Player
                if (player) {
                    drawPotato(player.x, player.y, player.radius, player.color, player.angle);

                    // Player HP bar
                    const hpPercent = player.hp / player.maxHp;
                    ctx.fillStyle = 'rgba(0,0,0,0.8)';
                    ctx.fillRect(player.x - 30, player.y - 45, 60, 8);
                    ctx.fillStyle = hpPercent > 0.5 ? '#90EE90' : hpPercent > 0.25 ? '#FFD93D' : '#FF6B6B';
                    ctx.fillRect(player.x - 30, player.y - 45, 60 * hpPercent, 8);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(player.x - 30, player.y - 45, 60, 8);

                    // Kill streak
                    if (killStreak > 5) {
                        ctx.fillStyle = '#FFD700';
                        ctx.font = '16px Press Start 2P';
                        ctx.textAlign = 'center';
                        ctx.fillText('üî• x' + killStreak, player.x, player.y - 60);
                    }
                }

                // Lighting / Vignette
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);

                const grad = ctx.createRadialGradient(CANVAS_WIDTH/2, CANVAS_HEIGHT/2, CANVAS_HEIGHT/3, CANVAS_WIDTH/2, CANVAS_HEIGHT/2, CANVAS_HEIGHT);
                grad.addColorStop(0, 'rgba(0,0,0,0)');
                grad.addColorStop(1, 'rgba(0,0,0,0.7)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                ctx.restore();

                ctx.restore();
            }
        };

        // ==================== GAME LOOP ====================
        let lastTime = Date.now();
        let enemySpawnTimer = 0;

        function gameLoop() {
            if (freezeFrame > 0) {
                freezeFrame--;
                requestAnimationFrame(gameLoop);
                return;
            }

            if (gameState === 'menu' || gameState === 'gameover') return;

            const now = Date.now();
            const deltaTime = now - lastTime;
            lastTime = now;

            if (gameState === 'playing') Camera.update();

            // Timer
            if (gameState === 'playing') {
                timer -= deltaTime;
                if (timer <= 0) {
                    gameState = 'shop';
                    timer = SHOP_DURATION;
                    enemies = [];
                    projectiles = [];
                    document.getElementById('shopOverlay').style.display = 'flex';
                    updateShop();
                }
            } else if (gameState === 'shop') {
                timer -= deltaTime;
                document.getElementById('shopTimer').textContent = Math.ceil(timer / 1000);
                if (timer <= 0) {
                    gameState = 'playing';
                    wave++;
                    timer = WAVE_DURATION;
                    document.getElementById('shopOverlay').style.display = 'none';
                    
                    if (wave === 10 && player.stats.armor <= 0) {
                        gameData.wave10NoArmor = true;
                    }
                }
            }

            updateHUD();

            if (gameState === 'playing') {
                // Move player (Physics)
                const acc = player.speed * 0.15;
                const friction = 0.85;

                if (keysPressed['z'] || keysPressed['w']) player.vy -= acc;
                if (keysPressed['s']) player.vy += acc;
                if (keysPressed['q'] || keysPressed['a']) player.vx -= acc;
                if (keysPressed['d']) player.vx += acc;

                player.vx *= friction;
                player.vy *= friction;

                player.x += player.vx;
                player.y += player.vy;

                // Bounds
                player.x = Math.max(player.radius, Math.min(CANVAS_WIDTH - player.radius, player.x));
                player.y = Math.max(player.radius, Math.min(CANVAS_HEIGHT - player.radius, player.y));

                // Angle tilt based on movement
                player.angle = (player.vx / 10) + Math.sin(Date.now() * 0.01) * 0.05;

                // Regen
                if (player.stats.regen > 0) {
                    player.hp = Math.min(player.maxHp, player.hp + player.stats.regen / 60);
                }

                // Auto-shoot
                player.weapons.forEach(weapon => shoot(weapon));

                // Spawn enemies
                enemySpawnTimer += deltaTime;
                if (enemySpawnTimer > 1000) {
                    enemySpawnTimer = 0;
                    const enemyCount = 3 + wave * 2;
                    if (enemies.length < enemyCount) {
                        spawnEnemy();
                    }
                }

                // Move enemies
                enemies.forEach(enemy => {
                    const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    enemy.x += Math.cos(angle) * enemy.speed;
                    enemy.y += Math.sin(angle) * enemy.speed;
                    if (enemy.hitFlash > 0) enemy.hitFlash--;
                });

                // Move projectiles
                projectiles = projectiles.filter(proj => {
                    proj.x += proj.vx;
                    proj.y += proj.vy;
                    const dist = Math.hypot(proj.x - proj.startX, proj.y - proj.startY);
                    return dist < proj.range &&
                           proj.x > 0 && proj.x < CANVAS_WIDTH &&
                           proj.y > 0 && proj.y < CANVAS_HEIGHT;
                });

                // Collision - projectiles vs enemies
                const projectilesToRemove = new Set();
                projectiles.forEach((proj, pIdx) => {
                    enemies.forEach((enemy, eIdx) => {
                        if (!projectilesToRemove.has(pIdx) && 
                            Math.hypot(enemy.x - proj.x, enemy.y - proj.y) < enemy.radius + 5) {
                            projectilesToRemove.add(pIdx);
                            enemy.hp -= proj.damage;
                            enemy.hitFlash = 4;
                            spawnFloatingText(enemy.x, enemy.y - 20, Math.floor(proj.damage), proj.isCrit ? '#FFD700' : '#fff', proj.isCrit ? 16 : 10);
                            if (proj.isCrit) {
                                Camera.shake = 5;
                                freezeFrame = 2;
                            }

                            // Lifesteal
                            if (player.stats.lifesteal) {
                                player.hp = Math.min(player.maxHp, player.hp + proj.damage * player.stats.lifesteal);
                            }

                            // Particles
                            for (let i = 0; i < 5; i++) {
                                particles.push({
                                    x: proj.x,
                                    y: proj.y,
                                    vx: (Math.random() - 0.5) * 6,
                                    vy: (Math.random() - 0.5) * 6,
                                    life: 30,
                                    color: proj.color,
                                    size: proj.isCrit ? 6 : 3
                                });
                            }

                            if (enemy.hp <= 0) {
                                // Drop coins
                                const coinValue = 1 + Math.floor(wave / 3);
                                const bonusCoins = Math.random() < player.stats.luck ? coinValue : 0;
                                
                                droppedCoins.push({
                                    x: enemy.x,
                                    y: enemy.y,
                                    value: coinValue + bonusCoins
                                });
                                
                                // Drop XP
                                droppedXP.push({
                                    x: enemy.x,
                                    y: enemy.y,
                                    value: enemy.xpValue
                                });
                                
                                score += 10 + (wave * 2);
                                killStreak++;
                                maxKillStreak = Math.max(maxKillStreak, killStreak);
                                gameData.totalKills++;
                                
                                enemies.splice(eIdx, 1);
                            }
                        }
                    });
                });
                projectiles = projectiles.filter((_, idx) => !projectilesToRemove.has(idx));

                // Collision - player vs enemies
                enemies.forEach(enemy => {
                    if (Math.hypot(enemy.x - player.x, enemy.y - player.y) < enemy.radius + player.radius) {
                        // Dodge check
                        if (player.stats.dodge && Math.random() < player.stats.dodge) {
                            showNotification('üí® ESQUIVE!');
                            return;
                        }
                        
                        const damage = Math.max(1, 5 - player.stats.armor);
                        player.hp -= damage;
                        killStreak = 0;
                        Camera.shake = 10;
                        freezeFrame = 4;
                        spawnFloatingText(player.x, player.y - 30, '-' + damage, '#FF4444', 14);
                        
                        // Thorns
                        if (player.stats.thorns) {
                            enemy.hp -= player.stats.thorns;
                        }
                        
                        if (player.hp <= 0) {
                            endGame();
                            return;
                        }
                    }
                });

                // Collect coins
                const magnetRange = 30 + (player.stats.magnet ? player.stats.magnet * 100 : 0);
                droppedCoins = droppedCoins.filter(coin => {
                    const dist = Math.hypot(coin.x - player.x, coin.y - player.y);
                    
                    if (dist < magnetRange) {
                        const angle = Math.atan2(player.y - coin.y, player.x - coin.x);
                        coin.x += Math.cos(angle) * 5;
                        coin.y += Math.sin(angle) * 5;
                    }
                    
                    if (dist < 40) {
                        coins += coin.value;
                        gameData.totalCoins += coin.value;
                        return false;
                    }
                    return true;
                });
                
                // Collect XP
                droppedXP = droppedXP.filter(xp => {
                    const dist = Math.hypot(xp.x - player.x, xp.y - player.y);
                    
                    if (dist < magnetRange) {
                        const angle = Math.atan2(player.y - xp.y, player.x - xp.x);
                        xp.x += Math.cos(angle) * 5;
                        xp.y += Math.sin(angle) * 5;
                    }
                    
                    if (dist < 40) {
                        addXP(xp.value);
                        return false;
                    }
                    return true;
                });

                // Update particles
                particles = particles.filter(p => p.life > 0).map(p => ({
                    ...p,
                    x: p.x + p.vx,
                    y: p.y + p.vy,
                    vy: p.vy + 0.3,
                    life: p.life - 1
                }));

                // Update floating texts
                floatingTexts = floatingTexts.filter(t => t.life > 0).map(t => ({
                    ...t,
                    x: t.x,
                    y: t.y + t.vy,
                    vy: t.vy * 0.95,
                    life: t.life - 1,
                    opacity: t.life / 20 > 1 ? 1 : t.life / 20
                }));
            }

            Renderer.render();
            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameState = 'gameover';
            
            // Update stats
            gameData.maxWave = Math.max(gameData.maxWave, wave);
            gameData.totalScore += score;
            
            // Check achievements
            const newAchs = checkAchievements();
            saveGameData();
            
            // Show game over screen
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalWave').textContent = wave;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalXP').textContent = playerXP + ' (Nv.' + playerLevel + ')';
            
            const achDiv = document.getElementById('newAchievements');
            if (newAchs.length > 0) {
                achDiv.innerHTML = 'üèÜ NOUVEAUX SUCCES:<br>' + newAchs.join('<br>');
            } else {
                achDiv.innerHTML = '';
            }
        }

    </script>
</body>
</html>