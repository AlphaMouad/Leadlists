<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- === META TAGS === -->
    <title>Dîner Spectacle Marrakech : Réservation VIP (Paiement Sur Place) | Top Spot</title>
    <meta name="description" content="Accès VIP aux 7 meilleurs restaurants festifs de Marrakech. Réservez votre table sans acompte ni carte bancaire. Confirmation WhatsApp 60s. Service Concierge Gratuit.">
    <meta name="theme-color" content="#030303">

    <!-- iOS Safari Enhancements -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- === PERFORMANCE & PRELOADS === -->
    <link rel="preconnect" href="https://iframe.mediadelivery.net" crossorigin>
    <link rel="preconnect" href="https://vz-fe8cf04d-f49.b-cdn.net" crossorigin>
    <link rel="preload" as="image" href="https://MTSZone.b-cdn.net/MalakV2/Malak7.jpg" fetchpriority="high">
    <link rel="preload" as="image" href="https://MTSZone.b-cdn.net/BG/3.png" fetchpriority="high">
    <link rel="preload" as="image" href="https://MTSZone.b-cdn.net/BG/4.png" fetchpriority="high">
    <link rel="preload" as="image" href="https://MTSZone.b-cdn.net/BG/6.png" fetchpriority="high">
    <link rel="preload" as="image" href="https://MTSZone.b-cdn.net/BG/7.png" fetchpriority="high">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fast.wistia.com">
    <link rel="preconnect" href="https://player.mediadelivery.net">
    <link rel="preconnect" href="https://MTSZone.b-cdn.net">
    <link rel="preconnect" href="https://MTSpull.b-cdn.net">
    <link rel="preconnect" href="https://docs.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://docs.google.com">

    <!-- MAPBOX CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

    <!-- BUNNY.NET PLAYER API -->
    <script src="https://assets.mediadelivery.net/playerjs/player-0.1.0.min.js"></script>

    <!-- MAPBOX JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,600;0,700;0,800;0,900;1,500;1,600;1,700;1,800;1,900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- === TRACKING === -->
    <script src="https://t.contentsquare.net/uxa/aa67b454a79ef.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YE8JYR1X97"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YE8JYR1X97');
      gtag('config', 'AW-16808399607');
    </script>

    <style>
        :root {
            /* === ELITE DARK PALETTE === */
            --brand-raspberry: #EC5075;
            --brand-primary: #EC5075;
            --brand-gradient: linear-gradient(135deg, #EC5075 0%, #C2185B 100%);
            --brand-gradient-light: linear-gradient(135deg, #FFF 10%, #FFB6C1 100%);
            --brand-gold: #D4AF37;
            --wa-green: #25D366;

            /* === UI COLORS === */
            --bg-deep: #030303;
            --bg-body: #F9FAFB;
            --bg-card: #FFFFFF;
            --text-light: #FFFFFF;
            --text-dark: #111827;
            --text-body: #4B5563;
            --text-muted: #9CA3AF;

            /* === GLASS VARS === */
            --glass-surface: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);

            /* === ELITE ANIMATIONS === */
            --ease-luxury: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-elite: cubic-bezier(0.19, 1, 0.22, 1); /* Ultra Smooth Luxury */

            /* === SHADOWS === */
            --shadow-card: 0 10px 30px -10px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.02);
            --shadow-elite: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            --radius-lg: 20px;
            --radius-xl: 32px;
            --radius-card: 24px;

            /* iOS Safe Areas */
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-body);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        @media (pointer: coarse) {
            button, select, input, a { min-height: 48px; }
        }

        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; color: var(--text-dark); font-weight: 800; }
        .hidden { display: none !important; }

        /* === HEADER === */
        header {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1000;
            padding: calc(1rem + var(--safe-area-top)) 1.25rem 1rem;
        }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: center; align-items: center; }
        .logo-wordmark {
            font-family: 'Playfair Display', serif; font-weight: 900; text-transform: uppercase;
            line-height: 1; text-decoration: none; display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .logo-wordmark .logo-marrakech { color: #FFFFFF; font-size: 1.35rem; letter-spacing: 3px; font-weight: 800; }
        .logo-wordmark .logo-topspot { color: #EC5075; font-size: 0.8rem; letter-spacing: 2px; font-weight: 700; }
        @media (min-width: 768px) {
            header { padding: 1.5rem; }
            .logo-wordmark .logo-marrakech { font-size: 1.5rem; letter-spacing: 4px; }
            .logo-wordmark .logo-topspot { font-size: 0.95rem; letter-spacing: 2.5px; }
        }

        /* === HERO === */
        .hero {
            position: relative; min-height: 100dvh; display: flex; flex-direction: column; justify-content: flex-start;
            padding: calc(5.5rem + var(--safe-area-top)) 1.25rem calc(4rem + var(--safe-area-bottom));
            text-align: center; overflow: hidden; background: #000; padding-bottom: 5rem; transform: translateZ(0);
        }
        @media (min-width: 768px) { .hero { padding-bottom: 6rem; } }

        .hero-video-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; background: #000; transform: translateZ(0); pointer-events: none;
        }
        .hero-video-bg iframe {
            position: absolute; top: 50%; left: 50%; width: 177.78vh; height: 100vh; min-width: 100%; min-height: 100%;
            transform: translate(-50%, -50%) translateZ(0); border: none; pointer-events: none;
        }

        .hero-slideshow-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; object-position: center; opacity: 0;
            animation: heroSlide 6s infinite; pointer-events: none;
        }
        .hero-slideshow-img:nth-child(1) { animation-delay: 0s; }
        .hero-slideshow-img:nth-child(2) { animation-delay: 1.5s; }
        .hero-slideshow-img:nth-child(3) { animation-delay: 3s; }
        .hero-slideshow-img:nth-child(4) { animation-delay: 4.5s; }

        @keyframes heroSlide {
            0% { opacity: 1; }
            25% { opacity: 1; }
            25.1% { opacity: 0; }
            100% { opacity: 0; }
        }

        .hero-content {
            position: relative; z-index: 10; max-width: 500px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; align-items: center;
        }

        .urgency-pill {
            display: inline-flex; align-items: center; gap: 8px; background: rgba(20, 20, 20, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 14px; border-radius: 100px; margin-bottom: 1.25rem;
            animation: pillFadeIn 0.8s var(--ease-elite) forwards; opacity: 0; transform: translateY(-10px); backdrop-filter: blur(8px);
        }
        @keyframes pillFadeIn { to { opacity: 1; transform: translateY(0); } }
        .pulse-dot { width: 6px; height: 6px; background: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.8); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.9); } }
        .urgency-text { font-size: 0.6rem; font-weight: 700; color: rgba(255, 255, 255, 0.9); text-transform: uppercase; letter-spacing: 1px; }

        .hero h1.hero-title-stack {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 0.8rem; gap: 0;
            animation: titleReveal 1s var(--ease-elite) 0.2s forwards; opacity: 0; transform: translateY(20px);
        }
        @keyframes titleReveal { to { opacity: 1; transform: translateY(0); } }
        .title-line-1 { font-family: 'Playfair Display', serif; font-weight: 400; font-size: 1.1rem; color: rgba(255, 255, 255, 0.9); letter-spacing: 0.02em; margin: 0 0 -0.15em 0; line-height: 1.2; }
        .title-line-2 {
            font-family: 'Playfair Display', serif; font-weight: 700; font-style: italic; font-size: 2.85rem; line-height: 0.95;
            margin: 0; position: relative; display: inline-block; filter: drop-shadow(0 0 25px rgba(236, 80, 117, 0.15)); will-change: transform;
        }
        .shimmer-text {
            background: linear-gradient(90deg, #EC5075 0%, #EC5075 40%, #ff9bab 50%, #EC5075 60%, #EC5075 100%);
            background-size: 200% 100%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            animation: titleShimmer 3s ease-in-out infinite;
        }
        @keyframes titleShimmer { 0% { background-position: 100% 50%; } 100% { background-position: -100% 50%; } }
        .title-line-3 { font-family: 'Playfair Display', serif; font-weight: 400; font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); letter-spacing: 0.02em; margin: 0.5rem 0 0 0; line-height: 1.3; }

        @media (min-width: 400px) {
            .title-line-1 { font-size: 1.2rem; }
            .title-line-2 { font-size: 3.2rem; }
            .title-line-3 { font-size: 1.4rem; margin-top: 0.6rem; }
        }
        @media (min-width: 768px) {
            .title-line-1 { font-size: 1.4rem; }
            .title-line-2 { font-size: 4.2rem; }
            .title-line-3 { font-size: 1.65rem; margin-top: 0.75rem; }
        }

        .hero-subtitle {
            font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 1.25rem; line-height: 1.6; font-weight: 400;
            max-width: 320px; padding: 0 0.5rem; animation: subtitleFade 1s var(--ease-elite) 0.4s forwards; opacity: 0;
        }
        @keyframes subtitleFade { to { opacity: 1; } }
        .hero-subtitle strong { color: rgba(255, 255, 255, 0.95); font-weight: 600; }
        @media (min-width: 768px) { .hero-subtitle { font-size: 1rem; max-width: 400px; } }

        /* === FORM === */
        .hero-form-container {
            width: 100%; background: rgba(10, 10, 10, 0.92); border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px; padding: 1.5rem; margin-bottom: 1rem; position: relative; z-index: 20; transform: translateZ(0);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02), 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 30px rgba(236, 80, 117, 0.08);
            animation: formElevate 1.2s var(--ease-elite) 0.5s forwards; opacity: 0; transform: translateY(30px) scale(0.98);
            transition: box-shadow 0.4s var(--ease-luxury);
        }
        .hero-form-container:focus-within {
            box-shadow: 0 0 0 1px rgba(236, 80, 117, 0.2), 0 30px 60px -15px rgba(0, 0, 0, 0.6), 0 0 45px rgba(236, 80, 117, 0.15);
        }
        .hero-form-container.shake-anim { animation: elite-shake 0.4s ease-in-out; }
        @keyframes formElevate { to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes elite-shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        .hero-form-container::before {
            content: ''; position: absolute; inset: 0; border-radius: 24px; padding: 1px;
            background: linear-gradient(180deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
        }

        .form-trust-header { display: flex; justify-content: center; align-items: center; gap: 6px; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.06); }
        .form-trust-text { color: rgba(255, 255, 255, 0.5); font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .form-group { margin-bottom: 1.1rem; text-align: left; position: relative; }
        .form-group label { display: block; font-size: 0.65rem; font-weight: 600; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 0.5rem; margin-left: 4px; }
        .input-container {
            position: relative; background: rgba(255, 255, 255, 0.04); border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px; transition: all 0.3s var(--ease-elite); overflow: hidden; display: flex; align-items: center;
        }
        .input-container:focus-within {
            border-color: rgba(236, 80, 117, 0.6); background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 0 4px rgba(236, 80, 117, 0.12), 0 0 20px rgba(236, 80, 117, 0.1); transform: translateY(-1px);
        }
        .input-container input, .input-container select {
            width: 100%; height: 52px; padding: 0 16px; border: none; background: transparent; font-weight: 500;
            color: #fff; outline: none; font-family: inherit; -webkit-appearance: none; appearance: none; border-radius: 0;
        }
        @media screen and (-webkit-min-device-pixel-ratio:0) { select, textarea, input { font-size: 16px !important; } }
        @media (min-width: 768px) { .input-container input, .input-container select { font-size: 1rem; } }
        .input-container input::placeholder { color: rgba(255, 255, 255, 0.3); }
        .input-container select {
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 14px center; background-size: 14px; padding-right: 40px;
        }
        .input-container select option { background: #0a0a0a; color: white; padding: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        /* === ELITE PHONE INPUT GROUP === */
        .elite-phone-group { display: flex; align-items: stretch; width: 100%; position: relative; }
        
        /* === ELITE TOUCH & INPUTS === */
        .country-selector {
            display: flex; align-items: center; gap: 4px;
            padding: 0 14px; /* Increased Touch Padding */
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer; position: relative; transition: all 0.2s ease;
            min-width: 115px; /* Wider hit area */
            height: 100%;
        }
        .country-selector:active { background: rgba(255, 255, 255, 0.09); transform: scale(0.98); } /* Haptic visual */
        
        .selected-flag { font-size: 1.6rem; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); pointer-events: none; }
        
        .code-input {
            width: 48px; height: 100%; background: transparent; border: none; color: rgba(255, 255, 255, 0.95);
            font-weight: 700; font-size: 0.95rem; padding: 0; outline: none; text-align: center;
            z-index: 2; /* Ensure clickable */
        }
        .code-input:focus { background: rgba(0,0,0,0.2); border-radius: 4px; }
        
        /* Huge hit target for the arrow */
        .selector-arrow-container {
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 100%; margin-right: -8px;
        }
        .selector-arrow { width: 14px; height: 14px; stroke: rgba(255,255,255,0.5); fill: none; stroke-width: 2.5px; transition: transform 0.3s ease; pointer-events: none; }
        .country-selector.active .selector-arrow { transform: rotate(180deg); stroke: var(--brand-raspberry); }
        
        .country-dropdown {
            position: absolute; top: calc(100% + 12px); left: 0; width: 300px; max-width: 85vw;
            background: rgba(15, 15, 15, 0.99); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 18px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.08);
            z-index: 9999; max-height: 320px; overflow-y: auto;
            opacity: 0; transform: translateY(-15px) scale(0.98); pointer-events: none;
            transition: all 0.35s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 8px;
            /* iOS Scroll Fix */
            -webkit-overflow-scrolling: touch;
        }
        .country-dropdown.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        
        .dropdown-item {
            display: flex; align-items: center; gap: 14px; padding: 14px 16px; /* Larger touch target */
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.85); font-size: 0.9rem; font-weight: 600;
            margin-bottom: 2px;
        }
        .dropdown-item:active { background: rgba(236, 80, 117, 0.15); transform: scale(0.98); } /* Instant touch feedback */
        @media (hover: hover) {
            .dropdown-item:hover { background: rgba(255, 255, 255, 0.08); color: #fff; transform: translateX(4px); }
        }
        .dropdown-item .flag { font-size: 1.2rem; }
        .dropdown-item .c-code { margin-left: auto; color: rgba(255, 255, 255, 0.4); font-weight: 600; font-size: 0.75rem; }
        .dropdown-item.custom-option { border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 4px; border-radius: 0 0 10px 10px; }
        
        /* === ELITE GLOW ANIMATION V2 === */
        .elite-trust-reveal .form-trust-text {
            animation: eliteTextShimmer 2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        .elite-trust-reveal svg {
            animation: eliteCheckPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes eliteTextShimmer {
            0% { color: rgba(255, 255, 255, 0.5); text-shadow: none; transform: scale(1); letter-spacing: 1px; }
            40% { color: #fff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 30px rgba(236, 80, 117, 0.4); transform: scale(1.02); letter-spacing: 1.5px; }
            100% { color: rgba(255, 255, 255, 0.95); text-shadow: 0 0 10px rgba(255, 255, 255, 0.1); transform: scale(1); letter-spacing: 1px; }
        }
        
        @keyframes eliteCheckPop {
            0% { stroke: rgba(255,255,255,0.5); transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(16,185,129,0)); }
            50% { stroke: #10B981; transform: scale(1.4) rotate(15deg); filter: drop-shadow(0 0 10px rgba(16,185,129,0.8)); }
            100% { stroke: #10B981; transform: scale(1.1) rotate(0deg); filter: drop-shadow(0 0 5px rgba(16,185,129,0.4)); stroke-width: 3; }
        }
        
        /* FIX: Allow dropdown to overflow the input container */
        .input-container:has(.elite-phone-group) {
            overflow: visible !important;
            z-index: 100; /* Ensure this container is above others */
        }
        /* Fallback for older browsers if :has isn't supported, though mostly mobile supports it now. 
           We can also add a specific class via JS, but let's try to target the ID in CSS if possible. */
        #container-phone { overflow: visible !important; }

        .phone-input-group input { flex: 1; padding-left: 14px; }

        .kids-toggle-wrapper { margin-bottom: 0; margin-top: 0; transition: all 0.5s var(--ease-elite); opacity: 0; max-height: 0; overflow: hidden; pointer-events: none; }
        .kids-toggle-wrapper.visible { opacity: 1; max-height: 200px; margin-bottom: 1.5rem; margin-top: 0.5rem; pointer-events: auto; }
        .kids-toggle-container {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; transition: all 0.4s var(--ease-elite);
            position: relative; overflow: hidden; cursor: pointer;
        }
        .kids-toggle-container:hover { border-color: rgba(255, 255, 255, 0.1); background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%); }
        .kids-toggle-container::before {
            content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(236, 80, 117, 0.1) 0%, rgba(236, 80, 117, 0.03) 100%);
            opacity: 0; transition: opacity 0.4s var(--ease-elite); pointer-events: none;
        }
        .kids-toggle-container.expanded {
            border-color: rgba(236, 80, 117, 0.3); box-shadow: 0 0 25px rgba(236, 80, 117, 0.12), 0 8px 32px rgba(0, 0, 0, 0.15), inset 0 0 20px rgba(236, 80, 117, 0.03);
        }
        .kids-toggle-container.expanded::before { opacity: 1; }
        .kids-toggle-header { display: flex; align-items: center; gap: 10px; flex: 1; }
        .kids-toggle-icon {
            width: 32px; height: 32px; border-radius: 8px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex; align-items: center; justify-content: center; transition: all 0.35s var(--ease-elite); flex-shrink: 0;
        }
        .kids-toggle-icon svg { width: 15px; height: 15px; stroke: rgba(255, 255, 255, 0.45); transition: all 0.35s var(--ease-elite); }
        .kids-toggle-container.expanded .kids-toggle-icon { background: rgba(236, 80, 117, 0.15); border-color: rgba(236, 80, 117, 0.25); transform: scale(1.05); }
        .kids-toggle-container.expanded .kids-toggle-icon svg { stroke: var(--brand-raspberry); }
        .kids-toggle-text { display: flex; flex-direction: column; gap: 1px; }
        .kids-toggle-text .toggle-title { font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.8); letter-spacing: 0.2px; transition: color 0.3s ease; }
        .kids-toggle-container.expanded .toggle-title { color: rgba(255, 255, 255, 0.95); }
        .kids-toggle-text .toggle-subtitle { font-size: 0.6rem; font-weight: 500; color: rgba(255, 255, 255, 0.35); letter-spacing: 0.1px; }
        .toggle-indicator {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 8px; transition: all 0.35s var(--ease-elite);
        }
        .toggle-indicator-text { font-size: 0.65rem; color: rgba(255, 255, 255, 0.5); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; }
        .kids-toggle-container.expanded .toggle-indicator { background: rgba(236, 80, 117, 0.12); border-color: rgba(236, 80, 117, 0.2); }
        .kids-toggle-container.expanded .toggle-indicator-text { color: var(--brand-raspberry); }
        .toggle-chevron { width: 14px; height: 14px; stroke: rgba(255, 255, 255, 0.4); transition: all 0.35s var(--ease-spring); }
        .kids-toggle-container.expanded .toggle-chevron { transform: rotate(180deg); stroke: var(--brand-raspberry); }
        .kids-selection-panel {
            max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.45s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), padding 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .kids-selection-panel.visible { max-height: 120px; opacity: 1; padding-top: 15px; padding-bottom: 5px; margin-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.05); }
        .kids-counter { display: flex; align-items: center; justify-content: center; gap: 12px; animation: fadeSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeSlideUp { 0% { opacity: 0; transform: translateY(10px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .kids-counter-btn {
            width: 44px; height: 44px; border-radius: 12px; border: 1.5px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03); color: #fff; font-size: 1.3rem; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.25s var(--ease-elite); position: relative; overflow: hidden;
        }
        .kids-counter-btn::before {
            content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--brand-raspberry) 0%, #C2185B 100%);
            opacity: 0; transition: opacity 0.25s var(--ease-elite); border-radius: 10px;
        }
        .kids-counter-btn span { position: relative; z-index: 1; }
        .kids-counter-btn:hover:not(:disabled) { border-color: rgba(236, 80, 117, 0.5); transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(236, 80, 117, 0.25); }
        .kids-counter-btn:hover:not(:disabled)::before { opacity: 1; }
        .kids-counter-btn:active:not(:disabled) { transform: translateY(0) scale(0.95); }
        .kids-counter-btn:disabled { opacity: 0.2; cursor: not-allowed; transform: none; }
        .kids-counter-display {
            display: flex; flex-direction: column; align-items: center; min-width: 60px; padding: 8px 16px;
            background: linear-gradient(135deg, rgba(236, 80, 117, 0.08) 0%, rgba(236, 80, 117, 0.03) 100%);
            border: 1px solid rgba(236, 80, 117, 0.15); border-radius: 12px; transition: all 0.3s var(--ease-elite);
        }
        .kids-counter-value { font-size: 1.4rem; font-weight: 700; color: #fff; line-height: 1; font-family: 'Plus Jakarta Sans', sans-serif; transition: transform 0.2s var(--ease-spring); }
        .kids-counter-value.bump { animation: valueBump 0.3s var(--ease-spring); }
        @keyframes valueBump { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .kids-counter-label { font-size: 0.55rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 3px; font-weight: 600; }
        .kids-count-badge {
            display: none; align-items: center; justify-content: center; min-width: 22px; height: 22px; padding: 0 6px;
            background: linear-gradient(135deg, var(--brand-raspberry) 0%, #C2185B 100%); border-radius: 6px; font-size: 0.7rem; font-weight: 700; color: #fff;
            margin-left: 8px; animation: badgePop 0.35s var(--ease-spring);
        }
        .kids-count-badge.visible { display: flex; }
        @keyframes badgePop { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }

        .btn-submit {
            width: 100%; padding: 18px 24px; background: linear-gradient(135deg, #EC5075 0%, #d93d64 100%);
            color: #FFFFFF; border: none; border-radius: 14px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1.5px; cursor: pointer; position: relative; overflow: hidden; margin-top: 0.75rem;
            transition: all 0.4s var(--ease-elite); box-shadow: 0 8px 30px rgba(236, 80, 117, 0.35), 0 2px 4px rgba(0, 0, 0, 0.2);
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
        }
        .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 12px 40px rgba(236, 80, 117, 0.45), 0 4px 8px rgba(0, 0, 0, 0.2); }
        .btn-submit:active { transform: translateY(-1px) scale(0.99); }
        .btn-submit::before {
            content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            opacity: 0; transition: opacity 0.3s ease;
        }
        .btn-submit:hover::before { opacity: 1; }
        .btn-submit::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            transform: skewX(-20deg) translateZ(0); animation: btnShimmer 4s ease-in-out infinite; will-change: transform;
        }
        @keyframes btnShimmer { 0% { transform: skewX(-20deg) translateX(0) translateZ(0); } 100% { transform: skewX(-20deg) translateX(500%) translateZ(0); } }

        .form-trust-strip { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid rgba(255, 255, 255, 0.08); }
        .trust-item { display: flex; align-items: center; gap: 6px; font-size: 0.68rem; font-weight: 600; color: rgba(255, 255, 255, 0.55); text-transform: uppercase; letter-spacing: 0.5px; }
        .trust-item svg { width: 15px; height: 15px; color: #10B981; }

        .social-proof-strip { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 1.5rem; flex-wrap: wrap; animation: proofFadeIn 1s var(--ease-elite) 0.8s forwards; opacity: 0; }
        @keyframes proofFadeIn { to { opacity: 1; } }
        .proof-item { display: flex; align-items: center; gap: 8px; }
        .proof-text { font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); }
        .proof-text strong { color: #fff; font-weight: 700; }
        .proof-rating { display: flex; align-items: center; gap: 6px; }
        .stars { color: #FBBF24; font-size: 0.85rem; }
        .rating-text { color: #fff; font-size: 0.85rem; font-weight: 700; }

        @media (max-width: 400px) { .form-trust-strip { gap: 0.6rem; } .trust-item { font-size: 0.6rem; } .social-proof-strip { gap: 1rem; } }

        .input-container.error { border-color: #EF4444; animation: shake 0.5s var(--ease-spring); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
        .error-msg { color: #EF4444; font-size: 0.7rem; font-weight: 600; margin-top: 6px; display: none; margin-left: 6px; text-align: left; animation: errorSlide 0.3s var(--ease-elite); }
        @keyframes errorSlide { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .error-msg.visible { display: block; }
        .form-success { text-align: center; padding: 2.5rem 0; animation: successReveal 0.6s var(--ease-elite); }
        @keyframes successReveal { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .success-icon {
            width: 72px; height: 72px; background: rgba(16, 185, 129, 0.12); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: #10B981;
            border: 2px solid rgba(16, 185, 129, 0.25); animation: iconPop 0.5s var(--ease-spring) 0.2s both;
        }
        @keyframes iconPop { from { transform: scale(0); } to { transform: scale(1); } }
        .form-success h3 { color: #fff; margin-bottom: 0.5rem; font-size: 1.4rem; }

        /* === SCROLL REVEAL === */
        .reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.8s var(--ease-elite), transform 0.8s var(--ease-elite); will-change: opacity, transform; }
        .reveal.active { opacity: 1; transform: translateY(0); }
        .reveal-delay-1 { transition-delay: 0.1s; }
        .reveal-delay-2 { transition-delay: 0.2s; }
        .reveal-delay-3 { transition-delay: 0.3s; }

        /* === SECTIONS === */
        #experiences { scroll-margin-top: 50px; }
        .sections-wrapper { background: #FFFFFF; position: relative; z-index: 20; }
        .section { content-visibility: auto; contain-intrinsic-size: 1000px; max-width: 1100px; margin: 0 auto; padding: 3.5rem 1.25rem; position: relative; z-index: 2; background: #fff; }
        @media (max-width: 768px) {
            .sections-wrapper { border-top-left-radius: 32px; border-top-right-radius: 32px; margin-top: -28px; box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.15); overflow: hidden; }
            .sections-wrapper::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 44px; height: 4px; background: rgba(0, 0, 0, 0.12); border-radius: 100px; margin-top: 14px; z-index: 5; }
        }
        @media (min-width: 769px) { .sections-wrapper { border-top-left-radius: 48px; border-top-right-radius: 48px; margin-top: -36px; box-shadow: 0 -16px 60px rgba(0, 0, 0, 0.12); } }
        @media (min-width: 768px) { .section { padding: 5rem 2rem; } }
        .section:first-of-type { padding-top: 2.5rem; }
        @media (min-width: 768px) { .section:first-of-type { padding-top: 4rem; } }

        .section-header { text-align: center; margin-bottom: 3rem; max-width: 700px; margin: 0 auto; }
        .section-header h2 { font-size: clamp(2rem, 4vw, 3.2rem); line-height: 1.15; margin-bottom: 1rem; font-weight: 800; letter-spacing: -0.02em; color: var(--text-dark); }
        .section-header p { font-size: 1.05rem; color: var(--text-body); max-width: 550px; margin: 0 auto 2.5rem auto; }

        .filters { display: flex; justify-content: center; gap: 0.6rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
        .filter-btn {
            padding: 0.85rem 1.8rem; border: 1px solid rgba(0,0,0,0.06); background: #fff; color: var(--text-body);
            border-radius: 100px; cursor: pointer; font-size: 0.75rem; font-weight: 700; transition: all 0.35s var(--ease-elite);
            text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .filter-btn:hover, .filter-btn.active { background: var(--text-dark); color: #fff; border-color: var(--text-dark); box-shadow: 0 8px 20px rgba(0,0,0,0.12); transform: translateY(-2px); }

        .spectacles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 2.5rem; }
        .spectacle-card {
            background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden;
            border: 1px solid rgba(0,0,0,0.04); transition: transform 0.5s var(--ease-elite), box-shadow 0.5s var(--ease-elite);
            display: flex; flex-direction: column; position: relative; box-shadow: var(--shadow-card); min-height: 480px; transform: translateZ(0);
        }
        .spectacle-card:hover { transform: translateY(-8px) translateZ(0); box-shadow: 0 25px 50px -15px rgba(0,0,0,0.1); }

        .card-image { width: 100%; height: 240px; overflow: hidden; position: relative; aspect-ratio: 4/3; background-color: #f0f0f0; cursor: pointer; z-index: 1; }
        .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s ease; will-change: transform; }
        .spectacle-card:hover .card-image img { transform: scale(1.05); }
        .card-image-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0);
            display:flex; align-items:center; justify-content:center; opacity:0; transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); backdrop-filter: blur(0px);
        }
        .card-image-overlay svg {
            transform: scale(0.8); opacity: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); z-index: 2;
        }
        .spectacle-card.teaser-active .card-image img { transform: scale(1.08); filter: brightness(0.8); transition: transform 2s ease, filter 0.8s ease; }
        .spectacle-card.teaser-active .card-image-overlay, .spectacle-card:hover .card-image-overlay { background: rgba(0,0,0,0.2); opacity: 1; }
        .spectacle-card.teaser-active .card-image-overlay svg, .spectacle-card:hover .card-image-overlay svg {
            opacity: 1; transform: scale(1.15); animation: pulse-ring 2s infinite; color: #fff; fill: rgba(255,255,255,0.2);
        }
        @keyframes pulse-ring {
            0% { transform: scale(1.15); filter: drop-shadow(0 0 0 rgba(255,255,255,0.7)); }
            50% { transform: scale(1.22); filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
            100% { transform: scale(1.15); filter: drop-shadow(0 0 0 rgba(255,255,255,0.7)); }
        }
        .spectacle-card.teaser-active .card-image-overlay::before {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px;
            border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            animation: rippleOut 2s infinite; z-index: 1; pointer-events: none;
        }
        .spectacle-card.teaser-active .card-image-overlay::after, .spectacle-card:hover .card-image-overlay::after {
            content: attr(data-cta); position: absolute; top: 65%; left: 50%; transform: translateX(-50%) translateY(10px);
            color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px;
            text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.5); opacity: 0; animation: slideUpFade 0.6s forwards 0.2s;
            background: transparent; padding: 0; border: none;
        }

        .spectacle-type-badge {
            position: absolute; top: 12px; left: 12px; background: #fff; color: var(--text-dark); padding: 7px 14px;
            border-radius: 50px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; z-index: 2;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .popular-badge {
            position: absolute; top: 12px; right: 12px; z-index: 2; width: 34px; height: 34px; background:var(--brand-raspberry);
            border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 16px rgba(236,80,117,0.45);
        }
        .popular-badge svg { width:16px; height:16px; stroke:white; }
        .media-badge {
            position: absolute; bottom: 12px; right: 12px; background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(10px);
            color: white; padding: 7px 14px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.15);
            pointer-events: none; animation: badgePulse 3s infinite ease-in-out;
        }
        .media-badge svg { width: 10px; height: 10px; fill: white; }
        .spectacle-card.teaser-active .media-badge { opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }

        .live-viewer-indicator {
            display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: #4B5563; font-weight: 600;
            background: rgba(243, 244, 246, 0.6); padding: 6px 10px; border-radius: 6px; width: fit-content;
            margin-bottom: 12px; margin-top: -4px; transform-origin: center left;
            transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); border: 1px solid transparent; will-change: transform, border-color;
        }
        .live-viewer-indicator.bump {
            transform: scale(1.02); background: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: rgba(236, 80, 117, 0.3);
        }
        .high-demand-indicator {
            display: inline-flex; align-items: center; gap: 5px; margin-left: 8px; color: #EC5075; font-weight: 800;
            font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; animation: pulseText 3s infinite ease-in-out;
        }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .live-pulse-dot {
            width: 6px; height: 6px; background-color: #10B981; border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); animation: greenPulse 3s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        .spectacle-card.sold-out { pointer-events: none; }
        .spectacle-card.sold-out .card-image img { filter: grayscale(100%) opacity(0.7); }
        .sold-out-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .sold-out-badge {
            background: #fff; color: #000; padding: 8px 16px; border-radius: 4px; font-weight: 800; text-transform: uppercase;
            font-size: 0.8rem; letter-spacing: 1px; transform: rotate(-5deg); box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .spectacle-card.sold-out .btn-book { background: #E5E7EB; color: #9CA3AF; box-shadow: none; cursor: not-allowed; }
        .spectacle-card.sold-out .btn-book::after { display: none; }

        .card-content { padding: 1.4rem; display: flex; flex-direction: column; background: #fff; gap: 0; }
        .card-title { font-size: 1.4rem; line-height: 1.1; margin-bottom: 0.3rem; color: var(--text-dark); }
        
        /* UPGRADED CARD RATING CSS */
        .card-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stars {
            color: #FBBF24;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .rating-score-box {
            background: #F3F4F6;
            color: var(--text-dark);
            font-size: 0.7rem;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .review-text-clean {
            color: #9CA3AF;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .card-description { margin-bottom: 1rem; color: var(--text-body); font-size: 0.9rem; line-height: 1.5; }
        .card-meta {
            display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-dark);
            font-weight: 700; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05);
        }
        .price-range {
            font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
            line-height: 1; color: var(--brand-raspberry); background: transparent; border: 1.5px solid var(--brand-raspberry);
            padding: 6px 12px; border-radius: 50px; display: inline-flex; align-items: center; gap: 5px; transition: all 0.3s var(--ease-elite); cursor: pointer;
        }
        .price-range:hover { background: var(--brand-raspberry); color: #fff; transform: translateY(-1px); }
        .price-range::before {
            content: ''; display: block; width: 10px; height: 10px; min-width: 10px; flex-shrink: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23EC5075' stroke='%23EC5075' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='white'%3E%3C/circle%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .price-range:hover::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='%23EC5075'%3E%3C/circle%3E%3C/svg%3E");
        }

        .card-actions-container { display: grid; grid-template-columns: 0.7fr 2fr; gap: 10px; margin-top: 0; }
        .card-btn {
            display: flex; align-items: center; justify-content: center; gap: 6px; padding: 14px; border-radius: 12px; font-weight: 800; cursor: pointer;
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; transition: all 0.3s var(--ease-elite); text-decoration: none; text-align: center; border: none; font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .btn-menu { background: #fff; color: var(--text-dark); border: 1.5px solid #E5E7EB; font-size: 0.7rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-menu svg { width: 14px; height: 14px; stroke: var(--text-muted); transition: stroke 0.3s ease; }
        .btn-menu:hover { border-color: #D1D5DB; background: #F9FAFB; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
        .btn-menu:hover svg { stroke: var(--brand-raspberry); }
        .btn-book { background: var(--brand-gradient); color: white; font-size: 0.85rem; letter-spacing: 1px; box-shadow: 0 6px 20px rgba(236, 80, 117, 0.25); position: relative; overflow: hidden; }
        .btn-book:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(236, 80, 117, 0.35); }
        .btn-book::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg); animation: btnShimmer 4s ease-in-out infinite;
        }

        .trust-micro-signal {
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.65rem; font-weight: 700; color: #9CA3AF;
            text-transform: uppercase; letter-spacing: 0.6px; margin-top: 14px; margin-bottom: 2px;
        }
        .trust-micro-signal svg { width: 13px; height: 13px; color: #10B981; fill: rgba(16, 185, 129, 0.1); stroke-width: 2.5px; }

        @keyframes rippleOut { 0% { width: 0px; height: 0px; opacity: 0.8; border-width: 4px; } 100% { width: 200px; height: 200px; opacity: 0; border-width: 0px; } }
        @keyframes slideUpFade { to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes greenPulse { to { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } }

        /* === SOCIAL PROOF & TESTIMONIALS === */
        .social-proof-wrapper { display: flex; flex-direction: column; text-align: center; gap: 2rem; }
        .proof-text-content h2 { font-size: clamp(2rem, 4.5vw, 2.8rem); line-height: 1.25; margin-bottom: 1rem; color: var(--text-dark); }
        .proof-text-content h2 .highlight-pink { font-style: italic; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .proof-text-content p { font-size: 1.1rem; color: var(--text-body); max-width: 550px; margin: 0 auto; }
        .authority-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.7rem; font-weight: 800; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 1rem; }
        .authority-badges-stack { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .authority-badge {
            border: 1px solid #E5E7EB; background: #FFFFFF; box-shadow: 0 5px 15px rgba(0,0,0,0.04);
            transition: transform 0.35s var(--ease-elite); display: flex; align-items: center; gap: 8px; padding: 8px 18px;
            border-radius: 50px; font-size: 0.75rem; font-weight: 700; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .authority-badge:hover { transform: translateY(-3px); }
        .authority-badge img { width: 20px; height: 20px; object-fit: contain; }
        .verified-check { color: #059669; margin-left: 4px; width: 14px; height: 14px; }
        @media (min-width: 768px) {
            .social-proof-wrapper { flex-direction: row; text-align: left; align-items: center; gap: 2.5rem; }
            .proof-text-content { flex: 1; }
            .proof-text-content p { margin: 0; }
            .proof-authority-content { flex-shrink: 0; padding-left: 2.5rem; border-left: 2px solid #F3F4F6; }
            .authority-badges-stack { align-items: flex-start; }
        }

        .testimonials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 3rem; }
        .testimonial-card-new {
            background: var(--bg-card); border-radius: 22px; overflow: hidden; box-shadow: var(--shadow-card);
            transition: transform 0.4s var(--ease-elite); border: 1px solid rgba(0,0,0,0.03); transform: translateZ(0);
        }
        .testimonial-card-new:hover { transform: translateY(-6px); }
        .testimonial-image-wrapper { width: 100%; height: 220px; position: relative; cursor: pointer; }
        .testimonial-image-wrapper img { width: 100%; height: 100%; object-fit: cover; object-position: center center; }
        .testimonial-content-new { padding: 2rem; }
        .testimonial-headline { font-size: 1.2rem; color: #d83669; margin-bottom: 0.8rem; font-family: 'Playfair Display'; font-weight: 800; }
        .testimonial-quote-new { font-style: italic; color: var(--text-body); border-left: 3px solid var(--brand-raspberry); padding-left: 1rem; margin: 1rem 0; font-size: 0.95rem; line-height: 1.6; background: rgba(0,0,0,0.01); padding: 1rem; border-radius: 0 12px 12px 0; }
        .testimonial-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .testimonial-tag { background: #F4F5F7; color: var(--text-muted); padding: 0.35rem 0.9rem; border-radius: 50px; font-size: 0.65rem; border: 1px solid rgba(0,0,0,0.05); font-weight: 700; text-transform: uppercase; }

        .story-badge-premium {
            position: absolute; top: 15px; left: 15px; background: rgba(255, 255, 255, 0.96); color: #111827; backdrop-filter: blur(10px);
            padding: 4px 10px; border-radius: 50px; font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; display: flex; align-items: center;
            gap: 6px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.8); pointer-events: none; opacity: 0; transform: translateY(10px); transition: opacity 0.5s var(--ease-elite), transform 0.5s var(--ease-elite);
        }
        .story-badge-premium.visible { opacity: 1; transform: translateY(0); }
        .story-badge-premium .play-circle { width: 20px; height: 20px; background: #111827; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .story-badge-premium .play-circle svg { width: 6px; height: 6px; fill: #FFF; margin-left: 2px; }

        /* === FAQ === */
        .accordion { max-width: 800px; margin: 0 auto; margin-top: 2rem; }
        .accordion-item {
            background: var(--bg-card); border-radius: 18px; margin-bottom: 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.4s var(--ease-elite); border: 1px solid rgba(0,0,0,0.03);
        }
        .accordion-item:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.06); }
        .accordion-header { padding: 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header h4 { font-size: 1.05rem; margin: 0; font-weight: 700; color: var(--text-dark); }
        .accordion-toggle { font-size: 1.5rem; color: var(--brand-raspberry); transition: transform 0.4s var(--ease-elite); }
        .accordion-item.open .accordion-toggle { transform: rotate(45deg); }
        .accordion-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: all 0.45s var(--ease-elite); }
        .accordion-item.open .accordion-content { padding-bottom: 1.5rem; max-height: 500px; }
        .accordion-content p { color: var(--text-body); padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); }

/* === V25 ULTIMATE STORY OVERLAY (EXACT SOURCE COPY) === */
.story-overlay {
    position: fixed; top: 0; left: 0; 
    width: 100%; height: 100%; height: 100dvh;
    background: #000; z-index: 9999; 
    display: none; align-items: center; justify-content: center;
    opacity: 0; 
    transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
    will-change: opacity;
    transform: translateZ(0);
}
.story-overlay.show { 
    display: flex; 
    opacity: 1; 
}

.story-container { 
    width: 100%; height: 100%; height: 100dvh; 
    position: relative; overflow: hidden; background: #000; 
    backface-visibility: hidden;
    -webkit-font-smoothing: antialiased;
}

@media(min-width: 768px) {
    .story-container { 
        width: 450px; height: 90vh; 
        border-radius: 20px; 
        box-shadow: 0 0 50px rgba(0,0,0,0.8); 
        transform: translateZ(0); 
        -webkit-mask-image: -webkit-radial-gradient(white, black);
        mask-image: radial-gradient(white, black);
    }
}

.story-media-wrapper { 
    width: 100%; height: 100%; 
    position: relative; background: #000; z-index: 1; 
    overflow: hidden;
}

.story-media-item { 
    width: 100%; height: 100%; 
    object-fit: cover; object-position: center center;
    position: absolute; top: 0; left: 0; 
    opacity: 0; 
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: opacity;
}

.story-media-item.active { 
    opacity: 1; z-index: 1; 
}

.story-media-item img {
    width: 100%; height: 100%; 
    object-fit: cover; object-position: center center;
    display: block;
}

.story-media-item iframe {
    width: 100%; height: 100%; 
    border: none; display: block;
}

/* UI LAYER */
.story-ui-top {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 15px 15px 30px 15px; 
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
    z-index: 300; pointer-events: none; 
}

.story-progress-bar { 
    display: flex; gap: 4px; height: 2px; 
    margin-bottom: 12px; pointer-events: auto; 
    transform: translateZ(0);
}
.progress-segment { 
    flex: 1; background: rgba(255,255,255,0.3); 
    border-radius: 2px; overflow: hidden; height: 2px; 
}
.progress-fill { 
    width: 100%; height: 100%; 
    background: #fff; 
    transform-origin: left; 
    transform: scaleX(0); 
    will-change: transform;
}

.story-controls-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }

.story-brand { 
    color: #fff; font-size: 0.8rem; font-weight: 700; 
    opacity: 0.95; text-transform: uppercase; letter-spacing: 1px; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
}

.story-actions { display: flex; gap: 10px; align-items: center; pointer-events: auto; }

.story-icon { 
    width: 32px; height: 32px; 
    display: flex; align-items: center; justify-content: center; 
    color: #fff; cursor: pointer; 
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); 
    opacity: 0.95; transition: transform 0.2s; 
}
.story-icon svg { width: 24px; height: 24px; stroke-width: 2px; }
.story-icon:hover { transform: scale(1.1); }

.story-nav-zone { position: absolute; top: 0; bottom: 0; z-index: 40; height: 100%; }
.nav-left { left: 0; width: 30%; }
.nav-right { right: 0; width: 30%; }
.nav-center { left: 30%; width: 40%; } 

.story-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 90px 20px 36px; z-index: 50;
    background: linear-gradient(to top, rgba(0,0,0,0.92) 12%, rgba(0,0,0,0.55) 48%, transparent 100%);
    text-align: center; display: flex; flex-direction: column; align-items: center;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change: transform, opacity;
}

.story-footer.hidden { transform: translateY(50px); opacity: 0; }

.story-title-text { 
    color: #fff; font-family: 'Playfair Display'; font-size: 1.4rem; 
    margin-bottom: 10px; font-weight: 700; 
    text-shadow: 0 2px 12px rgba(0,0,0,0.85), 0 1px 3px rgba(0,0,0,0.5); 
    letter-spacing: -0.02em;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s;
}
.story-footer:not(.hidden) .story-title-text { opacity: 1; transform: translateY(0); }

.story-desc-text { 
    color: rgba(255,255,255,0.96); font-size: 0.8rem; 
    margin-bottom: 24px; font-weight: 500; 
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
    text-shadow: 0 2px 8px rgba(0,0,0,0.75), 0 1px 2px rgba(0,0,0,0.4); 
    max-width: 90%; line-height: 1.5; 
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s;
}
.story-footer:not(.hidden) .story-desc-text { opacity: 1; transform: translateY(0); }

.story-cta-btn { 
    background: #fff; color: #000; border: none; font-weight: 800; 
    padding: 13px 32px; border-radius: 50px; width: 100%; max-width: 300px; 
    font-size: 0.85rem; cursor: pointer; 
    box-shadow: 0 6px 28px rgba(255,255,255,0.18), 0 2px 8px rgba(0,0,0,0.1); 
    text-transform: uppercase; letter-spacing: 1.5px; 
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), 
                box-shadow 0.3s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s;
    opacity: 0;
    transform: translateY(8px) scale(0.98);
}
.story-footer:not(.hidden) .story-cta-btn { opacity: 1; transform: translateY(0) scale(1); }
.story-cta-btn:hover { transform: translateY(-1px) scale(1.01); box-shadow: 0 8px 32px rgba(255,255,255,0.22), 0 4px 12px rgba(0,0,0,0.12); }
.story-cta-btn:active { transform: translateY(0) scale(0.99); }

.story-trust { 
    color: #fff; font-size: 0.75rem; margin-top: 18px; 
    opacity: 0; display: flex; align-items: center; justify-content: center; 
    gap: 6px; font-weight: 600; 
    text-shadow: 0 2px 6px rgba(0,0,0,0.7), 0 1px 2px rgba(0,0,0,0.4); 
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.4s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.4s;
    transform: translateY(6px);
}
.story-footer:not(.hidden) .story-trust { opacity: 0.92; transform: translateY(0); }

/* === CLIMAX CARD (WORLD CLASS PREMIUM ANIMATION) === */
.climax-phantom-layer { 
    position: absolute; inset: 0; width: 100%; height: 100%; 
    background-size: cover; background-position: center center; 
    background-repeat: no-repeat; z-index: 0; 
    transform: scale(1.0); will-change: transform; 
    transition: transform 14s cubic-bezier(0.19, 1, 0.22, 1);
}
@media (max-width: 768px) {
    .climax-phantom-layer { background-size: cover !important; background-position: center center !important; }
}
.story-climax-card { 
    position: absolute; top:0; left:0; width:100%; height:100%; 
    z-index: 100; pointer-events: none; display: flex; flex-direction: column; 
    justify-content: flex-end; padding-bottom: 72px; background: transparent; 
    opacity: 0; transition: opacity 1.4s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; 
}
.story-climax-card.active { opacity: 1; pointer-events: auto; }

/* PREMIUM: Smooth zoom and pull UP to reveal people at the bottom */
.story-climax-card.active ~ .climax-phantom-layer, .story-climax-card.active .climax-phantom-layer { 
    transform: scale(1.12) translateY(-8%); 
    transition: transform 22s cubic-bezier(0.19, 1, 0.22, 1); 
}

.climax-gradient-overlay { 
    position: absolute; inset: 0; width: 100%; height: 100%; 
    background: linear-gradient(to top, rgba(0,0,0,0.96) 0%, rgba(0,0,0,0.72) 38%, rgba(0,0,0,0.12) 78%, transparent 100%); 
    z-index: 1; pointer-events: none; 
    transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
}
.climax-content { 
    position: relative; z-index: 2; text-align: center; 
    padding: 0 1.5rem; display: flex; flex-direction: column; align-items: center; 
}
.climax-title { 
    color: #fff; font-family: 'Playfair Display'; 
    font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom: 0.5rem; 
    text-shadow: 0 4px 32px rgba(0,0,0,0.95), 0 2px 8px rgba(0,0,0,0.6); 
    opacity: 0; transform: translateY(24px); 
    transition: opacity 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.15s, 
                transform 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.15s;
    letter-spacing: -0.02em; font-weight: 700;
}
.climax-badge { 
    display: inline-flex; align-items: center; gap: 7px; 
    background: rgba(255,255,255,0.16); backdrop-filter: blur(12px); 
    border: 1px solid rgba(255,255,255,0.24); padding: 7px 16px; 
    border-radius: 50px; margin-bottom: 1.4rem; 
    opacity: 0; transform: translateY(18px) scale(0.96); 
    transition: opacity 0.85s cubic-bezier(0.16, 1, 0.3, 1) 0.35s, 
                transform 0.85s cubic-bezier(0.16, 1, 0.3, 1) 0.35s; 
    box-shadow: 0 8px 36px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
}
.climax-stars { display: flex; gap: 3px; }
.climax-stars svg { width: 13px; height: 13px; fill: #FFD700; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); opacity: 1; transform: scale(1); animation: none; }
.climax-badge-text { color: white; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; }

.climax-desc { 
    color: rgba(255,255,255,0.97); font-size: 0.9rem; margin-bottom: 2rem; 
    line-height: 1.55; font-weight: 500; 
    text-shadow: 0 2px 22px rgba(0,0,0,1), 0 1px 4px rgba(0,0,0,0.5); 
    max-width: 90%; opacity: 0; transform: translateY(20px); 
    transition: opacity 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.55s, 
                transform 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.55s; 
}
.climax-cta { 
    background: #fff; color: #000; width: 100%; padding: 1.3rem; 
    border-radius: 50px; font-weight: 800; font-size: 0.95rem; border: none; 
    box-shadow: 0 0 24px rgba(255,255,255,0.32), 0 4px 12px rgba(0,0,0,0.15); 
    cursor: pointer; text-transform: uppercase; letter-spacing: 1.2px; 
    transform: scale(0.92) translateY(8px); opacity: 0; 
    transition: opacity 0.75s cubic-bezier(0.16, 1, 0.3, 1) 0.75s, 
                transform 0.75s cubic-bezier(0.16, 1, 0.3, 1) 0.75s,
                box-shadow 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.climax-cta:hover { 
    transform: scale(1.01) translateY(-1px); 
    box-shadow: 0 0 32px rgba(255,255,255,0.4), 0 6px 16px rgba(0,0,0,0.18);
}
.climax-cta:active { transform: scale(0.99) translateY(0); }

.story-climax-card.active .climax-title { opacity: 1; transform: translateY(0); }
.story-climax-card.active .climax-badge { opacity: 1; transform: translateY(0) scale(1); }
.story-climax-card.active .climax-desc { opacity: 1; transform: translateY(0); }
.story-climax-card.active .climax-cta { opacity: 1; transform: scale(1) translateY(0); }

.story-climax-card .story-trust {
    margin-top: 22px;
    opacity: 0; transform: translateY(12px);
    transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s, 
                transform 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s;
}
.story-climax-card.active .story-trust { opacity: 0.94; transform: translateY(0); }

/* === ELITE MENU MODAL V18 (ULTRA-RELIABLE MOBILE-FIRST) === */
.menu-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    height: 100dvh; /* Dynamic viewport height for mobile */
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    will-change: opacity;
    /* Prevent iOS overscroll */
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
}
.menu-modal-overlay.active { opacity: 1; }

.menu-modal-content { 
    background: #fff; 
    width: 94%; 
    max-width: 800px; 
    height: 88vh;
    height: 88dvh; /* Dynamic viewport height */
    max-height: 900px;
    border-radius: 24px; 
    overflow: hidden; 
    position: relative; 
    transform: scale(0.95) translateY(10px); 
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 25px 60px -12px rgba(0,0,0,0.5); 
    will-change: transform; 
    backface-visibility: hidden; 
    -webkit-backface-visibility: hidden;
    contain: layout paint style; 
}
.menu-modal-overlay.active .menu-modal-content { 
    transform: scale(1) translateY(0); 
}

.menu-header { 
    padding: 16px 20px; 
    border-bottom: 1px solid #eee; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #FAFAFA; 
    flex-shrink: 0;
    min-height: 56px;
}
.menu-header h3 { 
    font-size: 1.1rem; 
    margin: 0; 
    color: var(--text-dark); 
    font-weight: 700;
}
.close-menu { 
    cursor: pointer; 
    font-size: 1.8rem; 
    line-height: 1; 
    color: #666; 
    padding: 8px; 
    margin: -8px;
    border-radius: 50%;
    transition: background 0.2s ease, color 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}
.close-menu:hover,
.close-menu:active {
    background: rgba(0,0,0,0.05);
    color: #333;
}

/* === SCROLLING CONTAINER (CRITICAL FOR MOBILE) === */
.menu-iframe-container {
    flex: 1 1 auto;
    position: relative;
    width: 100%;
    min-height: 0; /* Important for flexbox */
    overflow: hidden; /* Changed from overflow-y: auto */
    background: #e8e8e8; 
    z-index: 10;
    /* iOS smooth scrolling */
    -webkit-overflow-scrolling: touch;
}

.menu-iframe-container iframe {
    /* Allow both horizontal and vertical pan for PDF zoom */
    touch-action: pan-x pan-y pinch-zoom; 
    /* Ensure iframe fills container */
    display: block;
}

/* === MENU SPINNER (Unique, no conflicts) === */
.menu-spinner { 
    width: 44px; 
    height: 44px; 
    border: 3px solid rgba(236, 80, 117, 0.15); 
    border-radius: 50%; 
    border-top: 3px solid var(--brand-raspberry); 
    animation: menuSpin 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; 
    margin-bottom: 18px; 
}

@keyframes menuSpin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
}

.loading-text {
    font-size: 0.85rem; 
    font-weight: 700; 
    color: #666;
    text-transform: uppercase; 
    letter-spacing: 1px;
    animation: pulseMenuText 1.5s infinite ease-in-out;
}

@keyframes pulseMenuText { 
    0%, 100% { opacity: 0.6; } 
    50% { opacity: 1; } 
}

/* === MOBILE SPECIFIC OVERRIDES === */
@media (max-width: 768px) {
    .menu-modal-content {
        width: 100%;
        height: 100%;
        height: 100dvh;
        max-height: none;
        border-radius: 0;
    }
    
    .menu-header {
        padding: 14px 16px;
        /* Safe area for notched phones */
        padding-top: max(14px, env(safe-area-inset-top));
    }
    
    .menu-iframe-container {
        /* Account for safe areas on notched phones */
        padding-bottom: env(safe-area-inset-bottom, 0);
    }
    
    .close-menu {
        font-size: 2rem;
        padding: 10px;
    }
}

        /* === PROCESSING OVERLAY === */
        .processing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 2147483647; display: none; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.98); opacity: 0; pointer-events: auto; transition: opacity 0.5s var(--ease-elite); transform: translate3d(0,0,0);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); will-change: opacity;
        }
        .processing-overlay.active { opacity: 1; }
        .processing-content {
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;
            max-width: 100%; max-height: 100%; padding: 2rem; text-align: center;
        }
        .processing-bg { position: absolute; inset: 0; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%); overflow: hidden; z-index: 0; opacity: 0.95; }
        .processing-bg::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(236, 80, 117, 0.08) 0%, transparent 50%);
            transform: translate(-50%, -50%); animation: bgPulse 4s ease-in-out infinite;
        }
        @keyframes bgPulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } }
        .particles { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(236, 80, 117, 0.3); border-radius: 50%; animation: float 8s infinite; }
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 1s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 3s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 6s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 7s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 0.5s; }
        @keyframes float { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh) scale(1); opacity: 0; } }
        .processing-main { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .elite-pulse-container { position: relative; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 3rem; }
        .elite-brand-icon {
            position: relative; z-index: 10; width: 80px; height: 80px; background: linear-gradient(135deg, #EC5075 0%, #C2185B 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 60px rgba(236, 80, 117, 0.5);
            animation: iconPulse 2s ease-in-out infinite;
        }
        @keyframes iconPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(236, 80, 117, 0.5); } 50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(236, 80, 117, 0.7); } }
        .elite-pulse-ring { position: absolute; border-radius: 50%; border: 2px solid var(--brand-raspberry); opacity: 0; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; }
        .ring-1 { animation: eliteRipple 3s infinite; }
        .ring-2 { animation: eliteRipple 3s infinite 1s; }
        .ring-3 { animation: eliteRipple 3s infinite 2s; }
        @keyframes eliteRipple { 0% { width: 80px; height: 80px; opacity: 0.6; } 100% { width: 300px; height: 300px; opacity: 0; } }
        .processing-headline { font-family: 'Playfair Display', serif; font-size: 2rem; color: #fff; margin-bottom: 0.75rem; font-weight: 700; opacity: 0; animation: textFadeIn 0.8s var(--ease-elite) 0.3s forwards; }
        .processing-subtext { font-size: 1rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 2.5rem; max-width: 280px; line-height: 1.5; opacity: 0; animation: textFadeIn 0.8s var(--ease-elite) 0.5s forwards; }
        @keyframes textFadeIn { to { opacity: 1; } }
        .status-steps { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; margin-bottom: 3rem; }
        .status-step {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 12px; opacity: 0; transform: translateX(-20px);
        }
        .status-step.active { animation: stepIn 0.5s var(--ease-elite) forwards; border-color: rgba(236, 80, 117, 0.3); background: rgba(236, 80, 117, 0.05); }
        .status-step.completed { border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }
        @keyframes stepIn { to { opacity: 1; transform: translateX(0); } }
        .step-icon {
            width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.1); flex-shrink: 0;
        }
        .status-step.active .step-icon { background: var(--brand-raspberry); animation: iconSpin 1.5s linear infinite; }
        .status-step.completed .step-icon { background: #10B981; animation: none; }
        @keyframes iconSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .step-icon svg { width: 14px; height: 14px; stroke: #fff; }
        .step-text { font-size: 0.85rem; font-weight: 600; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px; }
        .status-step.active .step-text, .status-step.completed .step-text { color: #fff; }
        .elite-progress-container { width: 100%; max-width: 300px; opacity: 0; animation: textFadeIn 0.8s var(--ease-elite) 0.7s forwards; }
        .elite-progress-bar { height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 100px; overflow: hidden; }
        .elite-progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand-raspberry), #ff9bab); border-radius: 100px; width: 0%; transition: width 0.3s var(--ease-elite); }

        /* === WHATSAPP STICKY === */
        .wa-sticky-container {
            position: fixed; bottom: calc(30px + var(--safe-area-bottom)); left: 50%; transform: translateX(-50%) translateY(150%) scale(0.95); opacity: 0;
            pointer-events: none; z-index: 9995; display: flex; align-items: center; gap: 15px; background: rgba(8, 8, 10, 0.88); backdrop-filter: blur(20px);
            padding: 14px 26px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.4); text-decoration: none;
            min-width: 300px; max-width: 90%; transition: transform 0.6s var(--ease-elite), opacity 0.5s var(--ease-elite);
        }
        .wa-sticky-container.visible { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        .wa-sticky-container.ducked { transform: translateX(-50%) translateY(150%) scale(0.95); opacity: 0; pointer-events: none; }
        .wa-icon { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; position: relative; }
        .wa-status-dot { position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; background: #25D366; border: 2px solid #1f2937; border-radius: 50%; animation: waPulse 2s infinite; }
        @keyframes waPulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }
        .wa-text-col { display: flex; flex-direction: column; text-align: left; }
        .wa-title { color: #FFFFFF; font-weight: 800; font-size: 0.85rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .wa-subtext { color: #9CA3AF; font-size: 0.75rem; font-weight: 500; }
        .wa-highlight { color: #4ade80; font-weight: 700; }
        @media (min-width: 769px) { .wa-sticky-container { display: none !important; } }

        /* Footer */
        footer {
            border-top: 1px solid rgba(0,0,0,0.05); text-align: center; padding: 4rem 2rem calc(2rem + var(--safe-area-bottom));
            font-size: 0.875rem; color: var(--text-muted); background: #fff; position: relative; z-index: 2;
        }
        footer a { color: var(--brand-raspberry); text-decoration: none; }

        /* === MAPBOX MODAL === */
        #mapbox-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 10000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.4s ease; transform: translate3d(0,0,0);
        }
        #mapbox-modal.active { display: flex; opacity: 1; }
        .map-wrapper {
            position: relative; width: 100vw; height: 100dvh; max-width: 100%; background: #0B0F1A; border-radius: 0; overflow: hidden;
            transform: translateY(30px); transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #mapbox-modal.active .map-wrapper { transform: translateY(0); }
        #map-canvas { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; background: #111; }
        .map-close {
            position: absolute; top: calc(20px + var(--safe-area-top)); right: 24px; z-index: 30; width: 48px; height: 48px;
            background: rgba(20,20,20,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease;
        }
        .map-close:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .map-close svg { stroke: #fff; }
        .concierge-panel {
            position: absolute; bottom: calc(30px + var(--safe-area-bottom)); left: 50%; transform: translateX(-50%); width: calc(100% - 40px);
            max-width: 420px; z-index: 30; background: rgba(20, 20, 20, 0.85); padding: 20px; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 12px; backdrop-filter: blur(20px);
        }
        .concierge-header { display: flex; align-items: center; gap: 15px; }
        .concierge-avatar-wrapper { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
        .concierge-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); }
        .status-dot-live {
            position: absolute; bottom: 1px; right: 1px; width: 12px; height: 12px; background: var(--wa-green); border: 2px solid #222; border-radius: 50%;
            animation: pulseLive 2s infinite;
        }
        .concierge-info h4 { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: #fff; margin: 0; }
        .concierge-info p { font-size: 0.65rem; color: rgba(255,255,255,0.6); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
        .venue-address-block { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.05); }
        .venue-address-block h5 { font-size: 0.8rem; color: #fff; margin-bottom: 2px; font-weight: 800; }
        .venue-address-block p { font-size: 0.75rem; color: rgba(255,255,255,0.7); line-height: 1.4; font-weight: 600; margin: 0; }
        .btn-wa-full {
            background: var(--wa-green); color: #fff; padding: 14px; border-radius: 100px; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-decoration: none; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.25); transition: transform 0.2s;
        }
        .btn-wa-full:active { transform: scale(0.97); }
        .venue-marker { width: 30px; height: 30px; background: #EC5075; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 20px rgba(236, 80, 117, 0.4); }
        @keyframes pulseLive { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }

        /* === VIDEO PRELOAD CONTAINER === */
        #video-preload-container {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
            visibility: hidden;
        }

    </style>
</head>
<body>

    <!-- PROCESSING OVERLAY -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-bg">
                <div class="particles">
                    <div class="particle"></div><div class="particle"></div><div class="particle"></div>
                    <div class="particle"></div><div class="particle"></div><div class="particle"></div>
                    <div class="particle"></div><div class="particle"></div><div class="particle"></div>
                </div>
            </div>
            <div class="processing-main">
                <div class="elite-pulse-container">
                    <div class="elite-pulse-ring ring-1"></div>
                    <div class="elite-pulse-ring ring-2"></div>
                    <div class="elite-pulse-ring ring-3"></div>
                    <div class="elite-brand-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                </div>
                <h2 class="processing-headline" id="processingHeadline">Sécurisation...</h2>
                <p class="processing-subtext" id="processingSubtext">Nous préparons votre expérience VIP</p>

                <div class="status-steps" id="statusSteps">
                    <div class="status-step" id="step1">
                        <div class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
                        <span class="step-text">Connexion Concierge</span>
                    </div>
                    <div class="status-step" id="step2">
                        <div class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="step-text">Vérification Disponibilité</span>
                    </div>
                    <div class="status-step" id="step3">
                        <div class="step-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg></div>
                        <span class="step-text">Confirmation VIP</span>
                    </div>
                </div>

                <div class="elite-progress-container">
                    <div class="elite-progress-bar"><div class="elite-progress-fill" id="progressFill"></div></div>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-container">
            <a href="#" class="logo-wordmark" aria-label="Marrakech Top Spot">
                <span class="logo-marrakech">Marrakech</span>
                <span class="logo-topspot">Top Spot</span>
            </a>
        </div>
    </header>

    <main>
        <section class="hero" id="heroSection">
            <div class="hero-video-bg" id="heroVideoBg">
                <img class="hero-slideshow-img" src="https://MTSZone.b-cdn.net/BG/3.png" alt="Hero Background" fetchpriority="high">
                <img class="hero-slideshow-img" src="https://MTSZone.b-cdn.net/BG/4.png" alt="Hero Background" fetchpriority="high">
                <img class="hero-slideshow-img" src="https://MTSZone.b-cdn.net/BG/6.png" alt="Hero Background" fetchpriority="high">
                <img class="hero-slideshow-img" src="https://MTSZone.b-cdn.net/BG/7.png" alt="Hero Background" fetchpriority="high">
            </div>

            <div class="hero-content">
                <div class="urgency-pill">
                    <span class="pulse-dot"></span>
                    <span class="urgency-text" id="urgencyText">7 Tables VIP disponibles ce soir</span>
                </div>

                <h1 class="hero-title-stack">
                    <span class="title-line-1">Votre Table VIP dans les</span>
                    <span class="title-line-2 shimmer-text" id="heroTitleLine2">Restaurants Festifs</span>
                    <span class="title-line-3">de Marrakech</span>
                </h1>

                <p class="hero-subtitle">Accédez aux <strong>7 meilleures adresses</strong> sans acompte. Confirmation en 60 secondes.</p>

                <div class="hero-form-container" id="heroFormContainer">
                    <div class="form-trust-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span class="form-trust-text" id="trustText">Réservation Gratuite & Sans Engagement</span>
                    </div>

                    <form id="heroForm" autocomplete="on" novalidate>
                        <input type="hidden" id="userID" name="userID" value="">
                        <div class="form-group">
                            <label for="fullname">Nom Complet</label>
                            <div class="input-container" id="container-fullname">
                                <input type="text" id="fullname" name="name" placeholder="Votre nom et prénom" autocomplete="name" required>
                            </div>
                            <div class="error-msg" id="error-fullname">Veuillez entrer votre nom</div>
                        </div>

                        <div class="form-group">
                            <label for="restaurant">Choisir l'atmosphère</label>
                            <div class="input-container" id="container-restaurant">
                                <select id="restaurant" name="restaurant" required>
                                    <option value="">Sélectionner une adresse...</option>
                                </select>
                            </div>
                            <div class="error-msg" id="error-restaurant">Choisissez un restaurant</div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="date">Date</label>
                                <div class="input-container" id="container-date">
                                    <input type="date" id="date" name="date" required>
                                </div>
                                <div class="error-msg" id="error-date">Date requise</div>
                            </div>
                            <div class="form-group">
                                <label for="guests">Invités</label>
                                <div class="input-container">
                                    <select id="guests" name="guests" required inputmode="numeric">
                                        <option value="" disabled selected>Combien?</option>
                                        <option value="2">2 personnes</option>
                                        <option value="3">3 personnes</option>
                                        <option value="4">4 personnes</option>
                                        <option value="5">5 personnes</option>
                                        <option value="6">6 personnes</option>
                                        <option value="7">7+ personnes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="kids-toggle-wrapper" id="kidsToggleWrapper">
                            <div class="kids-toggle-container" id="kidsToggleContainer">
                                <div class="kids-toggle-header">
                                    <div class="kids-toggle-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"></circle><path d="M12 6v4"></path><path d="M8 14l4-4 4 4"></path><path d="M8 14v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-4"></path></svg>
                                    </div>
                                    <div class="kids-toggle-text">
                                        <span class="toggle-title">Avec enfants ?</span>
                                        <span class="toggle-subtitle">Optionnel - Cliquez pour ajouter</span>
                                    </div>
                                    <span class="kids-count-badge" id="kidsCountBadge">0</span>
                                </div>
                                <div class="toggle-indicator">
                                    <span class="toggle-indicator-text" id="toggleIndicatorText">Ajouter</span>
                                    <svg class="toggle-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </div>
                            </div>
                            <div class="kids-selection-panel" id="kidsSelectionPanel">
                                <div class="kids-counter" id="kidsCounter">
                                    <button type="button" class="kids-counter-btn" id="kidsDecrease" disabled><span>−</span></button>
                                    <div class="kids-counter-display">
                                        <div class="kids-counter-value" id="kidsValue">1</div>
                                        <div class="kids-counter-label">enfant(s)</div>
                                    </div>
                                    <button type="button" class="kids-counter-btn" id="kidsIncrease"><span>+</span></button>
                                </div>
                            </div>
                            <input type="hidden" id="kidsCount" name="enfants" value="0">
                        </div>

                        <div class="form-group">
                            <label for="phone">WhatsApp (Confirmation)</label>
                            <div class="input-container" id="container-phone">
                                <div class="elite-phone-group">
                                    <div class="country-selector" id="countrySelector" onclick="toggleCountryDropdown(event)">
                                        <span class="selected-flag" id="selectedFlag">🇫🇷</span>
                                        <!-- Code input now handles its own focus, everything else toggles dropdown -->
                                        <input type="text" id="countryCode" name="countryCode" value="+33" class="code-input" inputmode="tel" maxlength="5" oninput="handleCodeInput(this)" onclick="event.stopPropagation()">
                                        <div class="selector-arrow-container">
                                            <svg class="selector-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                        </div>
                                    </div>
                                    
                                    <div class="country-dropdown" id="countryDropdown">
                                        <div class="dropdown-item" onclick="selectCountry('🇫🇷', '+33')"><span class="flag">🇫🇷</span> <span class="c-name">France</span> <span class="c-code">+33</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇲🇦', '+212')"><span class="flag">🇲🇦</span> <span class="c-name">Maroc</span> <span class="c-code">+212</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇬🇧', '+44')"><span class="flag">🇬🇧</span> <span class="c-name">UK</span> <span class="c-code">+44</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇧🇪', '+32')"><span class="flag">🇧🇪</span> <span class="c-name">Belgique</span> <span class="c-code">+32</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇨🇭', '+41')"><span class="flag">🇨🇭</span> <span class="c-name">Suisse</span> <span class="c-code">+41</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇺🇸', '+1')"><span class="flag">🇺🇸</span> <span class="c-name">USA</span> <span class="c-code">+1</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇪🇸', '+34')"><span class="flag">🇪🇸</span> <span class="c-name">Espagne</span> <span class="c-code">+34</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇩🇪', '+49')"><span class="flag">🇩🇪</span> <span class="c-name">Allemagne</span> <span class="c-code">+49</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇮🇹', '+39')"><span class="flag">🇮🇹</span> <span class="c-name">Italie</span> <span class="c-code">+39</span></div>
                                        <div class="dropdown-item" onclick="selectCountry('🇦🇪', '+971')"><span class="flag">🇦🇪</span> <span class="c-name">UAE</span> <span class="c-code">+971</span></div>
                                        <div class="dropdown-item custom-option" onclick="selectCountry('🌐', '')"><span class="flag">🌐</span> <span class="c-name">Autre (Saisie)</span></div>
                                    </div>

                                    <input type="tel" id="phone" name="phone" placeholder="6 12 34 56 78" autocomplete="tel" inputmode="tel" required>
                                </div>
                            </div>
                            <div class="error-msg" id="error-phone">Numéro invalide</div>
                        </div>

                        <button type="submit" class="btn-submit" id="submitBtn">Réserver ma table gratuitement</button>

                        <div class="form-trust-strip">
                            <div class="trust-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> 0 EUR requis</div>
                            <div class="trust-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Confirmation 60s</div>
                            <div class="trust-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> Support WhatsApp</div>
                        </div>
                    </form>
                </div>

                <div class="social-proof-strip">
                    <div class="proof-item"><span class="proof-text"><strong id="counter-tables">1 200+</strong> tables réservées</span></div>
                    <div class="proof-item proof-rating"><span class="stars">&#9733;&#9733;&#9733;&#9733;&#9733;</span><span class="rating-text">4.9/5 Google</span></div>
                </div>
            </div>
        </section>

        <div class="sections-wrapper">
            <section class="section reveal" id="experiences">
                <div class="section-header">
                    <h2 id="experiences-title">7 Spectacles Uniques.<br>Quelle magie choisirez-vous ce soir ?</h2>
                    <p id="experiences-subtitle">Oubliez les adresses de masse. Voici les 7 scènes confidentielles où Marrakech bat réellement son plein ce soir.</p>
                </div>
                <div id="explore-anchor"></div>
                <div class="filters">
                    <button class="filter-btn active" onclick="filterExperiences('all', this)">Toutes les adresses</button>
                    <button class="filter-btn" onclick="filterExperiences('grand-spectacle', this)">Grands Spectacles & Cabaret</button>
                    <button class="filter-btn" onclick="filterExperiences('authentic', this)">Charme & Traditions</button>
                    <button class="filter-btn" onclick="filterExperiences('party', this)">Festif & Rooftop</button>
                </div>
                <div class="spectacles-grid" id="spectaclesGrid"></div>
            </section>

            <section class="section reveal" id="testimonialsSection">
                <div class="section-header" style="margin-bottom: 3.5rem; max-width: 900px;">
                    <div class="social-proof-wrapper">
                        <div class="proof-text-content">
                            <h2>L'Excellence <span class="highlight-pink">Reconnue</span>.<br>L'Expérience que l'on vous envie.</h2>
                            <p>Nos invités ne partagent pas un simple dîner. Ils racontent l'histoire d'une soirée mémorable au cœur battant de Marrakech.</p>
                        </div>
                        <div class="proof-authority-content">
                            <h4 class="authority-title">VALIDÉ PAR</h4>
                            <div class="authority-badges-stack">
                                <div class="authority-badge"><img src="https://MTSZone.b-cdn.net/Malak/icons8-tripadvisor-50.png" alt="TripAdvisor Icon"><span>Avis Vérifiés</span><svg class="verified-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                                <div class="authority-badge"><img src="https://MTSZone.b-cdn.net/Malak/icons8-google-50.png" alt="Google Icon"><span>4.9/5 Excellent</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="testimonials-grid">
                    <div class="testimonial-card-new reveal reveal-delay-1" data-id="ibrahim">
                        <div class="testimonial-image-wrapper" onclick="StoryManager.open('ibrahim')">
                            <img loading="lazy" src="https://MTSZone.b-cdn.net/Malak/ReviewPacha12%20(1)%20(1).png" alt="Ibrahim Pacha Review">
                            <div class="story-badge-premium">Voir la Story<div class="play-circle"><svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg></div></div>
                        </div>
                        <div class="testimonial-content-new">
                            <h3 class="card-title">Ibrahim Pacha</h3>
                            <h4 class="testimonial-headline">"Une soirée au-delà de nos attentes."</h4>
                            <p class="testimonial-quote-new">Le personnel était incroyable. Tout était parfait - la nourriture, l'ambiance, et surtout le spectacle de plus de 3 heures qui était captivant.</p>
                            <div class="testimonial-tags"><span class="testimonial-tag">Show 3H+</span><span class="testimonial-tag">Service VIP</span></div>
                        </div>
                    </div>
                    <div class="testimonial-card-new reveal reveal-delay-2" data-id="folk">
                        <div class="testimonial-image-wrapper" onclick="StoryManager.open('folk')">
                            <img loading="lazy" src="https://MTSZone.b-cdn.net/Malak/FOLK-MARRAKECH_11%20(2).webp" alt="Folk Marrakech Review">
                            <div class="story-badge-premium">Voir la Story<div class="play-circle"><svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg></div></div>
                        </div>
                        <div class="testimonial-content-new">
                            <h3 class="card-title">Folk Marrakech</h3>
                            <h4 class="testimonial-headline">"Le moment le plus authentique du séjour."</h4>
                            <p class="testimonial-quote-new">Nous avons adoré ! Réservation facile, et la meilleure table face aux musiciens. Ambiance intime, service parfait et cuisine délicieuse.</p>
                            <div class="testimonial-tags"><span class="testimonial-tag">Authentique</span><span class="testimonial-tag">Musique Live</span></div>
                        </div>
                    </div>
                    <div class="testimonial-card-new reveal reveal-delay-3" data-id="nouba">
                        <div class="testimonial-image-wrapper" onclick="StoryManager.open('nouba')">
                            <img loading="lazy" src="https://MTSZone.b-cdn.net/Malak/NoubaReview12%20(1)%20(1).png" alt="Nouba Review">
                            <div class="story-badge-premium">Voir la Story<div class="play-circle"><svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg></div></div>
                        </div>
                        <div class="testimonial-content-new">
                            <h3 class="card-title">Nouba</h3>
                            <h4 class="testimonial-headline">"Talents Incroyables, Soirée Inoubliable"</h4>
                            <p class="testimonial-quote-new">Quelle ambiance ! Un lieu chic, magnifiquement décoré. Le personnel est très agréable. On a dansé, chanté, c'était tout simplement génial !</p>
                            <div class="testimonial-tags"><span class="testimonial-tag">Ambiance Festive</span><span class="testimonial-tag">Show Explosif</span></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section reveal" id="faq">
                <div class="section-header"><h2>L'Excellence, en toute simplicité</h2><p>Votre expérience commence dès maintenant.</p></div>
                <div class="accordion">
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>Comment s'effectue le règlement ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p><strong>En toute liberté.</strong> Notre service de conciergerie est entièrement offert. Vous réglez vos consommations directement sur place, auprès de l'établissement, à la fin de votre soirée. Aucune coordonnée bancaire n'est requise ici.</p></div></div>
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>Quels sont les privilèges de votre service ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p>En passant par Marrakech Top Spot, vous n'êtes pas un simple client, mais un <strong>invité attendu</strong>. Nos partenaires nous accordent une priorité sur le placement des tables afin de vous garantir la meilleure visibilité sur le spectacle.</p></div></div>
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>Puis-je personnaliser ma soirée (Anniversaire, Transport) ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p>Absolument. Une fois votre Guestlist validée, vous aurez un accès direct à notre <strong>Ligne WhatsApp Prioritaire</strong>. Votre concierge sera à votre écoute pour orchestrer les détails : gâteau d'anniversaire, navette privée ou préférences alimentaires.</p></div></div>
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>Quel est le style vestimentaire recommandé ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p>L'esprit est à <strong>l'élégance décontractée</strong> ("Chic & Casual"). Marrakech est une ville de fête : sentez-vous libre d'être beau et à l'aise. Les tenues de soirée sont appréciées, tout comme le style vacancier soigné.</p></div></div>
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>La cuisine est-elle variée ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p>Oui. Notre sélection privilégie les établissements offrant une double expérience : l'authenticité de la <strong>Gastronomie Marocaine Fine</strong> et des alternatives Internationales de qualité. Végétariens et palais exigeants trouveront leur bonheur.</p></div></div>
                    <div class="accordion-item"><div class="accordion-header" onclick="toggleAccordion(this)"><h4>La confirmation est-elle immédiate ?</h4><span class="accordion-toggle">+</span></div><div class="accordion-content"><p>Oui, <strong>instantanée</strong>. Dès validation du formulaire, votre nom est inscrit sur la liste du soir. Vous recevez votre confirmation à l'écran et pouvez immédiatement contacter le concierge si vous avez une question de dernière minute.</p></div></div>
                </div>
            </section>
        </div>
    </main>

    <footer><p>© 2025 Marrakech Top Spot. Le Curateur de Vos Soirées d'Exception.</p></footer>

    <!-- === V24 ULTIMATE STORY OVERLAY === -->
    <div id="storyOverlay" class="story-overlay">
        <div class="story-container">
            <div class="story-ui-top">
                <div class="story-progress-bar" id="storyProgressBar"></div>
                <div class="story-controls-row">
                    <div class="story-brand" id="storyBrandName">RESTAURANT NAME</div>
                    <div class="story-actions">
                        <div class="story-icon" id="soundToggle">
                            <svg id="iconMute" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                            <svg id="iconSound" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        </div>
                        <div class="story-icon" id="storyCloseBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="story-media-wrapper" id="storyMediaWrapper"></div>
            <div class="story-nav-zone nav-left" id="storyNavLeft"></div>
            <div class="story-nav-zone nav-center" id="storyNavHold"></div>
            <div class="story-nav-zone nav-right" id="storyNavRight"></div>
            <div class="story-footer" id="storyTextContent">
                <h3 class="story-title-text" id="storyTitle">Restaurant Name</h3>
                <p class="story-desc-text" id="storyDesc">Description here...</p>
                <button class="story-cta-btn" id="storyBookBtn">RÉSERVER CETTE TABLE</button>
                <div class="story-trust">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Réservation 100% gratuite
                </div>
            </div>
            <div class="story-climax-card" id="climaxCard">
                <div class="climax-phantom-layer" id="climaxBgContainer"></div>
                <div class="climax-gradient-overlay"></div>
                <div class="climax-content">
                    <h2 class="climax-title" id="climaxTitle">Restaurant Name</h2>
                    <div class="climax-badge">
                        <div class="climax-stars">
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                        <span class="climax-badge-text">Excellence Confirmée</span>
                    </div>
                    <p class="climax-desc" id="climaxDesc">Une soirée inoubliable vous attend. Tables limitées pour ce soir.</p>
                    <button class="climax-cta" id="climaxBtn">VALIDER MA TABLE VIP</button>
                    <div class="story-trust">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Réservation Gratuite & Instantanée
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === MENU MODAL V18 === -->
    <div class="menu-modal-overlay" id="menuModal">
        <div class="menu-modal-content">
            <div class="menu-header">
                <h3 id="menu-title">Carte & Menu</h3>
                <div class="close-menu" onclick="MenuEngine.close()">×</div>
            </div>
            <div class="menu-iframe-container" id="iframeContainer"></div>
        </div>
    </div>
    
    <!-- === MAPBOX MODAL === -->
    <div id="mapbox-modal">
        <div class="map-wrapper">
            <div class="map-close" onclick="closeMapWidget()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <div id="map-canvas"></div>
            <div class="concierge-panel">
                <div class="concierge-header"><div class="concierge-avatar-wrapper"><img src="https://MTSZone.b-cdn.net/file%20(1)%20(1).png" class="concierge-avatar" alt="Concierge"><span class="status-dot-live"></span></div><div class="concierge-info"><h4>Concierge VIP</h4><p>En ligne • Prêt à vous aider</p></div></div>
                <div class="venue-address-block"><h5 id="v-name">--</h5><p id="v-address">--</p></div>
                <a href="#" id="v-wa-btn" target="_blank" class="btn-wa-full"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.68-2.031-.967-.272-.099-.47-.149-.669.198-.198.347-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.173.198-.297.297-.495.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413z"/></svg> Contacter le Concierge</a>
            </div>
        </div>
    </div>

    <a href="https://wa.me/212680802756?text=Bonjour%2C%20j%27aimerais%20v%C3%A9rifier%20les%20disponibilit%C3%A9s%20pour%20un%20d%C3%AEner%20spectacle." target="_blank" class="wa-sticky-container" id="waSticky">
        <div class="wa-icon"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="#FFFFFF" stroke="none"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg><span class="wa-status-dot"></span></div>
        <div class="wa-text-col"><span class="wa-title">Concierge Direct</span><span class="wa-subtext" id="waDynamicText">Statut VIP : <span class="wa-highlight">Prioritaire</span></span></div>
    </a>

<script>
const videoIdMap = {
    "stah": "o39c248x3j", "tanjia": "0q2d4cko4b", "folk": "t1873lqxyr", "ritziF": "sjy3c57qxz", "ritziD": "sjy3c57qxz",
    "nouba": "c349wcz8hz", "noto": "khj4dlqdv2", "ibrahim": "f1pummm5r9", "malak": "x1wjp5k66n"
};

const VENUES = {
    'malak': { name: 'Malak Emeraude', address: 'Intersection entre Bd Mohamed 6 et Bd de la Menara, 1er étage, N°16, Marrakesh 40001', coords: [-8.0102153, 31.6174768] },
    'ibrahim': { name: 'Ibrahim Pacha', address: 'Av. Prince Moulay Rachid, Marrakech 40000', coords: [-8.0107559, 31.6172768] },
    'nouba': { name: 'Nouba', address: 'Zone de l, Bd Mohamed VI, Marrakech', coords: [-7.9826729, 31.5782496] },
    'stah': { name: 'Restaurant Stah', address: "Route de l'Ourika, Zone Touristique Agdal, Marrakech 40000", coords: [-7.98495, 31.58853] },
    'noto': { name: 'Noto Marrakech', address: 'Villa Yvette, angle avenue Ibn Khattib, Rue Abdelaziz Ettaalibi, Marrakech 40000', coords: [-8.0044133, 31.6261171] },
    'ritziF': { name: 'Ritzi Restaurant', address: 'N 8 RDV residence AMALFI, Rue Zoubeir, Av. Hassan II, Marrakech', coords: [-8.0178521, 31.6291417] },
    'ritziD': { name: 'Ritzi Restaurant', address: 'N 8 RDV residence AMALFI, Rue Zoubeir, Av. Hassan II, Marrakech', coords: [-8.0178521, 31.6291417] },
    'folk': { name: 'Folk Restaurant', address: 'Rue el Imam Chafii, Marrakech 40000', coords: [-8.0103, 31.62867] },
    'tanjia': { name: 'Le Tanjia', address: 'Place des Ferblantiers, Marrakech 40000', coords: [-7.98909, 31.61997] }
};

const experiencesData = window.experiencesData = [
    {
        id: "malak", name: "Malak Emeraude", categories: ["grand-spectacle"], smartLabel: "DÎNER-SPECTACLE & VUE", price: "Hivernage", rating: "4.3", reviews: "1011+", time: "20h00 - 02h30",
        description: "Le show le plus éblouissant de Marrakech. Dînez face aux montagnes de l'Atlas et laissez-vous emporter par un spectacle live grandiose. Le mélange parfait entre haute gastronomie et ambiance festive chic.",
        image: "https://MTSZone.b-cdn.net/MalakV2/ThumbOfficial.jpg",
        gallery: ["https://MTSZone.b-cdn.net/MalakV2/Malak7.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak11.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak6.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak3.jpg", "https://MTSZone.b-cdn.net/Malak/Malak2.jpg", "https://MTSZone.b-cdn.net/Malak/NewMalak10.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak6.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak2.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak4.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak1.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak8.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak9.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Malak/Malak13.jpg", video: "https://player.mediadelivery.net/embed/555558/125da33f-a663-48d9-b111-cae2bfb4b268", audio: "https://MTSZone.b-cdn.net/Malak5.MP3", menuUrl: "https://MTSZone.b-cdn.net/Malak/Please_upgrade_this_202601051514%20(1)_compressed.pdf", menuPrice: 60, popular: true
    },
    {
        id: "ibrahim", name: "Ibrahim Pacha", categories: ["grand-spectacle"], smartLabel: "PALAIS & SPECTACLE", price: "Hivernage", rating: "4.7", reviews: "1140+", time: "20h00 - 02h30",
        description: "Entrez dans la peau d'un Sultan. Un palais somptueux pour un dîner-spectacle unique de 3 heures. Derviches tourneurs, festin royal et chanteurs à voix : une immersion totale digne des Mille et Une Nuits.",
        image: "https://MTSZone.b-cdn.net/Brahim%20Pacha/BrahimThumb3%20(1).jpeg",
        gallery: ["https://MTSZone.b-cdn.net/Pacha%20V2/Brahim10.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/NewPacha2.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha7.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/NewPacha7.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha8.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha9.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/Brahim1.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha88.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha888.jpg", video: "https://player.mediadelivery.net/embed/555558/a267114f-9b0b-4fb8-9d7b-e0e01e5344bc", audio: "https://MTSpull.b-cdn.net/iBrahimPachaAudio.MP3", menuUrl: "https://MTSZone.b-cdn.net/Menus/ibrahim-pacha-menu-avec%20compression.pdf", menuPrice: 60, popular: true
    },
    {
        id: "nouba", name: "Nouba Restaurant", categories: ["grand-spectacle", "party"], smartLabel: "Aerial Jungle", price: "Agdal", rating: "4.4", reviews: "3647+", time: "19h30 - 23h15",
        description: "Le restaurant festif incontournable. Dînez dans une jungle chic pendant que des acrobates volent au-dessus de vous. Une cuisine fusion explosive qui se transforme en soirée clubbing inoubliable.",
        image: "https://MTSpull.b-cdn.net/Nouba/ThumbNoubaMeh1.jpg",
        gallery: ["https://MTSpull.b-cdn.net/Nouba/Nouba7.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba10.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba1.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba11.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba12.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba9.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba8.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba2.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba3.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba5.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/Nouba/Nouba4.jpg", video: "https://player.mediadelivery.net/embed/555558/2613ac43-fc55-4d5d-a837-94705b17e6db", audio: "https://MTSpull.b-cdn.net/NoubaAudio1.MP3", menuUrl: "https://MTSZone.b-cdn.net/Menus/Nouba-menu-avec%20compression.pdf", menuPrice: 75, popular: false
    },
    {
        id: "stah", name: "Stah Rooftop", categories: ["party", "grand-spectacle"], smartLabel: "Starlit Rooftop", price: "Agdal", rating: "4.5", reviews: "2472+", time: "19h30 - 01h00",
        description: "Le rooftop pour dominer la ville. Tapas créatives, cocktails signatures et DJ set face au plus beau coucher de soleil. L'ambiance branchée et décontractée idéale pour débuter la soirée sous les étoiles.",
        image: "https://MTSpull.b-cdn.net/stah/StahThum2.jpg",
        gallery: ["https://MTSpull.b-cdn.net/stah/Stah4V2.jpg", "https://MTSpull.b-cdn.net/stah/Stah6V2.jpg", "https://MTSpull.b-cdn.net/stah/Stah1.jpg", "https://MTSpull.b-cdn.net/stah/Stah9.jpg", "https://MTSpull.b-cdn.net/stah/Untitled-LiveDoc-(37).jpg", "https://MTSpull.b-cdn.net/stah/Stah12.jpg", "https://MTSpull.b-cdn.net/stah/Stah11.jpg", "https://MTSpull.b-cdn.net/stah/Stah5.jpg", "https://MTSpull.b-cdn.net/stah/Stah8.jpg", "https://MTSpull.b-cdn.net/stah/Stah2.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/stah/Stah3.jpg", video: "https://player.mediadelivery.net/embed/555558/c9e02c8e-79a4-4325-95bc-27b4e2de904e", audio: "https://MTSpull.b-cdn.net/StahJBV5.MP3", menuUrl: "https://MTSZone.b-cdn.net/Menus/STA7_Menu-avec%20compression.pdf", menuPrice: 40, popular: false
    },
    {
        id: "noto", name: "Noto Marrakech", categories: ["party"], smartLabel: "Italian Euphoria", price: "Hivernage", rating: "4.5", reviews: "300+", time: "19h30 - 23h15",
        description: "La Dolce Vita électrique. C'est l'Italie qui fait la fête à Marrakech ! Live band, pâtes à la truffe et énergie débordante. Le spot élégant et survolté pour chanter et dîner jusqu'au bout de la nuit.",
        image: "https://MTSZone.b-cdn.net/NOTO/Thumbnail5.jpg",
        gallery: ["https://MTSZone.b-cdn.net/NOTO/Noto15.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto9.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto14.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto8.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto11.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto12.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto1.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto10.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto7.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto5.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto16.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto17.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/NOTO/Noto18.jpg", video: "https://player.mediadelivery.net/embed/555558/6c744bc3-630c-4715-9b9d-563263c50a82", audio: "https://MTSZone.b-cdn.net/NOTO/NoubaFestifAudio1.MP3", menuUrl: "https://MTSZone.b-cdn.net/NOTO/CARTE-NOTO-MAROC-compressed.pdf", menuPrice: 70, popular: false
    },
    {
        id: "ritziF", name: "Ritzi Restaurant", categories: ["party"], smartLabel: "Danse & Glamour", price: "Hivernage", rating: "4.5", reviews: "1324+", time: "12h00 - 23h30",
        description: "L'élégance à l'état pur. Une cuisine méditerranéenne raffinée qui laisse place à la fête. Chic, vibrant et \"Gatsby-esque\" : la soirée parfaite pour ceux qui veulent dîner et danser avec classe.",
        image: "https://MTSZone.b-cdn.net/Ritzi/Thumbnail2.jpg",
        gallery: ["https://MTSZone.b-cdn.net/Ritzi/Ritzi3-1.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi7.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi2.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi9.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi10.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi14.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi15.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi12.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi11.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi1.jpg", "https://MTSZone.b-cdn.net/Ritzi/RitziColored.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Ritzi/Ritzi18.jpg", video: "https://player.mediadelivery.net/embed/555558/120c46bd-d7c8-4d0e-88a3-46e51a1b92aa", audio: "https://MTSZone.b-cdn.net/Ritzi/AudioRitziF2.MP3", menuUrl: "https://MTSZone.b-cdn.net/Ritzi/MenuRitzi-1_compressed.pdf", menuPrice: 50, popular: true
    },
    {
        id: "folk", name: "Folk Restaurant", categories: ["authentic", "party"], smartLabel: "Danse & Gnaoua", price: "Guéliz", rating: "4.4", reviews: "504+", time: "19h30 - 23h15",
        description: "Vibrez au rythme de Marrakech. Une immersion totale dans la culture Gnaoua au cœur de Guéliz. Cuisine marocaine savoureuse et musique live envoûtante pour une soirée authentique qui touche l'âme.",
        image: "https://MTSZone.b-cdn.net/LeGrandBazar/Thumboff.jpg",
        gallery: ["https://MTSpull.b-cdn.net/Folk/Folk8.jpg", "https://MTSpull.b-cdn.net/Folk/Folk1.jpg", "https://MTSpull.b-cdn.net/Folk/Folk4.jpg", "https://MTSpull.b-cdn.net/Folk/Folk3.jpg", "https://MTSpull.b-cdn.net/Folk/Folk2.jpg", "https://MTSpull.b-cdn.net/Folk/Folk9.jpg", "https://MTSpull.b-cdn.net/Folk/Folk7.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/Folk/Folk6.jpg", video: "https://player.mediadelivery.net/embed/555558/4e641eb3-3629-42db-b2f6-5ca55283e7fc", audio: "https://MTSpull.b-cdn.net/FolkAudio.MP3", menuUrl: "https://MTSZone.b-cdn.net/folk-menu-marrakechtopspot1_compressed.pdf", menuPrice: 45, popular: false
    },
    {
        id: "tanjia", name: "Le Tanjia", categories: ["authentic"], smartLabel: "Riad Légendaire", price: "Médina", rating: "4.3", reviews: "2180+", time: "12h00 - 23h15",
        description: "La magie d'un Riad historique. Plongez au cœur de la Médina pour un dîner marocain légendaire. Danseuses orientales et architecture traditionnelle pour une nuit 100% authentique.",
        image: "https://MTSpull.b-cdn.net/Tanjia/ThumbTanjia1.jpg",
        gallery: ["https://MTSpull.b-cdn.net/Tanjia/Tanjia9.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia4.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia1.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia3.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia8.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia5.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/Tanjia/Tanjia7.jpg", video: "https://player.mediadelivery.net/embed/555558/7ae42fd5-ecf2-4b7f-bfe1-3695c1899bb2", audio: "https://MTSpull.b-cdn.net/TanjiaAudio.MP3", menuUrl: "https://MTSpull.b-cdn.net/TANJIA.pdf.pdf", menuPrice: 35, popular: false
    }
];

const AvailabilityEngine = {
    sheetId: '1flTpiOoNjTdxpPTo0wEYk_q-IW2-eovCVxWUQaw_N-w', rules: {}, isLoaded: false,
    init: async function() {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${this.sheetId}/export?format=csv`;
            const response = await fetch(url); const text = await response.text();
            const rows = text.split('\n').slice(1);
            rows.forEach(row => {
                const cols = row.split(','); 
                const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                if(cleanCols.length >= 1 && cleanCols[0]) {
                    const id = cleanCols[0].toLowerCase();
                    const day1 = (cleanCols[1] || "").toLowerCase();
                    const day2 = (cleanCols[2] || "").toLowerCase();
                    const full = (cleanCols[3] || "").toLowerCase();
                    this.rules[id] = { forbiddenDays: [day1, day2].filter(d => d), fullyBooked: full === 'yes' };
                }
            });
            this.isLoaded = true; return true;
        } catch (e) { console.warn("Availability sync failed", e); this.isLoaded = true; return false; }
    },
    check: function(restaurantId, dateString) {
        if(!this.isLoaded || !restaurantId || !dateString) return { valid: true };
        const rule = this.rules[restaurantId.toLowerCase()]; if(!rule) return { valid: true };
        const date = new Date(dateString); const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayName = days[date.getDay()];
        if(rule.forbiddenDays.includes(dayName)) return { valid: false, reason: "closed", msg: "Fermé ou privatisé ce jour-là." };
        const today = new Date().toISOString().split('T')[0];
        if(dateString === today && rule.fullyBooked) return { valid: false, reason: "full", msg: "Complet pour ce soir." };
        return { valid: true };
    },
    isFullToday: function(restaurantId) { 
        if(!this.isLoaded) return false; 
        const rule = this.rules[restaurantId.toLowerCase()]; 
        if (!rule) return false;
        if (rule.fullyBooked) return true;
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const todayName = days[new Date().getDay()];
        return rule.forbiddenDays.includes(todayName);
    }
};

// === ELITE PHONE INPUT LOGIC (UPGRADED V2) ===
function toggleCountryDropdown(e) {
    // Stop propagation to prevent immediate closing
    e.stopPropagation();
    
    // Prevent default ONLY if it's a touch event on the container, to avoid double-firing.
    // BUT if the target is the INPUT, we must NOT prevent default, otherwise focus won't work on iOS.
    const isInput = e.target.closest('.code-input');
    
    if (e.type === 'touchstart') {
        if (!isInput) e.preventDefault(); // Prevent ghost click on selector, but let input focus
    }
    
    if(isInput) {
        // Just focus, don't toggle
        return; 
    }

    const dd = document.getElementById('countryDropdown');
    const selector = document.getElementById('countrySelector');
    const isVisible = dd.classList.contains('visible');
    
    // Toggle
    if(isVisible) {
        dd.classList.remove('visible');
        selector.classList.remove('active');
    } else {
        dd.classList.add('visible');
        selector.classList.add('active');
        // Vibrate for feedback on mobile
        if(navigator.vibrate) navigator.vibrate(10);
    }
}

function selectCountry(flag, code) {
    document.getElementById('selectedFlag').textContent = flag;
    const input = document.getElementById('countryCode');
    input.value = code;
    
    document.getElementById('countryDropdown').classList.remove('visible');
    document.getElementById('countrySelector').classList.remove('active');
    
    // Haptic feedback
    if(navigator.vibrate) navigator.vibrate(15);
    
    if(code) {
        document.getElementById('phone').focus();
    } else {
        input.focus(); 
    }
}

function handleCodeInput(el) {
    if(!el.value.startsWith('+')) {
        el.value = '+' + el.value.replace(/[^\d]/g, '');
    } else {
        el.value = '+' + el.value.substring(1).replace(/[^\d]/g, '');
    }
    
    const val = el.value;
    const flagMap = {
        '+33': '🇫🇷', '+212': '🇲🇦', '+44': '🇬🇧', '+32': '🇧🇪',
        '+41': '🇨🇭', '+1': '🇺🇸', '+34': '🇪🇸', '+49': '🇩🇪',
        '+39': '🇮🇹', '+971': '🇦🇪'
    };
    
    if(flagMap[val]) {
        document.getElementById('selectedFlag').textContent = flagMap[val];
    } else {
        document.getElementById('selectedFlag').textContent = '🌐';
    }
}

// Add touchstart for faster mobile response
const selector = document.getElementById('countrySelector');
if(selector) {
    selector.addEventListener('touchstart', toggleCountryDropdown, {passive: false});
}

document.addEventListener('click', function(e) {
    const dd = document.getElementById('countryDropdown');
    const selector = document.getElementById('countrySelector');
    if(dd && dd.classList.contains('visible') && !selector.contains(e.target)) {
        dd.classList.remove('visible');
        selector.classList.remove('active');
    }
});

// Trigger Elite Animation
setTimeout(() => {
    // Target the PARENT container for the full effect
    const header = document.querySelector('.form-trust-header');
    if(header) header.classList.add('elite-trust-reveal');
}, 2500);

// === USER ID GENERATOR: DDMM + 5 Random Chars ===
function generateUserID() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let random = '';
    for (let i = 0; i < 5; i++) {
        random += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return `${day}${month}${random}`;
}

// === ELITE UPGRADE 1: TEASER PRE-WARMING ENGINE ===
function initTeaserEngine() {
    const cardTimers = new Map();
    const preloadContainer = document.getElementById('video-preload-container');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const card = entry.target;
            if (card.classList.contains('sold-out')) return;
            
            if (entry.isIntersecting && entry.intersectionRatio >= 0.55) {
                if (!cardTimers.has(card)) {
                    const timerId = setTimeout(() => { 
                        // 1. Trigger UI Animation (Smooth)
                        card.classList.add('teaser-active');
                        
                        // 2. Delayed Video Preload (200ms delay to prevent main-thread jank during CSS animation)
                        setTimeout(() => {
                            // === VIDEO PRELOAD LOGIC ===
                            const expId = card.dataset.id;
                            const exp = experiencesData.find(e => e.id === expId);
                            
                            if(exp && exp.video) {
                                // Check if already preloaded
                                const existingIframe = document.querySelector(`#video-preload-container iframe[data-id="${expId}"]`);
                                
                                if (!existingIframe && preloadContainer) {
                                    // Create hidden iframe
                                    const iframe = document.createElement('iframe');
                                    iframe.setAttribute('data-id', expId);
                                    
                                    // Bunny Parameters: 
                                    // preload=true: Buffers content
                                    // autoplay=true & muted=true: Starts playback invisibly (instant play when shown)
                                    // controls=0: Hides controls
                                    // enablejsapi=1: Allows StoryManager to control playback (unmute, detect end)
                                    let src = exp.video;
                                    if(!src.includes('?')) src += '?';
                                    src += `&preload=true&autoplay=true&muted=true&loop=false&controls=0&playsinline=1&enablejsapi=1&modestbranding=1`;
                                    
                                    iframe.src = src;
                                    iframe.allow = "autoplay; fullscreen; accelerometer; encrypted-media; gyroscope; picture-in-picture";
                                    iframe.style.width = "100%";
                                    iframe.style.height = "100%";
                                    iframe.style.border = "none";
                                    iframe.style.opacity = '0'; // Ensure invisible initially
                                    iframe.className = 'story-media-item'; // Add class for seamless integration later
                                    
                                    preloadContainer.appendChild(iframe);
                                }
                            }
                            // Note: Image preloading removed to prioritize video start performance
                        }, 200);

                    }, 600);
                    cardTimers.set(card, timerId);
                }
            } else {
                if (entry.intersectionRatio < 0.1) {
                    if (cardTimers.has(card)) { clearTimeout(cardTimers.get(card)); cardTimers.delete(card); }
                    card.classList.remove('teaser-active');
                }
            }
        });
    }, { threshold: [0.1, 0.55] });
    setTimeout(() => { document.querySelectorAll('.spectacle-card').forEach(card => observer.observe(card)); }, 100);
}

function validatePhone(phone, countryCode) {
    const cleanPhone = phone.replace(/\D/g, '');
    if (cleanPhone.length < 5 || cleanPhone.length > 15) return false; 

    if (countryCode === '+33') {
        let local = cleanPhone;
        if (local.length === 10 && local.startsWith('0')) local = local.substring(1);
        if (local.length !== 9) return false;
        if (!['6', '7'].includes(local.charAt(0))) return false;
    } else if (countryCode === '+212') { 
        let local = cleanPhone;
        if (local.length === 10 && local.startsWith('0')) local = local.substring(1);
        if (local.length !== 9) return false;
        if (!['6', '7'].includes(local.charAt(0))) return false;
    }
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    // === INTENT LOGIC ===
    const urlParams = new URLSearchParams(window.location.search);
    const intent = urlParams.get('intent');
    let bookButtonText = "RÉSERVER MA SOIRÉE (0€)"; // Default

    if (intent === 'festif') {
        // Hero
        const title1 = document.querySelector('.title-line-1'); if(title1) title1.textContent = "Votre Accès Privé aux";
        const title2 = document.getElementById('heroTitleLine2'); if(title2) title2.textContent = "Restaurants Festifs";
        const title3 = document.querySelector('.title-line-3'); if(title3) title3.textContent = "les plus prisés de Marrakech";
        const sub = document.querySelector('.hero-subtitle'); if(sub) sub.innerHTML = "Accédez aux 7 adresses incontournables où l'ambiance monte crescendo. Réservation instantanée, sans acompte.";

        // Experiences
        const expTitle = document.getElementById('experiences-title'); if(expTitle) expTitle.innerHTML = "7 Ambiances Electriques. Où ferez-vous la fête ce soir ?";
        const expSub = document.getElementById('experiences-subtitle'); if(expSub) expSub.textContent = "Oubliez les dîners classiques. Voici les 7 spots confidentiels où Marrakech s'enflamme réellement une fois la nuit tombée.";

        // Filter trigger
        setTimeout(() => {
            const btn = document.querySelector('.filter-btn[onclick*="party"]');
            if(btn) btn.click();
        }, 100);

    } else if (intent === 'spectacle') {
        // Hero
        const title1 = document.querySelector('.title-line-1'); if(title1) title1.textContent = "Votre Table VIP pour un";
        const title2 = document.getElementById('heroTitleLine2'); if(title2) title2.textContent = "Dîner Spectacle";
        const title3 = document.querySelector('.title-line-3'); if(title3) title3.textContent = "d'exception à Marrakech";
        const sub = document.querySelector('.hero-subtitle'); if(sub) sub.innerHTML = "Accédez aux 7 scènes artistiques les plus époustouflantes de la ville rouge. Réservation instantanée, sans acompte.";

        // Experiences
        const expTitle = document.getElementById('experiences-title'); if(expTitle) expTitle.innerHTML = "7 Shows Uniques. Quelle magie choisirez-vous ce soir ?";
        const expSub = document.getElementById('experiences-subtitle'); if(expSub) expSub.textContent = "Oubliez les adresses de masse. Voici les 7 scènes grandioses où la haute gastronomie rencontre le spectacle vivant ce soir.";

        bookButtonText = "DÉCOUVRIR LES SPECTACLES";

        // Filter trigger
        setTimeout(() => {
            const btn = document.querySelector('.filter-btn[onclick*="grand-spectacle"]');
            if(btn) btn.click();
        }, 100);
    }

    // Generate and Set User ID on Load
    const userId = generateUserID(); 
    document.getElementById('userID').value = userId;

    const dateInput = document.getElementById('date'); const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today); dateInput.value = today;
    const select = document.getElementById('restaurant'); const grid = document.getElementById('spectaclesGrid');

    AvailabilityEngine.init().then(() => {
        const select = document.getElementById('restaurant');
        document.querySelectorAll('.spectacle-card').forEach(card => {
             const id = card.dataset.id; const isFull = AvailabilityEngine.isFullToday(id);
             if(isFull) {
                 card.classList.add('sold-out');
                 if(!card.querySelector('.sold-out-overlay')) {
                     const overlay = document.createElement('div'); overlay.className = 'sold-out-overlay';
                     overlay.innerHTML = '<span class="sold-out-badge">COMPLET CE SOIR</span>';
                     const imgContainer = card.querySelector('.card-image'); if(imgContainer) imgContainer.appendChild(overlay);
                 }
                 const option = select.querySelector(`option[value="${id}"]`); if(option) option.remove();
             } else { card.classList.remove('sold-out'); const overlay = card.querySelector('.sold-out-overlay'); if(overlay) overlay.remove(); }
        });
    });

    experiencesData.forEach((exp, index) => {
        if (!exp.soldOut) { const option = document.createElement('option'); option.value = exp.id; option.textContent = exp.name; select.appendChild(option); }
        let ctaText = "DÉCOUVRIR";
        if (exp.categories.includes('grand-spectacle')) ctaText = "VOIR LE SHOW"; else if (exp.categories.includes('party')) ctaText = "VOIR L'AMBIANCE";
        let fomoHTML = ''; let soldOutClass = exp.soldOut ? 'sold-out' : '';
        let soldOutOverlay = exp.soldOut ? '<div class="sold-out-overlay"><span class="sold-out-badge">COMPLET CE SOIR</span></div>' : '';
        let initialViewers = Math.floor(Math.random() * (14 - 6 + 1)) + 6; if(exp.popular) initialViewers += 5;
        let viewerText = `${initialViewers} personnes consultent`;
        let highDemandHTML = (!exp.soldOut && (exp.id === 'nouba' || exp.id === 'malak')) ? `<span class="high-demand-indicator">🔥 Très demandé</span>` : '';
        if(!exp.soldOut) { fomoHTML = `<div class="live-viewer-indicator" id="fomo-${exp.id}" data-viewers="${initialViewers}"><span class="live-pulse-dot"></span><span class="viewer-text">${viewerText}</span>${highDemandHTML}</div>`; }
        const card = document.createElement('div');
        card.className = `spectacle-card reveal reveal-delay-${(index % 3) + 1} ${soldOutClass}`;
        card.dataset.categories = exp.categories.join(" "); card.dataset.id = exp.id; card.id = `card-${exp.id}`;
        const popularBadge = exp.popular ? `<span class="popular-badge"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>` : '';

        // === UPGRADE: REVIEWS HTML STRUCTURE ===
        card.innerHTML = `
            <div class="card-image" onclick="StoryManager.open('${exp.id}')">
                <img loading="lazy" src="${exp.image}" alt="${exp.name}">
                ${soldOutOverlay}
                <div class="card-image-overlay" data-cta="${ctaText}"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg></div>
                <div class="media-badge"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> GALERIE & VIDÉO</div>
                <span class="spectacle-type-badge">${exp.smartLabel}</span>${popularBadge}
            </div>
            <div class="card-content">
                ${fomoHTML}
                <h3 class="card-title">${exp.name}</h3>
                
                <div class="card-rating">
                    <span class="stars">★★★★★</span>
                    <span class="rating-score-box">${exp.rating}/5</span>
                    <span class="review-text-clean">(${exp.reviews} avis)</span>
                </div>

                <p class="card-description">${exp.description}</p>
                <div class="card-meta"><span>${exp.time} • Tous les soirs</span> <span class="price-range" onclick="openMapWidget('${exp.id}', event)">${exp.price}</span></div>
                <div class="card-actions-container">
                    <button class="card-btn btn-menu" onclick="openMenu('${exp.menuUrl}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>MENU</button>
                    <button class="card-btn btn-book" onclick="scrollToForm('${exp.id}')">${bookButtonText}</button>
                </div>
                <div class="trust-micro-signal"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M9 12l2 2 4-4"></path></svg> Paiement sur place &bull; Zéro Frais</div>
            </div>`;
        grid.appendChild(card);
    });

    document.getElementById('heroForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
        let valid = true; const requiredFields = ['fullname', 'restaurant', 'date'];
        
        const phoneInput = document.getElementById('phone'); 
        const countryCode = document.getElementById('countryCode').value;

        if(!validatePhone(phoneInput.value, countryCode)) { 
            valid = false; 
            document.getElementById('container-phone').classList.add('error'); 
            document.getElementById('error-phone').classList.add('visible'); 
            document.getElementById('error-phone').textContent = 'Numéro mobile invalide (WhatsApp)'; 
            if(window.innerWidth < 768) document.getElementById('container-phone').scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
             document.getElementById('container-phone').classList.remove('error');
             document.getElementById('error-phone').classList.remove('visible');
        }

        requiredFields.forEach(id => {
            const el = document.getElementById(id); const container = document.getElementById('container-' + id); const error = document.getElementById('error-' + id);
            if(!el.value || el.value.trim() === '') { 
                if(container) container.classList.add('error'); 
                if(error) error.classList.add('visible'); 
                valid = false; 
            } else { 
                if(container) container.classList.remove('error'); 
                if(error) error.classList.remove('visible'); 
            }
        });
        if(valid) {
            if (!AvailabilityEngine.isLoaded) {
                 const submitBtn = document.getElementById('submitBtn');
                 const originalText = submitBtn.textContent;
                 submitBtn.textContent = "Vérification en cours... Réessayez dans 2s";
                 submitBtn.style.opacity = "0.7";
                 setTimeout(() => {
                     submitBtn.textContent = originalText;
                     submitBtn.style.opacity = "1";
                 }, 2000);
                 return;
            }

            const restId = document.getElementById('restaurant').value; 
            const dateVal = document.getElementById('date').value; 
            const status = AvailabilityEngine.check(restId, dateVal);
            
            if(!status.valid) { 
                valid = false; 
                const dateContainer = document.getElementById('container-date'); 
                const dateError = document.getElementById('error-date'); 
                dateContainer.classList.add('error'); 
                dateError.textContent = status.msg; 
                dateError.classList.add('visible'); 
                const formContainer = document.getElementById('heroFormContainer'); 
                formContainer.classList.add('shake-anim'); 
                setTimeout(() => formContainer.classList.remove('shake-anim'), 500); 
                if(navigator.vibrate) navigator.vibrate(200); 
                return; 
            }
        }
        if(!valid) { if(navigator.vibrate) navigator.vibrate([50, 50, 50]); return; }

        const formData = { fullname: document.getElementById('fullname').value.trim(), restaurant: document.getElementById('restaurant').value, date: document.getElementById('date').value, guests: document.getElementById('guests').value, enfants: document.getElementById('kidsCount').value, phone: document.getElementById('countryCode').value + document.getElementById('phone').value.replace(/\s/g, ''), countryCode: document.getElementById('countryCode').value, userID: document.getElementById('userID').value };
        const selectedRestaurant = experiencesData.find(e => e.id === formData.restaurant); const restaurantName = selectedRestaurant ? selectedRestaurant.name : formData.restaurant;
        const videoId = videoIdMap[formData.restaurant] || ''; const confirmationNumber = 'MTS' + Date.now().toString(36).toUpperCase();

        const overlay = document.getElementById('processingOverlay'); const progressFill = document.getElementById('progressFill'); const step1 = document.getElementById('step1'); const step2 = document.getElementById('step2'); const step3 = document.getElementById('step3'); const headline = document.getElementById('processingHeadline'); const subtext = document.getElementById('processingSubtext');
        document.body.style.overflow = 'hidden'; overlay.style.display = 'flex'; void overlay.offsetWidth; overlay.classList.add('active'); progressFill.style.width = '5%';

        setTimeout(() => { step1.classList.add('active'); progressFill.style.width = '30%'; headline.textContent = 'Connexion...'; subtext.textContent = 'Communication avec notre concierge'; }, 300);
        setTimeout(() => { step1.classList.remove('active'); step1.classList.add('completed'); step1.querySelector('.step-icon').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'; step2.classList.add('active'); progressFill.style.width = '60%'; headline.textContent = 'Vérification...'; subtext.textContent = 'Contrôle des disponibilités en temps réel'; }, 1500);
        setTimeout(() => { step2.classList.remove('active'); step2.classList.add('completed'); step2.querySelector('.step-icon').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'; step3.classList.add('active'); progressFill.style.width = '90%'; headline.textContent = 'Confirmation...'; subtext.textContent = 'Votre table VIP est réservée'; }, 2800);
        setTimeout(() => {
            step3.classList.remove('active'); step3.classList.add('completed'); step3.querySelector('.step-icon').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'; progressFill.style.width = '100%'; headline.textContent = 'Confirmé !'; subtext.textContent = 'Redirection vers votre confirmation...';
            
            // WEBHOOK SENT WITH USERID
            try { fetch('https://hook.eu1.make.com/f4zgc3ikro4untwxsslktjd821htjlb5', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fullname: formData.fullname, name: formData.fullname.split(' ')[0], restaurant: restaurantName, restaurantId: formData.restaurant, date: formData.date, adultes: formData.guests, enfants: formData.enfants, phone: formData.phone, confirmation: confirmationNumber, videoId: videoId, source: 'LP1FinalDarkOptimized', userID: formData.userID, timestamp: new Date().toISOString() }) }).catch(err => console.log('Webhook sent')); } catch(err) {}
            
            if (typeof gtag !== 'undefined') { gtag('event', 'conversion', { 'send_to': 'AW-16808399607/conversion' }); }
            
            // REDIRECT WITH USERID
            const firstName = formData.fullname.split(' ')[0]; const redirectParams = new URLSearchParams({ fullname: formData.fullname, name: firstName, prenom: firstName, restaurant: restaurantName, etablissement: restaurantName, date: formData.date, adultes: formData.guests, enfants: formData.enfants, confirmation: confirmationNumber, videoId: videoId, userID: formData.userID });
            window.location.href = `https://mtszone.b-cdn.net/ty8.html?${redirectParams.toString()}`;
        }, 3800);
        setTimeout(() => { if(document.body.style.overflow === 'hidden') { window.location.href = `https://mtszone.b-cdn.net/ty8.html?fullname=${encodeURIComponent(formData.fullname)}&restaurant=${encodeURIComponent(restaurantName)}&userID=${formData.userID}`; } }, 6000);
    });

    const kidsToggleWrapper = document.getElementById('kidsToggleWrapper'); const kidsToggleContainer = document.getElementById('kidsToggleContainer'); const kidsSelectionPanel = document.getElementById('kidsSelectionPanel');
    const kidsValue = document.getElementById('kidsValue'); const kidsCountInput = document.getElementById('kidsCount'); const kidsDecrease = document.getElementById('kidsDecrease'); const kidsIncrease = document.getElementById('kidsIncrease'); const kidsCountBadge = document.getElementById('kidsCountBadge'); const toggleIndicatorText = document.getElementById('toggleIndicatorText'); const guestsSelect = document.getElementById('guests');
    let kidsCount = 0; let isKidsExpanded = false;
    guestsSelect.addEventListener('change', function() { if (this.value) { kidsToggleWrapper.classList.add('visible'); } });
    kidsToggleContainer.addEventListener('click', function(e) { 
        e.preventDefault(); 
        isKidsExpanded = !isKidsExpanded; 
        if (isKidsExpanded) { 
            kidsToggleContainer.classList.add('expanded'); 
            kidsSelectionPanel.classList.add('visible'); 
            toggleIndicatorText.textContent = 'Fermer'; 
            if (kidsCount === 0) { kidsCount = 1; updateKidsDisplay(); } 
        } else { 
            // CANCEL/COLLAPSE LOGIC
            kidsToggleContainer.classList.remove('expanded'); 
            kidsSelectionPanel.classList.remove('visible');
            // If they collapse it, we assume "mistake/cancel", so reset to 0
            kidsCount = 0; 
            updateKidsDisplay();
            toggleIndicatorText.textContent = 'Ajouter'; 
        } 
    });
    
    kidsIncrease.addEventListener('click', function(e) { e.stopPropagation(); if (kidsCount < 10) { kidsCount++; updateKidsDisplay(); animateValueBump(); } });
    
    kidsDecrease.addEventListener('click', function(e) { 
        e.stopPropagation(); 
        if (kidsCount > 0) { 
            kidsCount--; 
            updateKidsDisplay(); 
            animateValueBump(); 
            if (kidsCount === 0) { 
                isKidsExpanded = false; 
                kidsToggleContainer.classList.remove('expanded'); 
                kidsSelectionPanel.classList.remove('visible'); 
                toggleIndicatorText.textContent = 'Ajouter'; 
            } 
        } 
    });

    function updateKidsDisplay() { 
        kidsValue.textContent = kidsCount; 
        kidsCountInput.value = kidsCount; 
        // Logic change: Allow decrement to 0 to close section
        kidsDecrease.disabled = kidsCount <= 0; 
        kidsIncrease.disabled = kidsCount >= 10; 
        
        if (kidsCount > 0) { 
            kidsCountBadge.textContent = kidsCount; 
            kidsCountBadge.classList.add('visible'); 
        } else { 
            kidsCountBadge.classList.remove('visible'); 
        } 
        
        const label = document.querySelector('.kids-counter-label'); 
        if (label) label.textContent = kidsCount === 1 ? 'enfant' : 'enfants'; 
    }
    function animateValueBump() { kidsValue.classList.add('bump'); setTimeout(() => kidsValue.classList.remove('bump'), 300); }

    document.querySelectorAll('input, select').forEach(input => { input.addEventListener('focus', function() { const container = this.closest('.input-container'); if(container) container.classList.remove('error'); const group = this.closest('.form-group'); if(group) { const err = group.querySelector('.error-msg'); if(err) err.classList.remove('visible'); } }); });

    const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('active'); observer.unobserve(entry.target); } }); }, { threshold: 0, rootMargin: "0px 0px 250px 0px" });
    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    initTeaserEngine(); initEliteWhatsApp(); initFomoEngine(); initReviewBadgeTimer();
});

function scrollToForm(id) {
    const exp = experiencesData.find(e => e.id === id); if((exp && exp.soldOut) || AvailabilityEngine.isFullToday(id)) return;
    document.getElementById('restaurant').value = id; document.getElementById('heroFormContainer').scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => { const fullnameInput = document.getElementById('fullname'); if(!fullnameInput.value) fullnameInput.focus(); }, 600);
}

function filterExperiences(cat, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
    document.querySelectorAll('.spectacle-card').forEach(c => { const shouldShow = (cat === 'all' || c.dataset.categories.includes(cat)); c.style.display = shouldShow ? 'flex' : 'none'; });
}
function toggleAccordion(header) { const item = header.parentElement; const isOpen = item.classList.contains('open'); document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('open')); if (!isOpen) item.classList.add('open'); }
function initEliteWhatsApp() {
    const waBtn = document.getElementById('waSticky'); const waText = document.getElementById('waDynamicText'); const reviewsSection = document.getElementById('testimonialsSection'); const faqSection = document.getElementById('faq'); if (!waBtn || !reviewsSection) return;
    let isVisible = false; let ticking = false;
    const updateWidget = () => { const viewportHeight = window.innerHeight; const rReviews = reviewsSection.getBoundingClientRect(); const rFaq = faqSection ? faqSection.getBoundingClientRect() : { top: 99999 }; const hasReachedReviews = rReviews.top < (viewportHeight - 100); if (rFaq.top < (viewportHeight - 100)) { show("Une question ? <span class='wa-highlight'>Réponse < 1 min</span>"); } else if (hasReachedReviews) { show("Dernières tables : <span class='wa-highlight'>Disponibles</span>"); } else { hide(); } };
    const show = (htmlContent) => { if (!isVisible) { waBtn.classList.remove('ducked'); waBtn.classList.add('visible'); if (waText) waText.innerHTML = htmlContent; isVisible = true; } };
    const hide = () => { if (isVisible) { waBtn.classList.remove('visible'); waBtn.classList.add('ducked'); isVisible = false; } };
    window.addEventListener('scroll', () => { if (!ticking) { window.requestAnimationFrame(() => { updateWidget(); ticking = false; }); ticking = true; } }, { passive: true }); setTimeout(updateWidget, 500);
}
function initFomoEngine() {
    setInterval(() => {
        const indicators = document.querySelectorAll('.live-viewer-indicator'); if(indicators.length === 0) return;
        const target = indicators[Math.floor(Math.random() * indicators.length)]; let current = parseInt(target.getAttribute('data-viewers') || 8);
        const change = Math.floor(Math.random() * 5) - 2; if(change === 0) return; let newVal = current + change; if(newVal < 6) newVal = 6; if(newVal > 30) newVal = 30;
        target.setAttribute('data-viewers', newVal); const textSpan = target.querySelector('.viewer-text'); target.classList.remove('bump'); void target.offsetWidth; textSpan.textContent = `${newVal} personnes consultent`; target.classList.add('bump'); setTimeout(() => target.classList.remove('bump'), 400);
    }, 3500);
}
function initReviewBadgeTimer() {
    const reviewCards = document.querySelectorAll('.testimonial-card-new'); const badgeTimers = new Map();
    const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { const card = entry.target; const badge = card.querySelector('.story-badge-premium'); if (entry.isIntersecting && entry.intersectionRatio >= 0.6) { if (!badgeTimers.has(card)) { const timerId = setTimeout(() => { if(badge) badge.classList.add('visible'); }, 5000); badgeTimers.set(card, timerId); } } else { if (badgeTimers.has(card)) { clearTimeout(badgeTimers.get(card)); badgeTimers.delete(card); } if(badge) badge.classList.remove('visible'); } }); }, { threshold: 0.6 });
    reviewCards.forEach(card => observer.observe(card));
}

/* === OPTIMIZATION START: ELITE STORY MANAGER (WITH IMAGE PRELOAD) === */
window.StoryManager = {
    queue: [],
    currentIndex: 0,
    currentExp: null,
    timer: null,
    isPaused: false,
    isMuted: false, // Global mute state
    audioObj: new Audio(),
    currentVideoPlayer: null,
    imageDuration: 4000,
    hasUnlockedAudio: false,
    preloadedUrls: new Set(),

    // 1. Initialization & Smart Controls
    init: function() {
        this.audioObj.loop = false;
        this.audioObj.volume = 1.0;
        this.audioObj.preload = 'auto';

        // Nav Controls
        document.getElementById('storyNavLeft').addEventListener('click', (e) => { e.stopPropagation(); this.prev(); });
        document.getElementById('storyNavRight').addEventListener('click', (e) => { e.stopPropagation(); this.next(); });
        
        // === NEW HYBRID CENTER CONTROL (Tap to Toggle / Hold to Pause) ===
        const holdZone = document.getElementById('storyNavHold');
        let touchStartTime = 0;
        let wasPausedBeforeTouch = false;

        const handleStart = (e) => {
            // Allow default for scrolling unless we are in the overlay (overlay handles scroll lock)
            if(e.cancelable && e.target.id === 'storyNavHold') e.preventDefault(); 
            
            touchStartTime = Date.now();
            wasPausedBeforeTouch = this.isPaused;
            
            // Visual feedback: Pause immediately on touch down
            this.pause(); 
        };

        const handleEnd = (e) => {
            if(e.cancelable && e.target.id === 'storyNavHold') e.preventDefault();
            
            const duration = Date.now() - touchStartTime;
            const isTap = duration < 250; // Anything under 250ms is a tap

            if (isTap) {
                // LOGIC: If it was paused before we touched, RESUME.
                // If it was playing, we paused it in handleStart, so we leave it PAUSED.
                if (wasPausedBeforeTouch) {
                    this.resume();
                }
            } else {
                // HOLD LOGIC: Always resume when finger leaves screen
                this.resume();
            }
        };

        // Bind events with passive: false to control behavior accurately
        holdZone.addEventListener('mousedown', handleStart);
        holdZone.addEventListener('mouseup', handleEnd);
        holdZone.addEventListener('touchstart', handleStart, {passive: false});
        holdZone.addEventListener('touchend', handleEnd, {passive: false});

        // Global Mute Toggle
        document.getElementById('soundToggle').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMute();
        });

        document.getElementById('storyCloseBtn').addEventListener('click', () => this.close());
        const bookAction = () => { this.close(); scrollToForm(this.currentExp.id); };
        document.getElementById('storyBookBtn').addEventListener('click', bookAction);
        document.getElementById('climaxBtn').addEventListener('click', bookAction);

        // Silent Audio Unlocker (Primes the browser audio engine on first interaction)
        const unlockAudio = () => {
            if (this.hasUnlockedAudio) return;
            const p = this.audioObj.play();
            if (p !== undefined) {
                p.then(() => {
                    this.audioObj.pause();
                    this.audioObj.currentTime = 0;
                    this.hasUnlockedAudio = true;
                    ['click', 'touchstart', 'scroll'].forEach(evt => document.removeEventListener(evt, unlockAudio));
                }).catch(() => {});
            }
        };
        ['click', 'touchstart', 'scroll'].forEach(evt => document.addEventListener(evt, unlockAudio, { passive: true, once: true }));
    },

    // 2. Open Story
    open: function(id) {
        this.currentExp = (window.experiencesData || []).find(e => e.id === id);
        if(!this.currentExp) return;

        // Force Unlock if not done
        if(!this.hasUnlockedAudio) {
            this.audioObj.play().catch(()=>{}); 
            this.audioObj.pause();
            this.hasUnlockedAudio = true;
        }

        // UI Setup
        this.updateUI(this.currentExp);

        // Smart Duration Calculation based on Audio
        if(this.currentExp.audio) {
            this.audioObj.src = this.currentExp.audio;
            this.audioObj.onloadedmetadata = () => {
                const total = this.audioObj.duration;
                if(total > 10) {
                    const count = this.currentExp.gallery.length;

                    // 1. Reserve 15% (or min 5s) for the Climax Card at the end
                    const reservedForClimax = Math.max(5, total * 0.15);
                    
                    // 2. Subtract 15s buffer (This accounts for the Video Intro/Buildup)
                    const availableTime = total - reservedForClimax - 15; 
                    
                    // 3. Calculate exact duration per image to fit the remaining window
                    if(availableTime > 0 && count > 0) {
                        this.imageDuration = (availableTime / count) * 1000;
                        
                        // 4. Clamp between 2.5s and 6s
                        this.imageDuration = Math.max(2500, Math.min(6000, this.imageDuration));
                    }
                }
            };
        }

        // Build Queue
        this.queue = [];
        if(this.currentExp.video) this.queue.push({ type: 'video', src: this.currentExp.video });
        this.currentExp.gallery.forEach(img => this.queue.push({ type: 'image', src: img }));

        // Progress Bar
        const progContainer = document.getElementById('storyProgressBar');
        progContainer.innerHTML = '';
        this.queue.forEach(() => {
            const seg = document.createElement('div');
            seg.className = 'progress-segment';
            seg.innerHTML = '<div class="progress-fill"></div>';
            progContainer.appendChild(seg);
        });

        this.currentIndex = 0;
        this.isPaused = false;
        
        document.getElementById('storyOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        this.renderSlide();
    },

    // 3. Render Engine (Optimized)
    renderSlide: function() {
        const wrapper = document.getElementById('storyMediaWrapper');
        
        if(this.timer) clearTimeout(this.timer);
        this.timer = null;

        // Reset Progress Bars (Using Transform for GPU performance)
        const allFills = document.querySelectorAll('.progress-segment .progress-fill');
        allFills.forEach((fill, i) => {
            fill.style.transition = 'none';
            fill.style.transform = i < this.currentIndex ? 'scaleX(1)' : 'scaleX(0)';
        });

        if(this.currentIndex >= this.queue.length) {
            this.showClimax();
            return;
        }

        // --- OPTIMIZATION: PRELOAD NEXT IMAGE & CLIMAX (DAISY CHAIN) ---
        if(this.currentIndex + 1 < this.queue.length) {
            const next = this.queue[this.currentIndex + 1];
            if(next.type === 'image' && !this.preloadedUrls.has(next.src)) {
                const img = new Image();
                img.src = next.src;
                img.fetchPriority = "high";
                this.preloadedUrls.add(next.src);
            }
        } 
        else if (this.currentIndex === this.queue.length - 1 && this.currentExp.finalImage) {
            if(!this.preloadedUrls.has(this.currentExp.finalImage)) {
                const img = new Image();
                img.src = this.currentExp.finalImage;
                img.fetchPriority = "high";
                this.preloadedUrls.add(this.currentExp.finalImage);
            }
        }

        document.getElementById('climaxCard').classList.remove('active');
        document.getElementById('storyTextContent').classList.remove('hidden');

        const item = this.queue[this.currentIndex];
        const currentFill = allFills[this.currentIndex];
        
        // CLEANUP PREVIOUS SLIDE (Video stops here if playing)
        wrapper.innerHTML = ''; 
        this.currentVideoPlayer = null; 

        if(item.type === 'video') {
            this.playVideoSlide(item, wrapper, currentFill);
        } else {
            this.playImageSlide(item, wrapper, currentFill);
        }
    },

    // 4. Video Logic (FIXED FOR SOUND & PRELOAD)
    playVideoSlide: function(item, container, progressBar) {
        if(this.isMuted) {
             this.audioObj.pause();
        } else {
             // Fade out music to let video audio take over
             this.fadeAudio(0, 300, true);
        }

        // Check for preloaded iframe
        const expId = this.currentExp.id;
        const preloadedIframe = document.querySelector(`#video-preload-container iframe[data-id="${expId}"]`);
        
        let iframe;
        let isReused = false;

        if (preloadedIframe) {
            // === ELITE OPTIMIZATION: REUSE PRELOADED IFRAME ===
            iframe = preloadedIframe;
            
            // Move from preload container to story wrapper (Adoption)
            container.appendChild(iframe);
            
            // Reset visibility
            iframe.style.opacity = '1';
            iframe.classList.add('active');
            isReused = true;
        } else {
            // Fallback: Create new iframe
            iframe = document.createElement('iframe');
            const ts = new Date().getTime();
            
            let src = item.src;
            if(!src.includes('?')) src += '?';
            // Force muted=0 for immediate sound potential
            src += `&enablejsapi=1&autoplay=1&muted=0&playsinline=1&controls=0&modestbranding=1&ts=${ts}`;
            
            iframe.src = src;
            iframe.className = 'story-media-item active';
            iframe.allow = "autoplay; fullscreen; accelerometer; encrypted-media; gyroscope; picture-in-picture";
            iframe.setAttribute('loading', 'eager');
            
            container.appendChild(iframe);
        }

        const player = new playerjs.Player(iframe);
        this.currentVideoPlayer = player;

        // Logic to run when player is ready (or re-ready)
        const onPlayerReady = () => {
            if(!this.isMuted) {
                player.unmute();
                player.setVolume(100);
            }
            
            // CRITICAL: Ensure video starts from 0 (fixes "not starting from start")
            player.setCurrentTime(0);
            player.play();

            player.getDuration((d) => {
                const dur = d ? d : 15;
                progressBar.style.transition = `transform ${dur}s linear`;
                progressBar.style.transform = 'scaleX(1)';
            });
        };

        player.on('ready', onPlayerReady);
        
        // If reused, the player might already be 'ready' internally, but re-attaching listener is safe.
        // We can also optimistically call play/unmute if we suspect it's already loaded.
        if (isReused) {
             // Attempt immediate control in case event doesn't refire
             setTimeout(() => {
                 if(!this.isMuted) player.unmute();
                 player.setCurrentTime(0);
                 player.play();
             }, 50);
        }

        player.on('ended', () => {
            this.next();
        });
    },

    // 5. Image Logic
    playImageSlide: function(item, container, progressBar) {
        this.currentVideoPlayer = null;
        
        if(!this.isMuted && this.audioObj.paused) {
            this.audioObj.play().catch(()=>{});
            this.fadeAudio(1, 400);
        }

        const img = document.createElement('img');
        img.src = item.src;
        img.className = 'story-media-item';
        
        container.appendChild(img);
        
        requestAnimationFrame(() => requestAnimationFrame(() => img.classList.add('active')));

        setTimeout(() => {
            progressBar.style.transition = `transform ${this.imageDuration}ms linear`;
            progressBar.style.transform = 'scaleX(1)';
        }, 50);

        this.timer = setTimeout(() => this.next(), this.imageDuration);
    },

    // 6. Audio Fader
    fadeAudio: function(targetVol, duration, pauseAtEnd = false) {
        const startVol = this.audioObj.volume;
        const steps = 10;
        const interval = duration / steps;
        const stepAmount = (targetVol - startVol) / steps;
        
        let counter = 0;
        const fadeTimer = setInterval(() => {
            counter++;
            let newVol = this.audioObj.volume + stepAmount;
            if(newVol < 0) newVol = 0;
            if(newVol > 1) newVol = 1;
            this.audioObj.volume = newVol;

            if(counter >= steps) {
                clearInterval(fadeTimer);
                this.audioObj.volume = targetVol;
                if(pauseAtEnd) this.audioObj.pause();
            }
        }, interval);
    },

    // 7. Toggle Mute
    toggleMute: function() {
        this.isMuted = !this.isMuted;
        
        document.getElementById('iconMute').classList.toggle('hidden', !this.isMuted);
        document.getElementById('iconSound').classList.toggle('hidden', this.isMuted);

        if(this.isMuted) {
            this.fadeAudio(0, 200, true);
            if(this.currentVideoPlayer) this.currentVideoPlayer.mute();
        } else {
            // If watching video, unmute video. If image, play music.
            if(this.currentVideoPlayer) {
                this.currentVideoPlayer.unmute();
                this.currentVideoPlayer.setVolume(100);
            } else {
                this.audioObj.play().catch(()=>{});
                this.fadeAudio(1, 200);
            }
        }
    },

    // 8. Navigation & Controls
    pause: function() {
        this.isPaused = true;
        const fill = document.querySelectorAll('.progress-segment')[this.currentIndex].querySelector('.progress-fill');
        if(fill) {
            const computed = window.getComputedStyle(fill);
            const matrix = computed.transform; 
            fill.style.transition = 'none';
            fill.style.transform = matrix;
        }
        clearTimeout(this.timer);
        if(this.currentVideoPlayer) this.currentVideoPlayer.pause();
        if(!this.audioObj.paused) this.audioObj.pause();
    },

    resume: function() {
        if(!this.isPaused) return;
        this.isPaused = false;
        
        const item = this.queue[this.currentIndex];
        const fill = document.querySelectorAll('.progress-segment')[this.currentIndex].querySelector('.progress-fill');

        if(item.type === 'video') {
            if(this.currentVideoPlayer) {
                this.currentVideoPlayer.play();
                fill.style.transition = 'transform 10s linear'; 
                fill.style.transform = 'scaleX(1)';
            }
        } else {
            if(!this.isMuted) {
                this.audioObj.play().catch(()=>{});
                this.fadeAudio(1, 200);
            }
            fill.style.transition = `transform ${this.imageDuration}ms linear`;
            fill.style.transform = 'scaleX(1)';
            this.timer = setTimeout(() => this.next(), this.imageDuration);
        }
    },

    next: function() {
        if(this.currentIndex < this.queue.length) {
            this.currentIndex++;
            this.renderSlide();
        }
    },

    prev: function() {
        if(this.currentIndex > 0) {
            this.currentIndex--;
            this.renderSlide();
        }
    },

    showClimax: function() {
        if(!this.isMuted) {
            this.audioObj.play().catch(()=>{});
            this.fadeAudio(1, 300);
        }
        document.getElementById('storyTextContent').classList.add('hidden');
        document.getElementById('storyMediaWrapper').innerHTML = ''; 
        document.getElementById('climaxCard').classList.add('active');
    },

    updateUI: function(exp) {
        document.getElementById('storyBrandName').textContent = exp.name;
        document.getElementById('storyTitle').textContent = exp.name;
        document.getElementById('storyDesc').textContent = exp.description;
        document.getElementById('climaxTitle').textContent = exp.name;
        document.getElementById('climaxDesc').textContent = exp.description;
        
        const bgContainer = document.getElementById('climaxBgContainer');
        if(exp.finalImage) {
           bgContainer.style.backgroundImage = `url('${exp.finalImage}')`; 
        }
    },

    close: function() {
        this.fadeAudio(0, 200, true);
        
        // Immediate video stop
        if (this.currentVideoPlayer) {
            try { 
                this.currentVideoPlayer.pause(); 
                this.currentVideoPlayer.mute();
            } catch(e){}
        }

        document.getElementById('storyOverlay').classList.remove('show');
        
        setTimeout(() => {
            document.getElementById('storyMediaWrapper').innerHTML = '';
            document.body.style.overflow = '';
            this.audioObj.pause();
            this.audioObj.currentTime = 0;
            this.currentVideoPlayer = null;
            clearTimeout(this.timer);
            this.currentIndex = 0;
            this.queue = [];
        }, 300);
    }
};
/* === OPTIMIZATION END === */

StoryManager.init();

/* ============================================================================
   ELITE MENU ENGINE V18 - ULTRA-RELIABLE MOBILE-FIRST PDF VIEWER
   ============================================================================
   
   ARCHITECTURE OVERVIEW:
   This engine uses a multi-strategy approach with automatic failover to ensure
   PDFs always display on all devices (Android, iOS, Desktop).
   
   STRATEGY PRIORITY:
   1. Native PDF.js rendering (most reliable, works everywhere)
   2. Google Docs Viewer (fallback for complex PDFs)
   3. Direct link (ultimate fallback)
   
   MOBILE OPTIMIZATIONS:
   - Prevents blank gray screen by using visibility checks
   - Multiple retry mechanisms with exponential backoff
   - Touch-optimized scrolling with proper viewport handling
   - Memory-efficient cleanup on close
   
   ============================================================================ */

const MenuEngine = (() => {
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        // Timing
        INITIAL_LOAD_TIMEOUT: 1500,      // Show content after this (optimistic)
        RETRY_DELAY: 2000,                // Wait before retry
        MAX_RETRIES: 3,                   // Maximum retry attempts
        SAFETY_TIMEOUT: 4000,             // Show fallback link after this
        VISIBILITY_CHECK_INTERVAL: 500,  // Check if content visible
        VISIBILITY_CHECK_MAX: 10,        // Max visibility checks
        
        // Prefetch
        HOVER_PREFETCH_DELAY: 150,
        SCROLL_PRELOAD_MARGIN: '300px',
        
        // PDF.js CDN (Mozilla's official CDN - highly reliable)
        PDFJS_CDN: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174',
        
        // Google Docs Viewer
        GDOCS_VIEWER: 'https://docs.google.com/gview?embedded=true&url='
    };

    // ==================== STATE ====================
    const state = {
        isOpen: false,
        currentUrl: null,
        retryCount: 0,
        timers: new Set(),
        prefetchCache: new Map(),
        hoverTimers: new Map(),
        savedScrollY: 0,
        visibilityCheckCount: 0,
        currentStrategy: null,
        isDestroyed: false
    };

    // ==================== DEVICE DETECTION ====================
    const device = {
        isAndroid: /Android/i.test(navigator.userAgent),
        isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        isMobile: /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        
        get bestStrategy() {
            // iOS Safari has issues with Google Docs viewer
            if (this.isIOS && this.isSafari) return 'pdfjs';
            // Android Chrome works best with Google Docs
            if (this.isAndroid) return 'gdocs';
            // Desktop: try native first
            return 'pdfjs';
        }
    };

    // ==================== UTILITIES ====================
    const utils = {
        log(msg, data) {
            console.log(`[MenuV18] ${msg}`, data || '');
        },
        
        warn(msg, data) {
            console.warn(`[MenuV18] ${msg}`, data || '');
        },
        
        clearAllTimers() {
            state.timers.forEach(t => clearTimeout(t));
            state.timers.clear();
        },
        
        addTimer(callback, delay) {
            const timer = setTimeout(() => {
                state.timers.delete(timer);
                if (!state.isDestroyed) callback();
            }, delay);
            state.timers.add(timer);
            return timer;
        },
        
        // Ensure URL is properly encoded for viewers
        sanitizeUrl(url) {
            try {
                // If already encoded, decode first to avoid double encoding
                const decoded = decodeURIComponent(url);
                return encodeURIComponent(decoded);
            } catch {
                return encodeURIComponent(url);
            }
        }
    };

    // ==================== PRELOAD SYSTEM ====================
    const preload = {
        initScrollObserver() {
            if (!('IntersectionObserver' in window)) return;
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const btn = entry.target;
                    const url = this.extractUrl(btn);
                    if (url) {
                        this.preconnect(url);
                        observer.unobserve(btn);
                    }
                });
            }, { rootMargin: CONFIG.SCROLL_PRELOAD_MARGIN });
            
            document.querySelectorAll('.btn-menu').forEach(btn => observer.observe(btn));
        },
        
        initHoverPrefetch() {
            document.querySelectorAll('.btn-menu').forEach(btn => {
                const url = this.extractUrl(btn);
                if (!url) return;
                
                btn.addEventListener('mouseenter', () => {
                    const timer = setTimeout(() => {
                        this.prefetch(url);
                        state.hoverTimers.delete(btn);
                    }, CONFIG.HOVER_PREFETCH_DELAY);
                    state.hoverTimers.set(btn, timer);
                }, { passive: true });
                
                btn.addEventListener('mouseleave', () => {
                    const timer = state.hoverTimers.get(btn);
                    if (timer) {
                        clearTimeout(timer);
                        state.hoverTimers.delete(btn);
                    }
                }, { passive: true });
                
                btn.addEventListener('touchstart', () => {
                    this.prefetch(url);
                }, { passive: true, once: true });
            });
        },
        
        extractUrl(btn) {
            const onclick = btn.getAttribute('onclick');
            const match = onclick?.match(/openMenu\(['"]([^'"]+)['"]\)/);
            return match?.[1] || null;
        },
        
        preconnect(url) {
            try {
                const origin = new URL(url).origin;
                const id = `preconnect-${btoa(origin).slice(0, 10)}`;
                if (document.getElementById(id)) return;
                
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'preconnect';
                link.href = origin;
                link.crossOrigin = 'anonymous';
                document.head.appendChild(link);
                
                // Also preconnect to Google Docs
                if (!document.getElementById('preconnect-gdocs')) {
                    const gdocs = document.createElement('link');
                    gdocs.id = 'preconnect-gdocs';
                    gdocs.rel = 'preconnect';
                    gdocs.href = 'https://docs.google.com';
                    document.head.appendChild(gdocs);
                }
            } catch (e) {}
        },
        
        prefetch(url) {
            if (state.prefetchCache.has(url)) return;
            state.prefetchCache.set(url, 'loading');
            
            fetch(url, { 
                method: 'HEAD', 
                cache: 'force-cache', 
                mode: 'no-cors' 
            })
            .then(() => state.prefetchCache.set(url, 'ready'))
            .catch(() => state.prefetchCache.set(url, 'failed'));
        }
    };

    // ==================== UI SYSTEM ====================
    const ui = {
        showLoader(container, url) {
            container.innerHTML = `
                <div id="menuLoader" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
                    z-index: 100;
                ">
                    <div class="menu-spinner"></div>
                    <div class="loading-text" id="menuLoadingText">Ouverture de la carte...</div>
                    <div id="menuRetryInfo" style="
                        font-size: 0.7rem;
                        color: #999;
                        margin-top: 8px;
                        display: none;
                    "></div>
                    <a href="${url}" target="_blank" rel="noopener" class="fallback-btn" id="safetyLink" style="
                        display: none;
                        margin-top: 20px;
                        background: var(--brand-raspberry, #EC5075);
                        color: white;
                        padding: 14px 28px;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 700;
                        font-size: 0.9rem;
                        box-shadow: 0 4px 15px rgba(236, 80, 117, 0.3);
                        transition: transform 0.2s ease;
                    ">📄 Ouvrir directement</a>
                </div>`;
        },
        
        updateLoadingText(text) {
            const el = document.getElementById('menuLoadingText');
            if (el) el.textContent = text;
        },
        
        showRetryInfo(attempt, max) {
            const el = document.getElementById('menuRetryInfo');
            if (el) {
                el.style.display = 'block';
                el.textContent = `Tentative ${attempt}/${max}...`;
            }
        },
        
        showSafetyLink() {
            const link = document.getElementById('safetyLink');
            if (link) {
                link.style.display = 'inline-block';
                link.style.animation = 'fadeIn 0.3s ease';
            }
        },
        
        hideLoader() {
            const loader = document.getElementById('menuLoader');
            if (!loader) return;
            
            loader.style.transition = 'opacity 0.3s ease';
            loader.style.opacity = '0';
            loader.style.pointerEvents = 'none';
            
            utils.addTimer(() => {
                if (loader.parentNode) {
                    loader.remove();
                }
            }, 300);
        },
        
        showError(container, url, message) {
            container.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    padding: 20px;
                    text-align: center;
                    background: #f8f8f8;
                ">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                    <div style="font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 8px;">
                        ${message || 'Impossible de charger la carte'}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                        Cliquez ci-dessous pour l'ouvrir dans un nouvel onglet
                    </div>
                    <a href="${url}" target="_blank" rel="noopener" style="
                        background: var(--brand-raspberry, #EC5075);
                        color: white;
                        padding: 14px 28px;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 700;
                        font-size: 0.9rem;
                        box-shadow: 0 4px 15px rgba(236, 80, 117, 0.3);
                    ">📄 Voir la carte</a>
                </div>`;
        }
    };

    // ==================== RENDERING STRATEGIES ====================
    const strategies = {
        
        // STRATEGY 1: PDF.js Viewer (Most reliable for mobile)
        pdfjs(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying PDF.js strategy');
                state.currentStrategy = 'pdfjs';
                
                const iframe = document.createElement('iframe');
                // Use PDF.js viewer with the PDF URL
                const viewerUrl = `${CONFIG.PDFJS_CDN}/web/viewer.html?file=${encodeURIComponent(url)}`;
                
                iframe.src = viewerUrl;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                iframe.setAttribute('importance', 'high');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                let hasContent = false;
                
                const checkVisibility = () => {
                    if (loaded || state.isDestroyed) return;
                    
                    state.visibilityCheckCount++;
                    
                    try {
                        // Check if iframe has any visible content
                        const rect = iframe.getBoundingClientRect();
                        if (rect.width > 0 && rect.height > 0 && iframe.contentWindow) {
                            hasContent = true;
                        }
                    } catch (e) {
                        // Cross-origin, assume it's loading
                        hasContent = true;
                    }
                    
                    if (state.visibilityCheckCount >= CONFIG.VISIBILITY_CHECK_MAX) {
                        if (hasContent) {
                            loaded = true;
                            iframe.style.opacity = '1';
                            ui.hideLoader();
                            resolve();
                        } else {
                            reject(new Error('Content not visible'));
                        }
                    } else {
                        utils.addTimer(checkVisibility, CONFIG.VISIBILITY_CHECK_INTERVAL);
                    }
                };
                
                // Start visibility checks
                utils.addTimer(checkVisibility, CONFIG.VISIBILITY_CHECK_INTERVAL);
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    loaded = true;
                    iframe.style.opacity = '1';
                    ui.hideLoader();
                    resolve();
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('PDF.js iframe error'));
                };
            });
        },
        
        // STRATEGY 2: Google Docs Viewer (Good for Android)
        gdocs(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying Google Docs strategy');
                state.currentStrategy = 'gdocs';
                
                const iframe = document.createElement('iframe');
                iframe.src = `${CONFIG.GDOCS_VIEWER}${encodeURIComponent(url)}`;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                iframe.setAttribute('importance', 'high');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                let checkCount = 0;
                
                const checkContent = () => {
                    if (loaded || state.isDestroyed) return;
                    checkCount++;
                    
                    // After several checks, consider it loaded
                    if (checkCount >= 4) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                        return;
                    }
                    
                    utils.addTimer(checkContent, 500);
                };
                
                // Start checking
                utils.addTimer(checkContent, 500);
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    
                    // Extra delay for Google Docs to render content
                    utils.addTimer(() => {
                        if (!loaded && !state.isDestroyed) {
                            loaded = true;
                            iframe.style.opacity = '1';
                            ui.hideLoader();
                            resolve();
                        }
                    }, 300);
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('Google Docs iframe error'));
                };
            });
        },
        
        // STRATEGY 3: Direct PDF (Desktop browsers)
        direct(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying direct PDF strategy');
                state.currentStrategy = 'direct';
                
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    loaded = true;
                    iframe.style.opacity = '1';
                    ui.hideLoader();
                    resolve();
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('Direct iframe error'));
                };
            });
        },
        
        applyStyles(iframe) {
            iframe.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
                opacity: 0;
                transition: opacity 0.4s ease;
                background: #fff;
                z-index: 1;
                touch-action: pan-x pan-y;
                -webkit-overflow-scrolling: touch;
            `;
        }
    };

    // ==================== RENDER ORCHESTRATOR ====================
    const orchestrator = {
        async load(url, container) {
            const strategyOrder = this.getStrategyOrder();
            
            for (let i = 0; i < strategyOrder.length; i++) {
                const strategyName = strategyOrder[i];
                
                if (state.isDestroyed) return;
                
                // Clear previous attempt
                const existingIframe = container.querySelector('iframe');
                if (existingIframe) existingIframe.remove();
                
                // Reset visibility check counter
                state.visibilityCheckCount = 0;
                
                if (i > 0) {
                    ui.updateLoadingText('Changement de méthode...');
                    ui.showRetryInfo(i + 1, strategyOrder.length);
                }
                
                try {
                    await strategies[strategyName](url, container);
                    utils.log(`Success with ${strategyName}`);
                    return; // Success!
                } catch (error) {
                    utils.warn(`${strategyName} failed:`, error.message);
                    
                    if (i < strategyOrder.length - 1) {
                        // Wait before trying next strategy
                        await new Promise(r => utils.addTimer(r, 500));
                    }
                }
            }
            
            // All strategies failed
            utils.warn('All strategies failed, showing fallback');
            ui.showError(container, url, 'La carte n\'a pas pu être chargée');
        },
        
        getStrategyOrder() {
            const primary = device.bestStrategy;
            
            // Build fallback chain based on device
            if (device.isIOS) {
                return ['pdfjs', 'direct', 'gdocs'];
            } else if (device.isAndroid) {
                return ['gdocs', 'pdfjs', 'direct'];
            } else {
                // Desktop
                return ['direct', 'pdfjs', 'gdocs'];
            }
        }
    };

    // ==================== PUBLIC API ====================
    return {
        open(url) {
            if (!url) {
                utils.warn('No URL provided');
                return;
            }
            
            if (state.isOpen) {
                utils.log('Already open, ignoring');
                return;
            }
            
            state.isOpen = true;
            state.isDestroyed = false;
            state.currentUrl = url;
            state.retryCount = 0;
            state.visibilityCheckCount = 0;
            
            const modal = document.getElementById('menuModal');
            const container = document.getElementById('iframeContainer');
            
            if (!modal || !container) {
                utils.warn('Modal elements not found');
                state.isOpen = false;
                return;
            }
            
            utils.log('Opening menu', { url, device: device.bestStrategy });
            
            // 1. SAVE SCROLL POSITION & LOCK BODY
            state.savedScrollY = window.scrollY || window.pageYOffset || 0;
            
            // Use a more robust scroll lock
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.savedScrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            
            // Prevent iOS bounce
            if (device.isIOS) {
                document.body.style.height = '100%';
                document.documentElement.style.overflow = 'hidden';
            }
            
            // 2. SHOW MODAL
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            
            // Force reflow before adding active class
            modal.offsetHeight;
            
            requestAnimationFrame(() => {
                modal.classList.add('active');
            });
            
            // 3. SHOW LOADER & START LOADING
            ui.showLoader(container, url);
            
            // 4. Start loading with strategy orchestrator
            orchestrator.load(url, container);
            
            // 5. Show safety link after timeout
            utils.addTimer(() => {
                if (state.isOpen) {
                    ui.showSafetyLink();
                }
            }, CONFIG.SAFETY_TIMEOUT);
        },

        close() {
            if (!state.isOpen) return;
            
            utils.log('Closing menu');
            
            state.isOpen = false;
            state.isDestroyed = true;
            state.currentUrl = null;
            state.currentStrategy = null;
            
            // Clear all pending timers
            utils.clearAllTimers();
            
            const modal = document.getElementById('menuModal');
            const container = document.getElementById('iframeContainer');
            
            if (modal) {
                modal.classList.remove('active');
            }
            
            // Wait for animation to complete
            setTimeout(() => {
                if (modal) {
                    modal.style.display = 'none';
                    modal.style.visibility = 'hidden';
                }
                
                // Clean up container
                if (container) {
                    // Remove all iframes properly
                    const iframes = container.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        iframe.src = 'about:blank';
                        iframe.remove();
                    });
                    container.innerHTML = '';
                }
                
                // RESTORE SCROLL POSITION
                const scrollY = state.savedScrollY || 0;
                
                // Disable smooth scroll temporarily
                const htmlEl = document.documentElement;
                const originalScrollBehavior = htmlEl.style.scrollBehavior;
                htmlEl.style.scrollBehavior = 'auto';
                
                // Remove body lock
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.right = '';
                document.body.style.width = '';
                document.body.style.height = '';
                
                if (device.isIOS) {
                    htmlEl.style.overflow = '';
                }
                
                // Restore scroll position immediately
                window.scrollTo(0, scrollY);
                
                // Restore smooth scroll in next frame
                requestAnimationFrame(() => {
                    htmlEl.style.scrollBehavior = originalScrollBehavior || '';
                });
                
                state.savedScrollY = 0;
                
            }, 300);
        },

        init() {
            utils.log('Initializing MenuEngine V18');
            
            preload.initScrollObserver();
            preload.initHoverPrefetch();
            
            // Add click handler for modal background
            const modal = document.getElementById('menuModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.close();
                    }
                });
            }
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && state.isOpen) {
                    this.close();
                }
            });
            
            // Handle visibility change (close if tab hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && state.isOpen) {
                    // Keep open but pause any animations
                }
            });
            
            utils.log('MenuEngine V18 ready', { device: device.bestStrategy });
        }
    };
})();

// ==================== AUTO-INIT ====================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => MenuEngine.init());
} else {
    MenuEngine.init();
}

window.openMenu = (url) => MenuEngine.open(url);
window.closeMenu = () => MenuEngine.close();


const MAPBOX_TOKEN = 'pk.eyJ1IjoidnBzbW9lcm9ja3MiLCJhIjoiY21qaWY1czlsMHAzNzNnc2Nmc21qNXM3bSJ9.EWmJAoL7TH7Dx5mm_v7tIg';
let map = null; let mapMarker = null;
function openMapWidget(id, event) {
    if(event) event.stopPropagation(); const venue = VENUES[id]; if (!venue) return;
    const modal = document.getElementById('mapbox-modal'); document.body.style.overflow = 'hidden'; modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('active'); if (map) { setTimeout(() => { map.resize(); map.flyTo({ center: venue.coords, zoom: 15, duration: 1200 }); addMarker(venue.coords); }, 600); } }, 10);
    document.getElementById('v-name').textContent = venue.name; document.getElementById('v-address').textContent = venue.address;
    document.getElementById('v-wa-btn').href = `https://wa.me/212680802756?text=Bonjour Concierge, je suis intéressé par ${venue.name}. Pouvez-vous m'aider pour l'accès ou une navette ?`;
    if (!map) {
        mapboxgl.accessToken = MAPBOX_TOKEN;
        map = new mapboxgl.Map({ container: 'map-canvas', style: 'mapbox://styles/mapbox/dark-v11', center: venue.coords, zoom: 15, pitch: 45, antialias: true });
        const language = new MapboxLanguage({ defaultLanguage: 'fr' }); map.addControl(language);
        map.on('load', () => { map.resize(); addMarker(venue.coords); });
    }
}
function addMarker(coords) { if (mapMarker) mapMarker.remove(); const el = document.createElement('div'); el.className = 'venue-marker'; mapMarker = new mapboxgl.Marker(el).setLngLat(coords).addTo(map); }
function closeMapWidget() { const modal = document.getElementById('mapbox-modal'); modal.classList.remove('active'); document.body.style.overflow = ''; setTimeout(() => { modal.style.display = 'none'; }, 400); }
</script>

<!-- === VIDEO PRELOAD CONTAINER === -->
<div id="video-preload-container"></div>

</body>
</html>