<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- === META TAGS === -->
    <title>Dîner Spectacle Marrakech : Réservation VIP (Paiement Sur Place) | Top Spot</title>
    <meta name="description" content="Accès VIP aux 7 meilleurs restaurants festifs de Marrakech. Réservez votre table sans acompte ni carte bancaire. Confirmation WhatsApp 60s. Service Concierge Gratuit.">
    
    <!-- === PERFORMANCE: CRITICAL ASSETS PRIORITY === -->
    <link rel="preload" as="image" href="https://MTSpull.b-cdn.net/BG.jpg" fetchpriority="high">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fast.wistia.com">
    <link rel="preconnect" href="https://player.mediadelivery.net">
    <link rel="preconnect" href="https://SALAMZone1.b-cdn.net">
    <link rel="preconnect" href="https://MTSpull.b-cdn.net">
    <link rel="preconnect" href="https://MTSZone.b-cdn.net">
    <link rel="preconnect" href="https://docs.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://docs.google.com">
    <link rel="dns-prefetch" href="https://content.googleapis.com">
    <link rel="preconnect" href="https://content.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://MTSZone.b-cdn.net" crossorigin>

<!-- === WISTIA PERFORMANCE OPTIMIZATION (CORRECTED HD) === -->
<link rel="preconnect" href="https://fast.wistia.com">
<link rel="preconnect" href="https://fast.wistia.net">
<!-- Preload the TRUE HD Thumbnail (Direct ID Method) -->
<link rel="preload" as="image" href="https://fast.wistia.com/embed/medias/ds6i64qgoy.jpg?image_crop_resized=1920x1080" fetchpriority="high">

    <!-- BUNNY.NET PLAYER API -->
    <script src="https://assets.mediadelivery.net/playerjs/player-0.1.0.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;0,800;1,600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
<!-- === HOTJAR / CONTENTSQUARE === -->
    <script src="https://t.contentsquare.net/uxa/aa67b454a79ef.js"></script>

    <!-- === GOOGLE TAGS (GA4 + GOOGLE ADS) === -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YE8JYR1X97"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // 1. Google Analytics 4 Config
      gtag('config', 'G-YE8JYR1X97');

      // 2. Google Ads Config (Automatically tracks Page View)
      gtag('config', 'AW-16808399607');
    </script>

    <style>
        :root {
            /* === BRAND IDENTITY === */
            --brand-raspberry: #EC5075; 
            --brand-gradient: linear-gradient(135deg, #EC5075 0%, #C2185B 100%);
            --brand-gradient-hover: linear-gradient(135deg, #FF6B90 0%, #EC5075 100%);
            --brand-black: #111827; 
            
            /* UI COLORS */
            --bg-body: #F9FAFB; 
            --bg-card: #FFFFFF;
            --text-dark: #111827; 
            --text-body: #4B5563; 
            --text-muted: #9CA3AF;
            
            /* ANIMATION */
            --ease-luxury: cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* SHADOWS */
            --shadow-card: 0 10px 30px -10px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.02); 
            --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.05); 
            
            --radius-lg: 20px;
            --radius-xl: 32px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-body);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        body::after {
            content: ""; position: fixed; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 100%); 
            z-index: -1; pointer-events: none;
        }

        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; color: var(--text-dark); font-weight: 800; letter-spacing: -0.01em; }
        .hidden { display: none !important; }

        /* === SCROLL REVEAL === */
        .reveal { opacity: 0; transform: translateY(20px); transition: opacity 0.8s ease-out, transform 0.8s var(--ease-luxury); will-change: opacity, transform; }
        .reveal.active { opacity: 1; transform: translateY(0); }
        .reveal-delay-1 { transition-delay: 0.1s; }
        .reveal-delay-2 { transition-delay: 0.15s; }
        .reveal-delay-3 { transition-delay: 0.2s; }

        /* === HEADER === */
        header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 1rem 2rem; position: -webkit-sticky; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .header-container { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.3rem; font-weight: 900; color: var(--text-dark); font-family: 'Playfair Display', serif; text-transform: uppercase; letter-spacing: 0.5px; }
        .logo span { color: var(--brand-raspberry); }

        /* === HERO SECTION === */
        .hero {
            position: relative; text-align: center; min-height: 92vh;
            display: flex; align-items: center; justify-content: center;
            background-image: url('https://MTSpull.b-cdn.net/BG.jpg');
            background-size: cover; background-position: center center;
            overflow: hidden; padding: 4rem 1rem 2rem 1rem; 
        }
        
        .hero-content {
            position: relative; z-index: 2; max-width: 800px; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255, 255, 255, 0.94); 
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 1); 
            box-shadow: var(--shadow-glass), 0 30px 60px -15px rgba(0,0,0,0.12);
            border-radius: var(--radius-xl); padding: 3.5rem 2.5rem;
            animation: heroPop 1s var(--ease-spring);
        }
        @keyframes heroPop { 0% { opacity: 0; transform: scale(0.98) translateY(15px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        /* STATUS BAR */
        .status-bar-container {
            display: inline-flex;
            background: #F3F4F6;
            border-radius: 50px;
            padding: 4px;
            margin-bottom: 1.8rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .status-pill {
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex; align-items: center; gap: 6px;
        }
        .sp-vip {
            background: #fff; color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .sp-live {
            color: var(--brand-raspberry);
        }
        .live-dot { 
            width: 6px; height: 6px; background-color: var(--brand-raspberry); 
            border-radius: 50%; box-shadow: 0 0 0 0 rgba(236, 80, 117, 0.7);
            animation: livePulse 2s infinite; 
        }
        @keyframes livePulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(236, 80, 117, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 5px rgba(236, 80, 117, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(236, 80, 117, 0); }
        }

.hero h1 { 
    font-size: clamp(2.2rem, 5.5vw, 4.2rem); 
    line-height: 1.05; 
    margin-bottom: 1rem; 
    color: var(--text-dark); 
    letter-spacing: -0.03em; 
    font-weight: 750; /* This makes the headline bolder */
}

        .hero p.subtitle { 
            font-size: clamp(0.95rem, 1.8vw, 1.15rem); color: var(--text-body); 
            margin-bottom: 2.5rem; max-width: 600px; font-weight: 500; line-height: 1.6;
        }


/* ELITE ANCHOR FIX */
#experiences {
    scroll-margin-top: 50px; /* Adjusts for sticky header height + breathing room */
}

/* HYPE ENHANCEMENT: Subtle entrance animation for the section header */
.section-header h2 {
    background: linear-gradient(135deg, #111827 0%, #4B5563 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* === UPGRADED HERO HEADLINE STYLES === */

/* === ELITE MOBILE HEADLINE (Impact & Natural Flow) === */
/* === ELITE MOBILE HEADLINE (UNIFIED SIZE & COLOR RESTORATION) === */
@media (max-width: 768px) {
    /* 1. Unified Base Size for the whole sentence */
    .hero h1 { 
        font-size: 2.2rem !important; 
        line-height: 1.3 !important;
        padding: 0 5px;
    }
    
    /* 2. Force natural sentence flow */
    .headline-dynamic-wrapper {
        display: inline !important; 
        margin: 0;
    }
    
    /* 3. The Pink Text: Same Size + Color Fix */
/* === MERGED ELITE HEADLINE (Design + No Flicker) === */
    .hero h1 .text-highlight {
        /* --- 1. DESIGN (Your existing styling) --- */
        font-size: 1em !important;
        display: inline;
        vertical-align: baseline;
        
        background: var(--brand-gradient) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        
        font-style: italic;
        font-weight: 800;
        white-space: normal;

        /* --- 2. ANTI-FLICKER (The new magic) --- */
        opacity: 0; /* Starts hidden so user doesn't see the wrong word */
        transition: opacity 0.2s ease-in; /* Fades in smoothly */
    }

    /* This class is added by the JS once the correct word is inserted */
    .hero h1 .text-highlight.ready {
        opacity: 1 !important;
    }
    
    /* 4. The Number '7': Same Size + Alignment */
    .hero h1 .number-highlight {
        display: inline;
        font-size: 1em !important; /* Same size as text */
        transform: none !important; /* Remove desktop offset */
    }
}

/* === WORLD-CLASS SOCIAL PROOF SECTION (V2 - REFINED) === */

/* Main wrapper with reduced vertical gap for a tighter, more connected look */
.social-proof-wrapper {
    display: flex;
    flex-direction: column; 
    text-align: center; 
    gap: 2rem; /* REDUCED: From 2.5rem to tighten the vertical space */
}

/* Headline (H2) is now smaller with a more elegant line-height */
.proof-text-content h2 {
    font-size: clamp(2rem, 4.5vw, 2.8rem); /* REDUCED: For a more premium, less overpowering look */
    line-height: 1.25; /* ADJUSTED: Gives the refined text more breathing room */
    margin-bottom: 1rem;
    color: var(--text-dark);
    background: none;
   -webkit-text-fill-color: inherit;
}

/* Highlighted word style (no changes) */
.proof-text-content h2 .highlight-pink {
    font-style: italic;
    background: var(--brand-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Paragraph style (no changes) */
.proof-text-content p {
    font-size: 1.1rem;
    color: var(--text-body);
    max-width: 550px;
    margin: 0 auto;
}

/* Authority title style (no changes) */
.authority-title {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.7rem;
    font-weight: 800;
    color: var(--text-muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 1rem;
}

/* Badge stack style (no changes) */
.authority-badges-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

/* Badge appearance (no changes) */
.authority-badge {
    border: 1px solid #E5E7EB;
    background: #FFFFFF;
    box-shadow: 0 5px 15px rgba(0,0,0,0.04);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.authority-badge:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

/* === DESKTOP LAYOUT REFINEMENTS === */
@media (min-width: 768px) {
    .social-proof-wrapper {
        flex-direction: row; 
        text-align: left; 
        align-items: center;
        gap: 2.5rem; /* REDUCED: Tightens the space between the two columns */
    }

    .proof-text-content {
        flex: 1;
    }

    .proof-text-content p {
        margin: 0;
    }
    
    .proof-authority-content {
        flex-shrink: 0; 
        padding-left: 2.5rem; /* REDUCED: Narrows the space next to the separator line */
        border-left: 2px solid #F3F4F6;
    }

    .authority-badges-stack {
        align-items: flex-start;
    }
}

/* === WORLD CLASS VIDEO CONTAINER === */
.wistia-video-container { 
    width: 100%; 
    max-width: 600px; 
    margin: 0 auto 2rem; 
    border-radius: 24px; 
    
    /* PREMIUM DEPTH */
    box-shadow: 
        0 20px 50px -10px rgba(0,0,0,0.3),
        0 10px 20px -5px rgba(0,0,0,0.1);
        
    position: relative; 
    aspect-ratio: 16/9; 
    background-color: #000; 
    border: 4px solid #ffffff; 
    cursor: pointer; 
    
    /* IOS CLIP FIX */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    overflow: hidden;
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.4s ease; 
}

.wistia-video-container:hover { 
    transform: scale(1.02) translateY(-5px); 
    box-shadow: 0 30px 60px -12px rgba(236, 80, 117, 0.25);
    border-color: #fff; 
}

.video-click-layer {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 20; background: transparent;
}

.video-sound-badge {
    position: absolute; bottom: 15px; right: 15px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    color: white;
    padding: 6px 14px;
    border-radius: 50px;
    font-size: 0.7rem; font-weight: 800; letter-spacing: 0.5px;
    display: flex; align-items: center; gap: 8px;
    z-index: 15; pointer-events: none;
    border: 1px solid rgba(255,255,255,0.15);
    
    /* Smooth Transition for Hiding */
    transition: opacity 0.4s ease, transform 0.4s ease;
    opacity: 1;
    transform: translateY(0);
}

/* STATE: Hidden (When sound is playing) */
.video-sound-badge.badge-hidden {
    opacity: 0;
    transform: translateY(10px);
}


        .cta-primary, .form-button { 
            position: relative; background: var(--brand-gradient); 
            color: #fff; border: none; padding: 1.3rem 3.5rem; 
            font-size: 1rem; font-weight: 800; border-radius: 100px; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; 
            box-shadow: 0 15px 35px rgba(236, 80, 117, 0.35); 
            transition: all 0.3s var(--ease-luxury); overflow: hidden; 
            z-index: 1; display: inline-block; width: auto; 
        }
        .form-button { width: 100%; }
        /* Shimmer Effect on Button */
        .cta-primary::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.25), transparent);
            transform: skewX(-25deg); animation: btnShimmer 3s infinite; pointer-events: none;
        }
        @keyframes btnShimmer { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
        
        .cta-primary:hover, .form-button:hover { transform: translateY(-3px); box-shadow: 0 20px 50px rgba(236, 80, 117, 0.5); }

        .hero-subtext { 
            margin-top: 1.2rem; font-size: 0.8rem; color: var(--text-muted); 
            font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; justify-content: center; gap: 5px; 
        }
        .hero-subtext svg { width: 14px; height: 14px; color: var(--brand-raspberry); animation: bounceArrow 1.5s infinite ease-in-out; }
        @keyframes bounceArrow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(3px); } }

        /* HERO FOOTER GRID */
        .hero-cta-support { 
            margin-top: 2.2rem; width: 100%; display: flex; gap: 1rem; 
            justify-content: center; flex-wrap: wrap; 
        }
        .hcs-item { 
            font-size: 0.7rem; color: var(--text-dark); font-weight: 800; 
            letter-spacing: 0.5px; text-transform: uppercase;
            display: flex; align-items: center; gap: 8px; 
            background: #FAFAFA; padding: 10px 18px; 
            border-radius: 8px; border: 1px solid rgba(0,0,0,0.04);
        }
        .hcs-item svg { color: var(--brand-raspberry); width: 14px; height: 14px; stroke-width: 2.5px; }

        .trust-bar { padding: 2rem 1.5rem; background: #fff; border-bottom: 1px solid rgba(0,0,0,0.03); position: relative; z-index: 3; margin-bottom: 1rem; }
        .trust-container { max-width: 1100px; margin: 0 auto; display: flex; justify-content: center; flex-wrap: wrap; gap: 3rem; }
        .trust-element { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; text-align: center; font-weight: 600; }
        .trust-element strong { color: var(--text-dark); font-weight: 900; font-size: 1.2rem; display: block; margin-bottom: 2px; font-family: 'Playfair Display'; }

        /* SECTIONS & FILTERS */
        .section { max-width: 1100px; margin: 0 auto; padding: 5rem 2rem; position: relative; z-index: 2; }
        .section-header { text-align: center; margin-bottom: 3rem; max-width: 700px; margin: 0 auto; }
        .section-header h2 { font-size: clamp(2rem, 4vw, 3.2rem); line-height: 1.15; margin-bottom: 1rem; font-weight: 800; letter-spacing: -0.02em; }
        .section-header p { font-size: 1.05rem; color: var(--text-body); max-width: 550px; margin: 0 auto 2.5rem auto; }
        
        #explore-anchor { position:relative; top: -100px; visibility:hidden; }

        .filters { display: flex; justify-content: center; gap: 0.6rem; margin-bottom: 2.5rem; flex-wrap: wrap; }
        .filter-btn { padding: 0.8rem 1.8rem; border: 1px solid rgba(0,0,0,0.06); background: #fff; color: var(--text-body); border-radius: 100px; cursor: pointer; font-size: 0.75rem; font-weight: 700; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .filter-btn:hover, .filter-btn.active { background: var(--brand-black); color: #fff; border-color: var(--brand-black); box-shadow: 0 5px 15px rgba(0,0,0,0.1); transform: translateY(-1px); }

        /* CARDS */
        .spectacles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 2.5rem; }
        .spectacle-card { background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid rgba(0,0,0,0.04); transition: transform 0.6s var(--ease-luxury), box-shadow 0.6s var(--ease-luxury); display: flex; flex-direction: column; position: relative; box-shadow: var(--shadow-card); min-height: 480px; }
        .spectacle-card:hover { transform: translateY(-5px) translateZ(0); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.08); }

        .card-image { width: 100%; height: 240px; overflow: hidden; position: relative; aspect-ratio: 4/3; background-color: #f0f0f0; cursor: pointer; z-index: 1;}
        .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s ease; will-change: transform; }
        .spectacle-card:hover .card-image img { transform: scale(1.05); }
        .card-image-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity .4s ease; backdrop-filter: blur(2px); background: rgba(0,0,0,0); /* Start transparent */
    transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    backdrop-filter: blur(0px);}

.card-image-overlay svg {
    /* Base state of the play icon */
    transform: scale(0.8);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
}

/* 2. THE TEASER STATE (Triggered by JS after 2s) */
.spectacle-card.teaser-active .card-image img {
    transform: scale(1.08); /* Slow zoom in */
    filter: brightness(0.7) blur(2px); /* Dim and blur to focus on button */
    transition: transform 3s ease, filter 0.8s ease;
}

.spectacle-card.teaser-active .card-image-overlay {
    background: rgba(0,0,0,0.2); /* Slight darkening */
    opacity: 1;
}

/* The Play Button Pop */
.spectacle-card.teaser-active .card-image-overlay svg {
    opacity: 1;
    transform: scale(1.2); /* Pop larger */
    animation: heartbeat 1.5s infinite; /* Engaging pulse */
    color: #fff;
    fill: rgba(255,255,255,0.2); /* Semi-transparent fill */
}

/* 3. The "Hypnotic Ripple" (The Click-Bait Factor) */
.spectacle-card.teaser-active .card-image-overlay::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 60px; height: 60px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
    animation: rippleOut 2s infinite;
    z-index: -1; /* Behind the play icon */
    pointer-events: none;
}

.spectacle-card.teaser-active .card-image-overlay::after {
    content: 'VOIR L\'AMBIANCE'; /* Explicit Call To Action */
    position: absolute;
    top: 65%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    color: #fff;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 2px;
    opacity: 0;
    animation: slideUpFade 0.6s forwards 0.3s; /* Delayed appearance */
}

/* === KEYFRAMES === */
@keyframes heartbeat {
    0% { transform: scale(1.1); }
    15% { transform: scale(1.25); } /* Big bump */
    30% { transform: scale(1.1); }
    45% { transform: scale(1.25); } /* Small bump */
    100% { transform: scale(1.1); }
}

@keyframes rippleOut {
    0% { width: 0px; height: 0px; opacity: 0.8; border-width: 4px; }
    100% { width: 200px; height: 200px; opacity: 0; border-width: 0px; }
}

@keyframes slideUpFade {
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

        .spectacle-card:hover .card-image-overlay { opacity:1; }
        .card-image-overlay svg { color: white; transform: scale(0.95); transition: transform 0.4s var(--ease-luxury); }
        .spectacle-card:hover .card-image-overlay svg { transform: scale(1); }
        
        /* NEW HEARTBEAT ANIMATION */
        @keyframes badgePulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
            10% { transform: scale(1.05); box-shadow: 0 0 10px rgba(255,255,255,0.2); }
            20% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
            30% { transform: scale(1.05); box-shadow: 0 0 10px rgba(255,255,255,0.2); }
            40% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
        }

        .media-badge { 
            position: absolute; bottom: 12px; right: 12px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.15); pointer-events: none; 
            animation: badgePulse 3s infinite ease-in-out; /* UPGRADE: Pulse Animation */
        }
        .media-badge svg { width: 10px; height: 10px; fill: white; animation: playPulse 3s infinite; }
        .spectacle-type-badge { position: absolute; top: 12px; left: 12px; background: #fff; color: var(--text-dark); padding: 6px 12px; border-radius: 50px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .popular-badge { position: absolute; top: 12px; right: 12px; z-index: 2; width: 32px; height: 32px; background:var(--brand-raspberry); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(236,80,117,0.4); }
        .popular-badge svg { width:16px; height:16px; stroke:white; }

        .card-content { padding: 1.8rem; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.4rem; line-height: 1.2; margin-bottom: 0.4rem; color: var(--text-dark); }
        .card-rating { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.8rem; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
        .stars { color: #FBBF24; }
        .card-description { margin-bottom: 1.2rem; flex-grow: 1; color: var(--text-body); font-size: 0.9rem; line-height: 1.6; }
        
        .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-dark); font-weight: 700; margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); }

/* === REFINED LOCATION BADGE (Fixed & Restored) === */
/* === REFINED LOCATION BADGE (Restored from V161 + Fixed) === */
.price-range { 
    /* Typography */
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.65rem; 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    line-height: 1;
    color: var(--brand-raspberry);
    
    /* Structure - Outline Style */
    background: transparent; 
    border: 1px solid var(--brand-raspberry);
    padding: 5px 10px;
    border-radius: 50px; 
    
    /* Alignment */
    display: inline-flex;
    align-items: center;
    gap: 5px; 
    
    /* Interaction */
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    cursor: pointer;
    text-decoration: none;
}

/* Map Pin Icon - EXACT COPY FROM V161 */
.price-range::before {
    content: '';
    display: block;
    width: 10px; 
    height: 10px;
    
    /* CRITICAL FIX: Prevents the icon from being squashed to 0px */
    min-width: 10px; 
    flex-shrink: 0;

    /* The Working SVG from V161 */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23EC5075' stroke='%23EC5075' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='white'%3E%3C/circle%3E%3C/svg%3E");
    
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}

/* Hover Effect: Fills with Pink, Text turns White */
.price-range:hover {
    background: var(--brand-raspberry);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(236, 80, 117, 0.2);
}

/* Hover Effect: Icon turns White */
.price-range:hover::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='%23EC5075'%3E%3C/circle%3E%3C/svg%3E");
}

/* === ELITE PROCESSING OVERLAY STYLES (V7 - THE SANCTUARY) === */
.processing-overlay {
    position: fixed;
    top: 0; left: 0; 
    width: 100vw; 
    height: 100vh;
    height: 100dvh; /* Mobile browser optimization */
    z-index: 2147483647; /* Max Z-Index possible */
    display: flex; align-items: center; justify-content: center;
    background: #fffefe; /* Solid background hides the site */
    opacity: 0; 
    pointer-events: none; /* Allows clicks through when hidden */
    transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Active State applied via JS */
.processing-overlay.active {
    opacity: 1;
    pointer-events: all; /* Blocks interaction with background */
}

/* The Container: 85% x 85% Centered Sanctuary */
.processing-content {
    position: relative;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    
    /* PRECISE DIMENSIONS */
    width: 85%;
    height: 85%;
    max-width: 500px; /* Cap width for desktop elegance */
    max-height: 700px; /* Cap height for desktop elegance */
    
    background: #FFFFFF;
    border-radius: 40px;
    
    /* The "Levitation" Shadow */
    box-shadow: 
        0 40px 100px -20px rgba(0,0,0,0.08),
        0 0 0 1px rgba(0,0,0,0.03);
        
    transform: scale(0.92);
    transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1);
}

.processing-overlay.active .processing-content {
    transform: scale(1);
}

/* --- THE VISUAL ELEMENTS --- */

/* 1. Breathing Icon */
.pulse-container {
    position: relative; width: 100px; height: 100px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 3rem;
}

.brand-icon {
    position: relative; z-index: 10;
    width: 64px; height: 64px;
    background: var(--brand-gradient);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 20px 50px rgba(236, 80, 117, 0.35);
    animation: iconBreath 4s ease-in-out infinite;
}

@keyframes iconBreath {
    0%, 100% { transform: scale(1); box-shadow: 0 20px 50px rgba(236, 80, 117, 0.35); }
    50% { transform: scale(1.03); box-shadow: 0 25px 60px rgba(236, 80, 117, 0.25); }
}

.pulse-ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid var(--brand-raspberry);
    opacity: 0;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100%; height: 100%;
}

.ring-1 { animation: zenRipple 3.5s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94); animation-delay: 0s; }
.ring-2 { animation: zenRipple 3.5s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94); animation-delay: 1.2s; }

@keyframes zenRipple {
    0% { width: 100%; height: 100%; opacity: 0.3; border-width: 1px; }
    100% { width: 350%; height: 350%; opacity: 0; border-width: 0px; }
}

/* 2. Typography */
.processing-title {
    font-family: 'Playfair Display', serif;
    font-size: 2rem; /* Large and confident */
    color: var(--text-dark);
    margin-bottom: 1rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    text-align: center;
}

.status-track {
    height: 30px; 
    width: 100%;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 4rem; /* Lots of breathing room */
}

/* 3. The Animated Text */
.processing-text {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.7rem; 
    color: #9CA3AF;
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 3px; 
    white-space: nowrap;
    
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
    transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* Animation States */
.text-hidden { opacity: 0; transform: translateY(15px); filter: blur(5px); }
.text-visible { opacity: 1; transform: translateY(0); filter: blur(0); }

/* 4. Progress Bar */
.processing-progress {
    width: 60px; height: 4px;
    background: #F3F4F6;
    border-radius: 100px; overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    position: absolute; top: 0; left: 0; height: 100%;
    background: var(--brand-gradient);
    width: 0%;
    border-radius: 100px;
    animation: progressFill 10s cubic-bezier(0.22, 1, 0.36, 1) forwards; 
}

@keyframes progressFill {
    0% { width: 0%; }
    30% { width: 25%; } 
    70% { width: 65%; } 
    100% { width: 100%; } 
}


/* Map Pin Icon */
/* === REFINED LOCATION BADGE (Restored from V161 + Fixed) === */
.price-range { 
    /* Typography */
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.65rem; 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    line-height: 1;
    color: var(--brand-raspberry);
    
    /* Structure - Outline Style */
    background: transparent; 
    border: 1px solid var(--brand-raspberry);
    padding: 5px 10px;
    border-radius: 50px; 
    
    /* Alignment */
    display: inline-flex;
    align-items: center;
    gap: 5px; 
    
    /* Interaction */
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    cursor: pointer;
    text-decoration: none;
}

/* Map Pin Icon - EXACT COPY FROM V161 */
.price-range::before {
    content: '';
    display: block;
    width: 10px; 
    height: 10px;
    
    /* CRITICAL FIX: Prevents the icon from being squashed to 0px */
    min-width: 10px; 
    flex-shrink: 0;

    /* The Working SVG from V161 */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23EC5075' stroke='%23EC5075' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='white'%3E%3C/circle%3E%3C/svg%3E");
    
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
}

/* Hover Effect: Fills with Pink, Text turns White */
.price-range:hover {
    background: var(--brand-raspberry);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(236, 80, 117, 0.2);
}

/* Hover Effect: Icon turns White */
.price-range:hover::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3' fill='%23EC5075'%3E%3C/circle%3E%3C/svg%3E");
}
        .trust-box { background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 10px; padding: 8px 12px; margin-bottom: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.7rem; color: #374151; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
        .trust-box svg { color: #10B981; fill: rgba(16, 185, 129, 0.1); stroke-width: 2px; }

        .card-actions-container { display: grid; grid-template-columns: 1fr 1.4fr; gap: 10px; margin-top: auto; }
        .card-btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; transition: all 0.2s var(--ease-spring); text-decoration: none; text-align: center; }
        .btn-menu { background: #fff; color: var(--text-dark); border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-menu:hover { border-color: #D1D5DB; background: #F9FAFB; transform: translateY(-1px); }
        .btn-book { background: var(--brand-gradient); color: white; border: none; box-shadow: 0 4px 12px rgba(236, 80, 117, 0.2); }
        .btn-book:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(236, 80, 117, 0.3); }

        /* === STORY OVERLAY === */
/* === V25 ULTIMATE STORY OVERLAY (OPTIMIZED CSS) === */
.story-overlay {
    position: fixed; top: 0; left: 0; 
    width: 100%; height: 100%; height: 100dvh;
    background: #000; z-index: 9999; 
    display: none; align-items: center; justify-content: center;
    opacity: 0; 
    transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
    /* PERFORMANCE: Promote to GPU layer */
    will-change: opacity;
    transform: translateZ(0);
}
.story-overlay.show { 
    display: flex; 
    opacity: 1; 
}

.story-container { 
    width: 100%; height: 100%; height: 100dvh; 
    position: relative; overflow: hidden; background: #000; 
    /* PERFORMANCE: Fix for sub-pixel rendering jitter */
    backface-visibility: hidden;
    -webkit-font-smoothing: antialiased;
}

@media(min-width: 768px) {
    .story-container { 
        width: 450px; height: 90vh; 
        border-radius: 20px; 
        box-shadow: 0 0 50px rgba(0,0,0,0.8); 
        /* PERFORMANCE: Fix Safari border-radius clipping on videos */
        transform: translateZ(0); 
        -webkit-mask-image: -webkit-radial-gradient(white, black);
        mask-image: radial-gradient(white, black);
    }
}

.story-media-wrapper { 
    width: 100%; height: 100%; 
    position: relative; background: #000; z-index: 1; 
    overflow: hidden;
}

.story-media-item { 
    width: 100%; height: 100%; 
    object-fit: cover; object-position: center center;
    position: absolute; top: 0; left: 0; 
    opacity: 0; 
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    /* PERFORMANCE: Inform browser of change to prevent repaint */
    will-change: opacity;
}

.story-media-item.active { 
    opacity: 1; z-index: 1; 
}

.story-media-item img {
    width: 100%; height: 100%; 
    object-fit: cover; object-position: center center;
    display: block;
}

.story-media-item iframe {
    width: 100%; height: 100%; 
    border: none; display: block;
}

/* UI LAYER */
.story-ui-top {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 15px 15px 30px 15px; 
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
    z-index: 300; pointer-events: none; 
}

/* PERFORMANCE: Progress Bar Optimized for Scale instead of Width */
.story-progress-bar { 
    display: flex; gap: 4px; height: 2px; 
    margin-bottom: 12px; pointer-events: auto; 
    transform: translateZ(0);
}
.progress-segment { 
    flex: 1; background: rgba(255,255,255,0.3); 
    border-radius: 2px; overflow: hidden; height: 2px; 
}
.progress-fill { 
    width: 100%; height: 100%; 
    background: #fff; 
    transform-origin: left; 
    transform: scaleX(0); /* Start at 0 */
    will-change: transform;
}

.story-controls-row { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }

.story-brand { 
    color: #fff; font-size: 0.8rem; font-weight: 700; 
    opacity: 0.95; text-transform: uppercase; letter-spacing: 1px; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
}

.story-actions { display: flex; gap: 10px; align-items: center; pointer-events: auto; }

.story-icon { 
    width: 32px; height: 32px; 
    display: flex; align-items: center; justify-content: center; 
    color: #fff; cursor: pointer; 
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); 
    opacity: 0.95; transition: transform 0.2s; 
}
.story-icon svg { width: 24px; height: 24px; stroke-width: 2px; }
.story-icon:hover { transform: scale(1.1); }

.story-nav-zone { position: absolute; top: 0; bottom: 0; z-index: 40; height: 100%; }
.nav-left { left: 0; width: 30%; }
.nav-right { right: 0; width: 30%; }
.nav-center { left: 30%; width: 40%; } 

.story-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 90px 20px 36px; z-index: 50;
    background: linear-gradient(to top, rgba(0,0,0,0.92) 12%, rgba(0,0,0,0.55) 48%, transparent 100%);
    text-align: center; display: flex; flex-direction: column; align-items: center;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    /* PERFORMANCE */
    will-change: transform, opacity;
}

.story-footer.hidden { transform: translateY(50px); opacity: 0; }

.story-title-text { 
    color: #fff; font-family: 'Playfair Display'; font-size: 1.4rem; 
    margin-bottom: 10px; font-weight: 700; 
    text-shadow: 0 2px 12px rgba(0,0,0,0.85), 0 1px 3px rgba(0,0,0,0.5); 
    letter-spacing: -0.02em;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s;
}
.story-footer:not(.hidden) .story-title-text {
    opacity: 1; transform: translateY(0);
}

.story-desc-text { 
    color: rgba(255,255,255,0.96); font-size: 0.8rem; 
    margin-bottom: 24px; font-weight: 500; 
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
    text-shadow: 0 2px 8px rgba(0,0,0,0.75), 0 1px 2px rgba(0,0,0,0.4); 
    max-width: 90%; line-height: 1.5; 
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s;
}
.story-footer:not(.hidden) .story-desc-text {
    opacity: 1; transform: translateY(0);
}

.story-cta-btn { 
    background: #fff; color: #000; border: none; font-weight: 800; 
    padding: 13px 32px; border-radius: 50px; width: 100%; max-width: 300px; 
    font-size: 0.85rem; cursor: pointer; 
    box-shadow: 0 6px 28px rgba(255,255,255,0.18), 0 2px 8px rgba(0,0,0,0.1); 
    text-transform: uppercase; letter-spacing: 1.5px; 
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), 
                box-shadow 0.3s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s;
    opacity: 0;
    transform: translateY(8px) scale(0.98);
}
.story-footer:not(.hidden) .story-cta-btn {
    opacity: 1; transform: translateY(0) scale(1);
}
.story-cta-btn:hover { 
    transform: translateY(-1px) scale(1.01); 
    box-shadow: 0 8px 32px rgba(255,255,255,0.22), 0 4px 12px rgba(0,0,0,0.12);
}
.story-cta-btn:active { transform: translateY(0) scale(0.99); }

.story-trust { 
    color: #fff; font-size: 0.75rem; margin-top: 18px; 
    opacity: 0; display: flex; align-items: center; justify-content: center; 
    gap: 6px; font-weight: 600; 
    text-shadow: 0 2px 6px rgba(0,0,0,0.7), 0 1px 2px rgba(0,0,0,0.4); 
    transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.4s, transform 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.4s;
    transform: translateY(6px);
}
.story-footer:not(.hidden) .story-trust {
    opacity: 0.92; transform: translateY(0);
}

/* === CLIMAX CARD (WORLD CLASS PREMIUM ANIMATION) === */
.climax-phantom-layer { 
    position: absolute; inset: 0; width: 100%; height: 100%; 
    background-size: cover; background-position: center center; 
    background-repeat: no-repeat; z-index: 0; 
    transform: scale(1.0); will-change: transform; 
    transition: transform 14s cubic-bezier(0.19, 1, 0.22, 1);
}
@media (max-width: 768px) {
    .climax-phantom-layer {
        background-size: cover !important;
        background-position: center center !important;
    }
}
.story-climax-card { 
    position: absolute; top:0; left:0; width:100%; height:100%; 
    z-index: 100; pointer-events: none; display: flex; flex-direction: column; 
    justify-content: flex-end; padding-bottom: 72px; background: transparent; 
    opacity: 0; transition: opacity 1.4s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; 
}
.story-climax-card.active { opacity: 1; pointer-events: auto; }

/* PREMIUM: Smooth zoom and pull UP to reveal people at the bottom */
.story-climax-card.active ~ .climax-phantom-layer, .story-climax-card.active .climax-phantom-layer { 
    transform: scale(1.12) translateY(-8%); 
    transition: transform 22s cubic-bezier(0.19, 1, 0.22, 1); 
}

.climax-gradient-overlay { 
    position: absolute; inset: 0; width: 100%; height: 100%; 
    background: linear-gradient(to top, rgba(0,0,0,0.96) 0%, rgba(0,0,0,0.72) 38%, rgba(0,0,0,0.12) 78%, transparent 100%); 
    z-index: 1; pointer-events: none; 
    transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
}
.climax-content { 
    position: relative; z-index: 2; text-align: center; 
    padding: 0 1.5rem; display: flex; flex-direction: column; align-items: center; 
}
.climax-title { 
    color: #fff; font-family: 'Playfair Display'; 
    font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom: 0.5rem; 
    text-shadow: 0 4px 32px rgba(0,0,0,0.95), 0 2px 8px rgba(0,0,0,0.6); 
    opacity: 0; transform: translateY(24px); 
    transition: opacity 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.15s, 
                transform 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.15s;
    letter-spacing: -0.02em; font-weight: 700;
}
.climax-badge { 
    display: inline-flex; align-items: center; gap: 7px; 
    background: rgba(255,255,255,0.16); backdrop-filter: blur(12px); 
    border: 1px solid rgba(255,255,255,0.24); padding: 7px 16px; 
    border-radius: 50px; margin-bottom: 1.4rem; 
    opacity: 0; transform: translateY(18px) scale(0.96); 
    transition: opacity 0.85s cubic-bezier(0.16, 1, 0.3, 1) 0.35s, 
                transform 0.85s cubic-bezier(0.16, 1, 0.3, 1) 0.35s; 
    box-shadow: 0 8px 36px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
}
.climax-stars { display: flex; gap: 3px; }
.climax-stars svg { width: 13px; height: 13px; fill: #FFD700; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
.climax-badge-text { color: white; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; }

.climax-desc { 
    color: rgba(255,255,255,0.97); font-size: 0.9rem; margin-bottom: 2rem; 
    line-height: 1.55; font-weight: 500; 
    text-shadow: 0 2px 22px rgba(0,0,0,1), 0 1px 4px rgba(0,0,0,0.5); 
    max-width: 90%; opacity: 0; transform: translateY(20px); 
    transition: opacity 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.55s, 
                transform 0.9s cubic-bezier(0.16, 1, 0.3, 1) 0.55s; 
}
.climax-cta { 
    background: #fff; color: #000; width: 100%; padding: 1.3rem; 
    border-radius: 50px; font-weight: 800; font-size: 0.95rem; border: none; 
    box-shadow: 0 0 24px rgba(255,255,255,0.32), 0 4px 12px rgba(0,0,0,0.15); 
    cursor: pointer; text-transform: uppercase; letter-spacing: 1.2px; 
    transform: scale(0.92) translateY(8px); opacity: 0; 
    transition: opacity 0.75s cubic-bezier(0.16, 1, 0.3, 1) 0.75s, 
                transform 0.75s cubic-bezier(0.16, 1, 0.3, 1) 0.75s,
                box-shadow 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.climax-cta:hover { 
    transform: scale(1.01) translateY(-1px); 
    box-shadow: 0 0 32px rgba(255,255,255,0.4), 0 6px 16px rgba(0,0,0,0.18);
}
.climax-cta:active { transform: scale(0.99) translateY(0); }

.story-climax-card.active .climax-title { opacity: 1; transform: translateY(0); }
.story-climax-card.active .climax-badge { opacity: 1; transform: translateY(0) scale(1); }
.story-climax-card.active .climax-desc { opacity: 1; transform: translateY(0); }
.story-climax-card.active .climax-cta { opacity: 1; transform: scale(1) translateY(0); }

.story-climax-card .story-trust {
    margin-top: 22px;
    opacity: 0; transform: translateY(12px);
    transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s, 
                transform 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s;
}
.story-climax-card.active .story-trust {
    opacity: 0.94; transform: translateY(0);
}        
        /* Menu Modal & Misc */

/* === ELITE MENU MODAL V18 (ULTRA-RELIABLE MOBILE-FIRST) === */
.menu-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    height: 100dvh; /* Dynamic viewport height for mobile */
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    will-change: opacity;
    /* Prevent iOS overscroll */
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
}
.menu-modal-overlay.active { opacity: 1; }

.menu-modal-content { 
    background: #fff; 
    width: 94%; 
    max-width: 800px; 
    height: 88vh;
    height: 88dvh; /* Dynamic viewport height */
    max-height: 900px;
    border-radius: 24px; 
    overflow: hidden; 
    position: relative; 
    transform: scale(0.95) translateY(10px); 
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 25px 60px -12px rgba(0,0,0,0.5); 
    will-change: transform; 
    backface-visibility: hidden; 
    -webkit-backface-visibility: hidden;
    contain: layout paint style; 
}
.menu-modal-overlay.active .menu-modal-content { 
    transform: scale(1) translateY(0); 
}

.menu-header { 
    padding: 16px 20px; 
    border-bottom: 1px solid #eee; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #FAFAFA; 
    flex-shrink: 0;
    min-height: 56px;
}
.menu-header h3 { 
    font-size: 1.1rem; 
    margin: 0; 
    color: var(--text-dark); 
    font-weight: 700;
}
.close-menu { 
    cursor: pointer; 
    font-size: 1.8rem; 
    line-height: 1; 
    color: #666; 
    padding: 8px; 
    margin: -8px;
    border-radius: 50%;
    transition: background 0.2s ease, color 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}
.close-menu:hover,
.close-menu:active {
    background: rgba(0,0,0,0.05);
    color: #333;
}

/* === SCROLLING CONTAINER (CRITICAL FOR MOBILE) === */
.menu-iframe-container {
    flex: 1 1 auto;
    position: relative;
    width: 100%;
    min-height: 0; /* Important for flexbox */
    overflow: hidden; /* Changed from overflow-y: auto */
    background: #e8e8e8; 
    z-index: 10;
    /* iOS smooth scrolling */
    -webkit-overflow-scrolling: touch;
}

.menu-iframe-container iframe {
    /* Allow both horizontal and vertical pan for PDF zoom */
    touch-action: pan-x pan-y pinch-zoom; 
    /* Ensure iframe fills container */
    display: block;
}

/* === MENU SPINNER (Unique, no conflicts) === */
.menu-spinner { 
    width: 44px; 
    height: 44px; 
    border: 3px solid rgba(236, 80, 117, 0.15); 
    border-radius: 50%; 
    border-top: 3px solid var(--brand-raspberry); 
    animation: menuSpin 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; 
    margin-bottom: 18px; 
}

@keyframes menuSpin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
}

.loading-text {
    font-size: 0.85rem; 
    font-weight: 700; 
    color: #666;
    text-transform: uppercase; 
    letter-spacing: 1px;
    animation: pulseMenuText 1.5s infinite ease-in-out;
}

@keyframes pulseMenuText { 
    0%, 100% { opacity: 0.6; } 
    50% { opacity: 1; } 
}

/* === MOBILE SPECIFIC OVERRIDES === */
@media (max-width: 768px) {
    .menu-modal-content {
        width: 100%;
        height: 100%;
        height: 100dvh;
        max-height: none;
        border-radius: 0;
    }
    
    .menu-header {
        padding: 14px 16px;
        /* Safe area for notched phones */
        padding-top: max(14px, env(safe-area-inset-top));
    }
    
    .menu-iframe-container {
        /* Account for safe areas on notched phones */
        padding-bottom: env(safe-area-inset-bottom, 0);
    }
    
    .close-menu {
        font-size: 2rem;
        padding: 10px;
    }
}

        .testimonials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; margin-top: 3rem; }
        .testimonial-card-new { background: var(--bg-card); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-card); transition: transform 0.3s ease; border: 1px solid rgba(0,0,0,0.03); transform: translateZ(0); }
        .testimonial-card-new:hover { transform: translateY(-5px); }
        .testimonial-image-wrapper { width: 100%; height: 220px; position: relative; }
        .testimonial-image-wrapper img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .testimonial-content-new { padding: 2rem; }
        .testimonial-headline { font-size: 1.2rem; color: #d83669; margin-bottom: 0.8rem; font-family: 'Playfair Display'; font-weight: 800; }
        .testimonial-quote-new { font-style: italic; color: var(--text-body); border-left: 3px solid var(--brand-raspberry); padding-left: 1rem; margin: 1rem 0; font-size: 0.95rem; line-height: 1.6; background: rgba(0,0,0,0.01); padding: 1rem; border-radius: 0 12px 12px 0; }
        .testimonial-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .testimonial-tag { background: #F4F5F7; color: var(--text-muted); padding: 0.3rem 0.8rem; border-radius: 50px; font-size: 0.65rem; border: 1px solid rgba(0,0,0,0.05); font-weight: 700; text-transform: uppercase; }
        .authority-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 0; margin-bottom: 1rem; flex-wrap: wrap; }
        .authority-badge { display: flex; align-items: center; gap: 8px; background: #fff; padding: 6px 16px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); font-size: 0.75rem; font-weight: 700; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.5px; transition: transform 0.3s ease; }
        .authority-badge:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        .authority-badge img { width: 20px; height: 20px; object-fit: contain; }
        .verified-check { color: #059669; margin-left: 4px; width: 14px; height: 14px; }

        .accordion { max-width: 800px; margin: 0 auto; margin-top: 2rem; }
        .accordion-item { background: var(--bg-card); border-radius: 16px; margin-bottom: 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.03); }
        .accordion-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .accordion-header { padding: 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header h4 { font-size: 1.05rem; margin: 0; font-weight: 700; color: var(--text-dark); }
        .accordion-toggle { font-size: 1.5rem; color: var(--brand-raspberry); transition: transform 0.3s ease; font-weight: 300; }
        .accordion-item.open .accordion-toggle { transform: rotate(45deg); }
        .accordion-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: all 0.4s ease-out; }
        .accordion-item.open .accordion-content { padding-bottom: 1.5rem; max-height: 500px; }
        .accordion-content p { color: var(--text-body); padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.05); }

        /* === ELITE FORM SECTION === */
        .form-section { 
            padding: 6rem 1.5rem; 
            position: relative; 
            background: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);
            overflow: hidden;
            content-visibility: auto; 
            contain-intrinsic-size: 800px;
        }

        /* Background Atmosphere */
        .form-section::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(236, 80, 117, 0.03) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .form-container { 
            max-width: 550px; 
            margin: 2.5rem auto 0; 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 3rem 2.5rem; 
            border-radius: 40px; 
            box-shadow: 
                0 40px 80px -20px rgba(0,0,0,0.1), 
                0 0 0 1px rgba(255,255,255, 0.9),
                inset 0 0 20px rgba(255,255,255,0.5);
            position: relative; 
            z-index: 10; 
            transition: transform 0.4s var(--ease-spring);
        }

        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        .form-header-premium {
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-header-premium h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-header-premium p {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* Progress Indicator */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 2rem;
        }
        .step-dot {
            width: 40px; height: 4px;
            background: #E5E7EB;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .step-dot.active {
            background: var(--brand-raspberry);
            box-shadow: 0 0 10px rgba(236, 80, 117, 0.4);
        }

        /* Premium Inputs */
        .form-group { margin-bottom: 1.5rem; position: relative; }

        .form-group label { 
            display: block; 
            font-weight: 800; 
            margin-bottom: 0.8rem; 
            color: var(--text-dark); 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-left: 4px;
        }

        /* Premium Touch Targets */
        .elite-input-container {
            position: relative;
            background: #fff;
            border: 2px solid #E5E7EB;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center;
            padding: 0 1.2rem;
            min-height: 60px;
            cursor: pointer; /* UPGRADE: Add cursor pointer for better affordance */
        }
        
        .elite-input-container:hover { 
            border-color: #D1D5DB; 
            box-shadow: 0 6px 16px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .elite-input-container:focus-within {
            border-color: var(--brand-raspberry);
            box-shadow: 0 0 0 4px rgba(236, 80, 117, 0.1), 0 8px 24px rgba(236, 80, 117, 0.15), inset 0 1px 0 rgba(255,255,255,0.9);
            transform: translateY(-1px);
            background: #fff;
        }

        .input-icon { 
            color: var(--brand-raspberry); 
            width: 22px; 
            height: 22px; 
            margin-right: 14px; 
            flex-shrink: 0;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .elite-input-container:focus-within .input-icon {
            opacity: 1;
        }
        
        .elite-input { 
            width: 100%; 
            padding: 1.4rem 0; 
            border: none; 
            background: transparent; 
            font-size: 1.05rem; 
            color: var(--text-dark); 
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            line-height: 1.4;
        }
        
        .elite-input::placeholder {
            color: #9CA3AF;
            font-weight: 500;
            opacity: 0.8;
        }
        
        /* Custom Select Arrow */
        .select-chevron {
            pointer-events: none;
            color: var(--text-muted);
            width: 18px; 
            height: 18px;
            margin-left: auto;
            flex-shrink: 0;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        
        .elite-input-container:focus-within .select-chevron {
            color: var(--brand-raspberry);
            transform: rotate(180deg);
        }
        
        /* Premium Select Dropdown Styling */
        select.elite-input {
            background-image: none;
            cursor: pointer;
        }
        
        select.elite-input option {
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            background: #fff;
        }
        
        select.elite-input option:checked {
            background: linear-gradient(to right, rgba(236, 80, 117, 0.1), rgba(236, 80, 117, 0.05));
            color: var(--brand-raspberry);
            font-weight: 700;
        }
        
        /* Premium Date Input Styling */
        input[type="date"].elite-input {
            position: relative;
            cursor: pointer;
        }
        
        input[type="date"].elite-input::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        input[type="date"].elite-input::-webkit-inner-spin-button,
        input[type="date"].elite-input::-webkit-clear-button {
            display: none;
        }

        /* Country Code Selector */
        .country-select {
            padding: 1.2rem 0;
            border: none;
            background: transparent;
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 700;
            outline: none;
            cursor: pointer;
            margin-right: 8px;
            border-right: 1px solid #E5E7EB;
            padding-right: 8px;
        }

        /* Elite Guest Counter */
        .guest-counter-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border: 1px solid #E5E7EB;
            border-radius: 18px;
            padding: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        
        .counter-btn {
            width: 50px; height: 50px;
            border-radius: 14px;
            border: none;
            background: #F3F4F6;
            color: var(--text-dark);
            font-size: 1.5rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .counter-btn:hover { background: #E5E7EB; }
        .counter-btn:active { transform: scale(0.95); }
        
        #guest-display, #child-display {
            font-size: 1.3rem; font-weight: 800; color: var(--text-dark); min-width: 40px; text-align: center;
        }

        /* Children Toggle */
        .children-toggle-wrapper {
            display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; cursor: pointer;
        }
        .custom-checkbox {
            width: 22px; height: 22px; border: 2px solid #D1D5DB; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .custom-checkbox.checked { background: var(--brand-raspberry); border-color: var(--brand-raspberry); }
        .custom-checkbox svg { width: 14px; height: 14px; color: white; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .custom-checkbox.checked svg { opacity: 1; transform: scale(1); }
        
        .children-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; user-select: none; }

        /* The Button (Climax) */
        .form-button { 
            width: 100%; 
            padding: 1.4rem;
            margin-top: 1.5rem;
            background: var(--brand-gradient);
            color: #fff; 
            border: none; 
            border-radius: 18px; 
            font-size: 1rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            cursor: pointer; 
            box-shadow: 0 15px 40px rgba(236, 80, 117, 0.35); 
            transition: all 0.4s var(--ease-spring);
            position: relative;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .form-button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 20px 50px rgba(236, 80, 117, 0.45);
        }

        .form-button::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg); animation: btnShimmer 4s infinite;
        }

        /* Loading States */
        .elite-loader-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--brand-raspberry);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }

        .pulsing-dot {
            width: 8px; height: 8px;
            background-color: var(--brand-raspberry);
            border-radius: 50%;
            animation: pulseDot 1.4s infinite ease-in-out both;
        }
        .pulsing-dot:nth-child(1) { animation-delay: -0.32s; }
        .pulsing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulseDot {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
/* === ELITE FORM VALIDATION STYLES === */
.elite-input-container.error {
    border-color: #EF4444 !important; /* Red error color */
    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
    animation: formShake 0.4s cubic-bezier(.36,.07,.19,.97) both;
}

.elite-input-error-msg {
    color: #EF4444;
    font-size: 0.75rem;
    font-weight: 700;
    margin-top: 6px;
    margin-left: 12px;
    display: none; /* Hidden by default */
    animation: fadeIn 0.3s ease;
}

.elite-input-error-msg.visible {
    display: block;
}

@keyframes formShake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
}
        
        /* PROCESSING OVERLAY (HYPNOTIC) */
        .processing-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 40px;
            animation: fadeIn 0.5s ease;
        }
        .processing-spinner {
            width: 60px; height: 60px; border: 4px solid rgba(236, 80, 117, 0.1);
            border-top: 4px solid var(--brand-raspberry); border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; margin-bottom: 25px;
        }
        .processing-text { 
            font-size: 1.1rem; font-weight: 800; color: var(--text-dark); 
            text-align: center; transition: opacity 0.5s ease;
        }
        .fade-text { opacity: 0; }
        
        .loader { border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 3px solid var(--brand-raspberry); width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Success Message Upgrade */
        .msg-box { text-align: center; padding: 2rem; border-radius: 16px; display: none; margin-top: 1.5rem; }
        .msg-error { background: #FEF2F2; border: 1px solid #FECACA; color: #DC2626; font-size: 0.9rem; }
        .msg-success {
            background: #fff;
            border: 1px solid #10B981;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(16, 185, 129, 0.15);
            color: #064E3B;
        }
        .msg-success h3 { color: #059669; margin-bottom: 1rem; }
        
        .trust-badge-form { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
        
        footer { border-top: 1px solid rgba(0,0,0,0.05); text-align: center; padding: 4rem 2rem; font-size: 0.875rem; color: var(--text-muted); background: #fff; position: relative; z-index: 2; content-visibility: auto; }
        footer a { color: var(--brand-raspberry); text-decoration: none; }

        @media (max-width: 768px) {
            .header-container, .trust-container { flex-direction: column; gap: 1rem; text-align: center;}
            header { padding: 0.8rem 1.2rem !important; }
            .hero { padding: 0 0 2rem 0 !important; min-height: auto !important; align-items: flex-start !important; background-image: none !important; background-color: #ffffff !important; }
            .hero-content { width: 100% !important; max-width: none !important; margin: 0 !important; border-radius: 0 !important; padding: 2.2rem 1.2rem 0 1.2rem !important; background: transparent !important; backdrop-filter: none !important; border: none !important; box-shadow: none !important; display: flex; flex-direction: column; justify-content: flex-start; }
            .hero h1 { font-size: 2.1rem !important; margin-top: 0.2rem !important; margin-bottom: 0.5rem !important; line-height: 1.1 !important; letter-spacing: -0.03em !important; }
            .hero p.subtitle { font-size: 0.95rem !important; margin-bottom: 1.5rem !important; line-height: 1.55 !important; color: #444 !important; }
            /* Mobile Wistia Optimization (90% Width) */
            .wistia-video-container { margin-bottom: 1.5rem !important; width: 100% !important; border-width: 0 !important; box-shadow: 0 12px 35px rgba(0,0,0,0.12) !important; }
            .cta-primary { width: 90%; text-align: center; padding: 1.15rem !important; font-size: 0.95rem !important; margin-bottom: 0 !important; box-shadow: 0 8px 25px rgba(236, 80, 117, 0.25) !important; }
            .hero-cta-support { gap: 10px; flex-direction: row; flex-wrap: wrap; }
            .hcs-item { flex: 1 1 40%; justify-content: center; font-size: 0.75rem; background: #f5f5f5; border: none; white-space: nowrap; }
            .section, .form-section { padding-left: 1.2rem; padding-right: 1.2rem; }
            .form-container { padding: 2rem 1.5rem; border-radius: 30px; }
            .form-header-premium h3 { font-size: 1.8rem; }
            .party-size-selector { grid-template-columns: repeat(4, 1fr); display: flex; }
            .sticky-cta-container { display: block; }
            .card-actions-container { grid-template-columns: 1fr; }
            .trust-box { font-size: 0.68rem; padding: 8px 10px; }
            /* Story Container Mobile Optimization */
            .story-container { 
                width: 100vw !important; 
                height: 100vh !important; 
                height: 100dvh !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .story-media-wrapper { 
                width: 100% !important; 
                height: 100% !important;
            }
            .story-media-item { 
                width: 100% !important; 
                height: 100% !important;
                object-fit: cover !important;
                object-position: center center !important;
            }
            .story-media-item img,
            .story-media-item iframe {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                object-position: center center !important;
            }
            
            .story-footer { padding-bottom: 40px; padding-top: 85px; }
            .story-title-text { margin-bottom: 8px; }
            .story-desc-text { margin-bottom: 20px; }
            .story-cta-btn { padding: 12px 28px; margin-bottom: 0; }
            .story-trust { margin-top: 16px; }
            .story-climax-card { padding-bottom: 65px; }
            .climax-title { margin-bottom: 0.4rem; }
            .climax-badge { margin-bottom: 1.2rem; padding: 6px 14px; }
            .climax-desc { margin-bottom: 1.8rem; }
            .climax-cta { padding: 1.15rem; font-size: 0.95rem; }
            .story-climax-card .story-trust { margin-top: 20px; }
            
            /* Premium Mobile Selector Enhancements */
            .elite-input-container {
                min-height: 64px;
                padding: 0 1.4rem;
                border-radius: 22px;
                border-width: 2px;
                box-shadow: 0 6px 16px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.9);
            }
            
            .elite-input-container:active {
                transform: scale(0.98);
                box-shadow: 0 4px 12px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.9);
            }
            
            .elite-input-container:focus-within {
                border-width: 2.5px;
                box-shadow: 0 0 0 5px rgba(236, 80, 117, 0.12), 0 10px 28px rgba(236, 80, 117, 0.18), inset 0 1px 0 rgba(255,255,255,0.95);
                transform: translateY(-1px) scale(1);
            }
            
            .elite-input {
                padding: 1.5rem 0;
                font-size: 1.1rem;
                font-weight: 600;
            }
            
            .input-icon {
                width: 24px;
                height: 24px;
                margin-right: 16px;
            }
            
            .select-chevron {
                width: 20px;
                height: 20px;
            }
            
            .form-group label {
                font-size: 0.75rem;
                margin-bottom: 1rem;
                letter-spacing: 1.2px;
            }
            
            /* Enhanced Date Picker for Mobile */
            input[type="date"].elite-input {
                font-size: 1.1rem;
                padding: 1.5rem 0;
            }
            
            /* Better Select Dropdown on Mobile */
            select.elite-input {
                font-size: 1.1rem;
                padding: 1.5rem 0;
                background-position: right 1.4rem center;
            }
            
            select.elite-input option {
                padding: 1.2rem;
                font-size: 1.05rem;
                min-height: 56px;
            }
        }

/* Hide the small badge when the Teaser is active to reduce clutter */
.spectacle-card.teaser-active .media-badge {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
}
        
        /* === ELITE WHATSAPP CONSOLE (V88 OPTIMIZED) === */
        .wa-sticky-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            /* Start State: Hidden below view */
            transform: translateX(-50%) translateY(150%) scale(0.95);
            opacity: 0;
            pointer-events: none;
            
            z-index: 9995;
            display: flex;
            align-items: center;
            gap: 15px;
            
            background: rgba(8, 8, 10, 0.85);
            backdrop-filter: blur(20px) saturate(1.8);
            -webkit-backdrop-filter: blur(20px) saturate(1.8);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.4),
                0 10px 20px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
                
            text-decoration: none;
            width: auto;
            min-width: 300px;
            max-width: 90%;
            
            /* ELITE PHYSICS TRANSITION */
            transition: 
                transform 0.6s cubic-bezier(0.25, 1, 0.3, 1),
                opacity 0.5s ease;
                
            will-change: transform, opacity;
        }

        /* VISIBLE STATE */
        .wa-sticky-container.visible {
            transform: translateX(-50%) translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        /* DUCKED STATE (Specifically for when Form is visible) */
        .wa-sticky-container.ducked {
            transform: translateX(-50%) translateY(150%) scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: 
                transform 0.5s cubic-bezier(0.33, 1, 0.68, 1), /* Faster exit */
                opacity 0.3s ease;
        }

        .wa-icon {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .wa-status-dot {
            position: absolute;
            bottom: 2px; right: 2px;
            width: 10px; height: 10px;
            background: #25D366;
            border: 2px solid #1f2937;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.8);
            animation: waPulse 2s infinite;
        }

        @keyframes waPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(37, 211, 102, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
        }

        .wa-text-col {
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: left;
        }

        .wa-title {
            color: #FFFFFF;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 800;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            line-height: 1.2;
        }

        .wa-subtext {
            color: #9CA3AF;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .wa-highlight {
            color: #4ade80; 
            font-weight: 700;
        }

        /* Hide on Desktop (Optional: Remove if you want it on desktop too) */
        @media (min-width: 769px) {
            .wa-sticky-container { display: none !important; }
        }
/* === ELITE FORM FIX V3 (Layout, Ghost Click & Style Polish) === */

/* 1. RESET ALL CONTAINERS (Standardize Height & Interaction) */
.elite-input-container {
    padding: 0 !important;
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    min-height: 60px !important;
}

/* 2. FLOAT ICONS BEHIND INPUTS (Visuals only, no interaction) */
.elite-input-container .input-icon {
    position: absolute !important;
    left: 1.2rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 0 !important; /* Behind input */
    pointer-events: none !important;
}

/* 3. FIX INPUTS (Padding, Clickability & Remove Blue Glow) */
#experience-select,
#booking_time,
#date,
#name,
#email {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    background: transparent !important;
    margin: 0 !important;
    
    /* CRITICAL FIX 1: Padding Right increased to 3.5rem to stop text hitting the arrow */
    padding: 0 3.5rem 0 3.5rem !important; 
    
    position: relative !important;
    z-index: 10 !important; /* Clickable layer */
    cursor: pointer;
    border-radius: 20px;
    
    /* CRITICAL FIX 2: Remove default mobile blue highlights */
    outline: none !important;
    box-shadow: none !important;
    -webkit-tap-highlight-color: transparent !important;
}

/* 4. FIX CHEVRONS (Right Arrow for Selects) */
.elite-input-container .select-chevron {
    position: absolute !important;
    right: 1.2rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 0 !important;
    pointer-events: none !important;
}

/* 5. REPAIR PHONE CONTAINER (Flexbox Layout Fix) */
#container-phone {
    padding: 0 !important;
    display: flex !important;
    flex-direction: row !important;
    overflow: hidden !important;
}

#country-code {
    width: 115px !important;
    flex-shrink: 0 !important;
    height: 100% !important;
    border: none !important;
    border-right: 1px solid #E5E7EB !important;
    background: transparent !important;
    padding: 0 0 0 1rem !important;
    margin: 0 !important;
    z-index: 10;
    cursor: pointer;
    position: relative;
    font-weight: 700 !important;
    
    /* Remove blue glow */
    outline: none !important;
    -webkit-tap-highlight-color: transparent !important;
}

#whatsapp_number {
    flex-grow: 1 !important;
    width: auto !important;
    height: 100% !important;
    border: none !important;
    background: transparent !important;
    padding: 0 1rem !important;
    margin: 0 !important;
    z-index: 10;
    position: relative;
    
    /* Remove blue glow */
    outline: none !important;
    -webkit-tap-highlight-color: transparent !important;
}

/* 6. iOS Date Input Fix */
input[type="date"] {
    -webkit-appearance: none;
    min-height: 60px;
}

/* === PREMIUM STORY BADGE (Top-Left / White Style) === */
/* === PREMIUM STORY BADGE (ELITE UPGRADE) === */
.story-badge-premium {
    position: absolute;
    top: 15px; 
    left: 15px; 
    
    /* Glassmorphism & Depth Base */
    background: rgba(255, 255, 255, 0.96);
    color: #111827; 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    
    /* Geometry */
    padding: 5px 6px 5px 14px; /* Less padding on right to hug the circle */
    border-radius: 50px;
    
    /* Typography */
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    
    /* Layout */
    display: flex;
    align-items: center;
    gap: 10px;
    
    /* Premium Shadow & Border */
    box-shadow: 
        0 4px 20px rgba(0,0,0,0.12), 
        0 1px 3px rgba(0,0,0,0.05),
        inset 0 1px 0 rgba(255,255,255,1);
    border: 1px solid rgba(255,255,255,0.8);
    
    z-index: 10;
    pointer-events: none;
    
    /* Animation Initial State */
    opacity: 0;
    transform: translateY(-12px) scale(0.95);
    transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
}

/* THE "INNER CIRCLE" PLAY BUTTON */
.story-badge-premium .play-circle {
    width: 24px;
    height: 24px;
    background: #111827; /* Deep Luxury Black */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Inner Depth (The "Pressed" look) */
    box-shadow: 
        inset 0 1px 4px rgba(255,255,255,0.3),
        0 2px 5px rgba(0,0,0,0.2);
    
    position: relative;
    overflow: hidden;
}

/* The Triangle Icon */
.story-badge-premium .play-circle svg {
    width: 8px; 
    height: 8px;
    fill: #FFF;
    margin-left: 2px; /* Optical center correction */
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
}

/* Subtle Shimmer on the black circle */
.story-badge-premium .play-circle::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.15), transparent);
    transform: rotate(45deg) translateY(-100%);
    animation: circleShine 3s infinite;
}

/* === ACTIVE STATE (Triggered via JS) === */
.testimonial-card-new.teaser-active .story-badge-premium {
    opacity: 1;
    transform: translateY(0) scale(1);
}

@keyframes circleShine {
    0% { transform: rotate(45deg) translateY(-100%); }
    20% { transform: rotate(45deg) translateY(100%); }
    100% { transform: rotate(45deg) translateY(100%); }
}

/* Hover Effect on the whole card lifts the badge slightly */
.testimonial-card-new:hover .story-badge-top {
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}

    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">Marrakech <span>Top Spot</span></div>
            <div class="header-trust"></div>
        </div>
    </header>

    <main>
        <section class="hero" id="heroSection">
            <div class="hero-content">
                <!-- ELITE STATUS BAR -->
                <div class="status-bar-container">
                    <div class="status-pill sp-vip">GUESTLIST VIP</div>
                    <div class="status-pill sp-live"><span class="live-dot"></span> RÉSERVATION GRATUITE</div>
                </div>

                <!-- CORRECTED HEADLINE HTML -->
<!-- KEEP THIS ORIGINAL HTML STRUCTURE -->
<h1>Les 7 Meilleurs<br>
    <span class="headline-dynamic-wrapper"> 
        <span class="text-highlight">Dîners Spectacles</span>
    </span> de Marrakech
</h1>
                
                <p class="subtitle">
                    L'accès privilégié aux soirées les plus prisées. Sécurisez les meilleures tables sans acompte.
                </p>
                
<!-- === START: WISTIA INLINE DECISION ENGINE === -->
<div class="wistia-video-container" id="heroVideoContainer">
    <script>
        (function() {
            // 1. Define Video IDs for different contexts
            const WISTIA_IDS = {
                'default': 'ds6i64qgoy',
                'festif': 'hsqqgfyxmh'
            };

            // 2. Determine the initial context from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const intent = (urlParams.get('intent') || '').toLowerCase();
            let contextKey = 'default';
            if (intent.includes('festif') || intent.includes('party') || intent.includes('vip')) {
                contextKey = 'festif';
            }
            
            // 3. Select the correct video ID
            const videoId = WISTIA_IDS[contextKey];
            
            // 4. Store the ID globally for the main script to use for API binding
            window.initialVideoId = videoId; 

            // 5. Preload the high-res thumbnail to prevent flash of black
            const thumbUrl = `https://fast.wistia.com/embed/medias/${videoId}.jpg?image_crop_resized=1920x1080`;
            const preloadLink = document.createElement('link');
            preloadLink.rel = 'preload';
            preloadLink.as = 'image';
            preloadLink.href = thumbUrl;
            document.head.appendChild(preloadLink);

            // 6. Use document.write() to inject the correct HTML *synchronously* during page load.
            // This is the key to fixing the timing issue and avoiding any lag or API disconnects.
            document.write(`
                <script src="https://fast.wistia.com/embed/medias/${videoId}.jsonp" async><\/script>
                <script src="https://fast.wistia.com/assets/external/E-v1.js" async><\/script>
                <div class="wistia_responsive_padding" style="padding:56.25% 0 0 0;position:relative;">
                    <div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;">
                        <div class="wistia_embed wistia_async_${videoId} videoFoam=true playerColor=EC5075 controlsVisibleOnLoad=false playbar=false playButton=false settingsControl=false fullscreenButton=false smallPlayButton=false volumeControl=false endVideoBehavior=default" 
                             style="height:100%;position:relative;width:100%;background-image:url('${thumbUrl}');background-size:cover;background-position:center;">
                            &nbsp;
                        </div>
                    </div>
                </div>
                <div class="video-sound-badge" id="videoSoundBadge">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                    ACTIVER LE SON
                </div>
                <div class="video-click-layer" onclick="toggleHeroSound()"></div>
            `);
        })();
    </script>
</div>
<!-- === END: WISTIA INLINE DECISION ENGINE === -->


                <button class="cta-primary" onclick="document.getElementById('explore-anchor').scrollIntoView({ behavior: 'smooth', block: 'start' });">REJOINDRE LA GUESTLIST 🥂</button>
                
                <div class="hero-subtext" onclick="document.getElementById('explore-anchor').scrollIntoView({ behavior: 'smooth', block: 'start' });">
                    Explorer les 7 adresses d'exception
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"></path></svg>
                </div>
                
                <div class="hero-cta-support">
                    <div class="hcs-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> 
                        Disponibilité temps réel
                    </div>
                    <div class="hcs-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> 
                        Support WhatsApp
                    </div>
                    <div class="hcs-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> 
                        Réservation Instantanée
                    </div>
                </div>
            </div>
        </section>

        <section class="trust-bar reveal">
            <div class="trust-container">
                <div class="trust-element"><strong id="counter-tables">1 200+</strong>Tables Réservées</div>
                <div class="trust-element"><strong id="counter-rating">4.85/5</strong>Satisfaction Client</div>
                <div class="trust-element"><strong>0€</strong>Conciergerie Gratuite</div>
            </div>
        </section>

        <section class="section reveal" id="experiences">
            <div class="section-header">
                <!-- ADDED ID HERE -->
                <h2 id="experiences-title">7 Spectacles Uniques.<br>Quelle magie choisirez-vous ce soir ?</h2>
                <p>Oubliez les adresses de masse. Voici les 7 scènes confidentielles où Marrakech bat réellement son plein ce soir.</p>
            </div>
            
            <div id="explore-anchor"></div>

            <!-- SMART FILTERS -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterExperiences('all', this)">Toutes les adresses</button>
                <button class="filter-btn" onclick="filterExperiences('grand-spectacle', this)">Grands Spectacles & Cabaret</button>
                <button class="filter-btn" onclick="filterExperiences('authentic', this)">Charme & Traditions</button>
                <button class="filter-btn" onclick="filterExperiences('party', this)">Festif & Rooftop</button>
            </div>

            <div class="spectacles-grid">
                <!-- Filled by JS -->
            </div>
        </section>

        <section class="section reveal" id="testimonialsSection">
<!-- === START: Replace the old section-header entirely with this new structure === -->
<div class="section-header" style="margin-bottom: 3.5rem; max-width: 900px;">
    <div class="social-proof-wrapper">

        <!-- Column 1: The Authoritative Claim -->
        <div class="proof-text-content">
            <h2>L'Excellence <span class="highlight-pink">Reconnue</span>.<br>L'Expérience que l'on vous envie.</h2>
            <p>Nos invités ne partagent pas un simple dîner. Ils racontent l’histoire d’une soirée mémorable au cœur battant de Marrakech.</p>
        </div>

        <!-- Column 2: The Undeniable Proof -->
        <div class="proof-authority-content">
            <h4 class="authority-title">VALIDÉ PAR</h4>
            <div class="authority-badges-stack">
                <div class="authority-badge">
                    <img src="https://MTSZone.b-cdn.net/Malak/icons8-tripadvisor-50.png" alt="TripAdvisor Icon">
                    <span>Avis Vérifiés</span>
                    <svg class="verified-check" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="authority-badge">
                    <img src="https://MTSZone.b-cdn.net/Malak/icons8-google-50.png" alt="Google Icon">
                    <span>4.9/5 Excellent</span>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- === END: Replacement === -->
<div class="testimonials-grid">

    <!-- CARD 1: IBRAHIM PACHA -->
    <div class="testimonial-card-new" data-id="ibrahim">
        <div class="testimonial-image-wrapper" onclick="StoryManager.open('ibrahim')">
            <img loading="lazy" decoding="async" src="https://MTSZone.b-cdn.net/Malak/ReviewPacha12%20(1)%20(1).png" width="400" height="225" alt="Ibrahim Pacha Review">
            
            <!-- ELITE BADGE -->
            <div class="story-badge-premium">
                Voir la Story
                <div class="play-circle">
                    <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                </div>
            </div>
        </div>
        
        <div class="testimonial-content-new">
            <h3 class="card-title">Ibrahim Pacha</h3>
            <h4 class="testimonial-headline">"Une soirée au-delà de nos attentes."</h4>
            <p class="testimonial-quote-new">Le personnel était incroyable. Tout était parfait - la nourriture, l'ambiance, et surtout le spectacle de plus de 3 heures qui était captivant.</p>
            <div class="testimonial-tags">
                <span class="testimonial-tag">Show 3H+</span>
                <span class="testimonial-tag">Service VIP</span>
            </div>
        </div>
    </div>

    <!-- CARD 2: FOLK -->
    <div class="testimonial-card-new" data-id="folk">
        <div class="testimonial-image-wrapper" onclick="StoryManager.open('folk')">
            <img loading="lazy" decoding="async" src="https://MTSZone.b-cdn.net/Malak/FOLK-MARRAKECH_11%20(2).webp" width="400" height="225" alt="Folk Marrakech Review" style="object-position: center;">
            
            <!-- ELITE BADGE -->
            <div class="story-badge-premium">
                Voir la Story
                <div class="play-circle">
                    <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                </div>
            </div>
        </div> <!-- THIS CLOSING DIV WAS MISSING -->

        <div class="testimonial-content-new">
            <h3 class="card-title">Folk Marrakech</h3>
            <h4 class="testimonial-headline">"Le moment le plus authentique du séjour."</h4>
            <p class="testimonial-quote-new">Nous avons adoré ! Réservation facile, et la meilleure table face aux musiciens. Ambiance intime, service parfait et cuisine délicieuse.</p>
            <div class="testimonial-tags">
                <span class="testimonial-tag">Authentique</span>
                <span class="testimonial-tag">Musique Live</span>
            </div>
        </div>
    </div>

    <!-- CARD 3: NOUBA -->
    <div class="testimonial-card-new" data-id="nouba">
        <div class="testimonial-image-wrapper" onclick="StoryManager.open('nouba')">
            <img loading="lazy" decoding="async" src="https://MTSZone.b-cdn.net/Malak/NoubaReview12%20(1)%20(1).png" width="400" height="225" alt="Nouba Review">
            
            <!-- ELITE BADGE -->
            <div class="story-badge-premium">
                Voir la Story
                <div class="play-circle">
                    <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                </div>
            </div>
        </div>

        <div class="testimonial-content-new">
            <h3 class="card-title">Nouba</h3>
            <h4 class="testimonial-headline">"Talents Incroyables, Soirée Inoubliable"</h4>
            <p class="testimonial-quote-new">Quelle ambiance ! Un lieu chic, magnifiquement décoré. Le personnel est très agréable. On a dansé, chanté, c'était tout simplement génial !</p>
            <div class="testimonial-tags">
                <span class="testimonial-tag">Ambiance Festive</span>
                <span class="testimonial-tag">Show Explosif</span>
            </div>
        </div>
    </div>

</div>
</section>

<!-- Form Section -->
        <section class="form-section reveal" id="form">
            <!-- === ELITE VALIDATION STYLES === -->
            <style>
                .elite-input-container.error {
                    border-color: #EF4444 !important;
                    box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
                    animation: eliteShake 0.4s cubic-bezier(.36,.07,.19,.97) both;
                }
                .elite-input-error-msg {
                    color: #EF4444; font-size: 0.75rem; font-weight: 700;
                    margin-top: 6px; margin-left: 12px; display: none;
                    animation: fadeIn 0.3s ease;
                }
                .elite-input-error-msg.visible { display: block; }
                @keyframes eliteShake {
                    10%, 90% { transform: translate3d(-1px, 0, 0); }
                    20%, 80% { transform: translate3d(2px, 0, 0); }
                    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                    40%, 60% { transform: translate3d(4px, 0, 0); }
                }
            </style>

            <div class="section-header">
                <h2>Votre Table, Votre Soirée</h2>
                <p>Rejoignez la guest-list en 60 secondes. Aucune carte bancaire nécessaire. Disponibilités en temps réel.</p>
            </div>
            
            <div class="form-container">
                <!-- Visual Header inside card -->
                <div class="form-header-premium">
                    <h3>Guestlist Access</h3>
                    <p>SÉCURISATION EN TEMPS RÉEL</p>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div id="dot-step-1" class="step-dot active"></div>
                    <div id="dot-step-2" class="step-dot"></div>
                </div>

                <form id="reservationForm" novalidate>
                    <!-- === STEP 1 === -->
                    <div id="form-step-1" class="form-step active">
                        <div class="form-group">
                            <label for="experience-select">1. Établissement choisi</label>
                            <div class="elite-input-container" id="container-experience">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                <select id="experience-select" name="experience" class="elite-input" required>
                                    <option value="" disabled selected>Sélectionnez votre soirée...</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <svg class="select-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="elite-input-error-msg" id="error-experience">Veuillez sélectionner une soirée.</div>
                        </div>

                        <div class="form-group">
                            <label for="date">2. Date de la soirée</label>
                            <div class="elite-input-container" id="container-date">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <input type="date" id="date" name="date" class="elite-input" required>
                            </div>
                            <div class="elite-input-error-msg" id="error-date">Une date est requise.</div>
                        </div>
                        
                        <div class="form-group hidden" id="time-slot-container">
                            <label for="booking_time">3. Heure souhaitée (Live)</label>
                            <div class="elite-input-container" id="container-time">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <select id="booking_time" class="elite-input" required disabled>
                                    <option value="" selected>-- Choisir une date --</option>
                                </select>
                                <svg class="select-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                            <div class="elite-input-error-msg" id="error-time">Veuillez sélectionner une heure.</div>
                            
                            <!-- ELITE LOADER FOR TIME -->
                            <div id="time-loader" class="hidden elite-loader-container">
                                <div class="pulsing-dot"></div>
                                <div class="pulsing-dot"></div>
                                <div class="pulsing-dot"></div>
                                <span>Synchronisation avec le restaurant...</span>
                            </div>
                        </div>

                        <!-- ELITE GUEST COUNTER -->
                        <div class="form-group">
                            <label>4. Nombre d'Invités</label>
                            <div class="guest-counter-wrapper">
                                <button type="button" class="counter-btn" onclick="adjustGuests('adults', -1)">-</button>
                                <span id="guest-display">2</span>
                                <button type="button" class="counter-btn" onclick="adjustGuests('adults', 1)">+</button>
                            </div>
                            <input type="hidden" id="party_size" name="party_size" value="2">
                        </div>

                        <!-- CHILDREN TOGGLE & COUNTER -->
                        <div class="form-group">
                            <div class="children-toggle-wrapper" onclick="toggleChildren()">
                                <div class="custom-checkbox" id="children-checkbox">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                </div>
                                <span class="children-label">Enfants ?</span>
                            </div>
                            
                            <div id="children-counter-container" class="guest-counter-wrapper hidden" style="margin-top: 10px;">
                                <button type="button" class="counter-btn" onclick="adjustGuests('children', -1)">-</button>
                                <span id="child-display">0</span>
                                <button type="button" class="counter-btn" onclick="adjustGuests('children', 1)">+</button>
                            </div>
                            <input type="hidden" id="children_size" name="children_size" value="0">
                        </div>

                        <!-- UPGRADED BUTTON: Calls validation first -->
                        <button type="button" class="form-button" id="btn-step-1" onclick="validateStep1()">
                            Suivant <span style="margin-left:5px">→</span>
                        </button>
                        
                        <p style="margin-top: 1rem; text-align: center; font-size: 0.75rem; color: #6B7280; font-weight: 500; line-height: 1.5;">
                            Aucun paiement requis • Réservation 100% gratuite
                        </p>
                    </div>

                    <!-- === STEP 2 === -->
                    <div id="form-step-2" class="form-step">
                        <div class="form-group">
                            <label for="name">Votre Nom (Liste VIP)</label>
                            <div class="elite-input-container" id="container-name">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                <input type="text" id="name" name="name" class="elite-input" placeholder="Ex: Jean Dupont" required>
                            </div>
                            <div class="elite-input-error-msg" id="error-name">Veuillez indiquer votre nom.</div>
                        </div>
                        
<div class="form-group">
    <label>WhatsApp (Confirmation)</label>
    <p style="font-size: 0.75rem; color: #9CA3AF; text-align: left; margin-bottom: 0.8rem; margin-top: -0.5rem; padding-left: 4px;">Prévu uniquement pour votre confirmation de réservation.</p>
    <div class="elite-input-container" id="container-phone">
        <select id="country-code" class="country-select" onchange="updatePhonePlaceholder(this)">
            <!-- Primary Markets (Top Priority) -->
            <option value="+33">🇫🇷 +33</option>
            <option value="+212">🇲🇦 +212</option>
            <option value="+44">🇬🇧 +44</option>
            <option value="+32">🇧🇪 +32</option>
            <option value="+41">🇨🇭 +41</option>
            
            <!-- Secondary High-Volume Markets (Added) -->
            <option value="+34">🇪🇸 +34</option>
            <option value="+49">🇩🇪 +49</option>
            <option value="+39">🇮🇹 +39</option>
            <option value="+31">🇳🇱 +31</option>
            
            <!-- North America & Others -->
            <option value="+1">🇺🇸 +1</option>
            <option value="+1">🇨🇦 +1</option>
            <option value="+351">🇵🇹 +351</option>
            
            <!-- The "Safety Net" for Conversion Protection -->
            <option value="+">🌍 Autre</option>
        </select>
        <input type="tel" id="whatsapp_number" class="elite-input" placeholder="6 12 34 56 78" required>
        <input type="hidden" id="whatsapp" name="whatsapp">
    </div>
    <div class="elite-input-error-msg" id="error-phone">Numéro invalide (trop court ou incorrect).</div>
</div>

<!-- Add this small script right after the form or in your script section -->
<script>
function updatePhonePlaceholder(select) {
    const input = document.getElementById('whatsapp_number');
    if (select.value === '+') {
        // If "Autre" is selected, ask for full code
        input.placeholder = "Code pays + Numéro (ex: 971 50...)";
    } else {
        // Standard local format
        input.placeholder = "6 12 34 56 78";
    }
}
</script>
                        
                        <div class="form-group">
                            <label for="email">Email (Reçu)</label>
                            <div class="elite-input-container" id="container-email">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                <input type="email" id="email" name="email" class="elite-input" placeholder="jean@exemple.com" required>
                            </div>
                            <div class="elite-input-error-msg" id="error-email">Veuillez entrer un email valide.</div>
                        </div>

                        <button type="submit" id="submit-btn" class="form-button">
                            VALIDER MA GUESTLIST
                        </button>
                        
                        <button type="button" class="btn-link" onclick="updateStepIndicator(1); goToStep(1)" style="background:none; border:none; color:#9CA3AF; width:100%; margin-top:15px; cursor:pointer; font-size:0.8rem; font-weight:600;">
                            ← Retour
                        </button>
                        
                        <div class="trust-badge-form" style="margin-top: 25px; flex-direction:column; gap:10px;">
                            <div style="display:inline-flex; align-items:center; gap:6px; background:#F0FDF4; padding:8px 16px; border-radius:50px; color:#166534; font-size:0.75rem; font-weight:700; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                AUCUN PRÉPAIEMENT REQUIS
                            </div>
                            <div style="font-size:0.7rem; color:#9CA3AF;">Paiement direct au restaurant • Annulation Gratuite</div>
                        </div>
                    </div>
                </form>

                <!-- SUCCESS MESSAGE -->
                <div id="success-message" class="msg-box msg-success" style="display: none;">
                    <div style="text-align:center; margin-bottom:15px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    </div>
                    <h3 style="color:#064E3B; margin-bottom:0.5rem;">Demande Reçue</h3>
                    <p>Votre concierge s'occupe de tout, <strong id="success-name"></strong>.</p>
                    <hr style="border:0; border-top:1px solid #D1FAE5; margin:15px 0;">
                    <p style="font-size:0.9rem;">Réservation: <strong id="success-experience"></strong><br>Date: <strong id="success-date"></strong> à <strong id="success-time"></strong></p>
                </div>


<!-- === ELITE PROCESSING OVERLAY (V6) === -->
<div id="processing-overlay" class="processing-overlay" style="display:none;">
    <div class="overlay-backdrop"></div>
    
    <div class="processing-content">
        <!-- Centerpiece -->
        <div class="pulse-container">
            <div class="pulse-ring ring-1"></div>
            <div class="pulse-ring ring-2"></div>
            <div class="brand-icon">
                <!-- Clean Lock Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            </div>
        </div>

        <!-- Typography -->
        <h3 class="processing-title">Sécurisation...</h3>
        <div class="status-track">
            <div class="processing-text" id="processing-text"></div>
        </div>
        
        <!-- Minimal Progress -->
        <div class="processing-progress">
            <div class="progress-bar-fill"></div>
        </div>
    </div>
</div>
            
            <!-- INLINE HELPER SCRIPTS FOR NEW ELITE FORM -->
            <script>
                // --- ELITE UI HELPERS (Error Handling) ---
                function setFieldError(containerId, errorMsgId, message) {
                    const container = document.getElementById(containerId);
                    const msg = document.getElementById(errorMsgId);
                    if(container && msg) {
                        container.classList.add('error');
                        // Reset animation to allow re-shake
                        container.style.animation = 'none';
                        container.offsetHeight; /* trigger reflow */
                        container.style.animation = null; 
                        
                        if(message) msg.textContent = message;
                        msg.classList.add('visible');
                    }
                }

                function clearFieldError(containerId, errorMsgId) {
                    const container = document.getElementById(containerId);
                    const msg = document.getElementById(errorMsgId);
                    if(container) container.classList.remove('error');
                    if(msg) msg.classList.remove('visible');
                }

                // Auto-clear errors on input
                document.querySelectorAll('.elite-input').forEach(input => {
                    input.addEventListener('input', function() {
                        const container = this.closest('.elite-input-container');
                        const parent = this.closest('.form-group');
                        if(container && parent) {
                            container.classList.remove('error');
                            const msg = parent.querySelector('.elite-input-error-msg');
                            if(msg) msg.classList.remove('visible');
                        }
                    });
                    input.addEventListener('change', function() {
                        const container = this.closest('.elite-input-container');
                        const parent = this.closest('.form-group');
                        if(container && parent) {
                            container.classList.remove('error');
                            const msg = parent.querySelector('.elite-input-error-msg');
                            if(msg) msg.classList.remove('visible');
                        }
                    });
                });

                // --- STEP 1 VALIDATION ---
                window.validateStep1 = function() {
                    let isValid = true;
                    
                    // 1. Check Experience
                    const expSelect = document.getElementById('experience-select');
                    if(!expSelect.value) {
                        setFieldError('container-experience', 'error-experience');
                        isValid = false;
                    } else {
                        clearFieldError('container-experience', 'error-experience');
                    }
                    
                    // 2. Check Date
                    const dateInput = document.getElementById('date');
                    if(!dateInput.value) {
                        setFieldError('container-date', 'error-date');
                        isValid = false;
                    } else {
                        clearFieldError('container-date', 'error-date');
                    }
                    
                    // 3. Check Time (Must not be disabled/loading)
                    const timeSelect = document.getElementById('booking_time');
                    const timeLoader = document.getElementById('time-loader');
                    
                    if(!timeSelect.value || timeSelect.disabled) {
                        let msg = "Veuillez sélectionner une heure.";
                        if(!dateInput.value) msg = "Sélectionnez d'abord une date.";
                        else if(timeLoader && !timeLoader.classList.contains('hidden')) msg = "Chargement des horaires en cours...";
                        
                        setFieldError('container-time', 'error-time', msg);
                        isValid = false;
                    } else {
                        clearFieldError('container-time', 'error-time');
                    }
                    
                    if(isValid) {
                        // Success: Move to Step 2
                        if(typeof window.updateStepIndicator === 'function') window.updateStepIndicator(2);
                        if(typeof window.goToStep === 'function') window.goToStep(2);
                    }
                };

                // --- EXISTING UTILITIES ---
                window.updateStepIndicator = function(step) {
                    document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
                    const dot = document.getElementById(`dot-step-${step}`);
                    if(dot) dot.classList.add('active');
                };

                window.adjustGuests = function(type, change) {
                    const inputId = type === 'adults' ? 'party_size' : 'children_size';
                    const displayId = type === 'adults' ? 'guest-display' : 'child-display';
                    
                    const input = document.getElementById(inputId);
                    const display = document.getElementById(displayId);
                    
                    let currentVal = parseInt(input.value) || 0;
                    let newVal = currentVal + change;
                    
                    // Constraints
                    if(type === 'adults' && newVal < 1) newVal = 1;
                    if(type === 'children' && newVal < 0) newVal = 0;
                    if(newVal > 20) newVal = 20;
                    
                    input.value = newVal;
                    display.innerText = newVal;
                };

                window.toggleChildren = function() {
                    const checkbox = document.getElementById('children-checkbox');
                    const container = document.getElementById('children-counter-container');
                    const input = document.getElementById('children_size');
                    
                    if(container.classList.contains('hidden')) {
                        container.classList.remove('hidden');
                        checkbox.classList.add('checked');
                        input.value = "1"; // Default to 1 child if opened
                        document.getElementById('child-display').innerText = "1";
                    } else {
                        container.classList.add('hidden');
                        checkbox.classList.remove('checked');
                        input.value = "0"; // Reset if hidden
                    }
                };
                
                // --- STEP 2 SUBMIT VALIDATION & ANIMATION ---
                document.getElementById('reservationForm').addEventListener('submit', function(e) {
                    
                    // 1. VALIDATE STEP 2 INPUTS
                    let isValid = true;
                    
                    // Name Check
                    const nameInput = document.getElementById('name');
                    if(nameInput.value.trim().length < 2) {
                        setFieldError('container-name', 'error-name');
                        isValid = false;
                    } else {
                        clearFieldError('container-name', 'error-name');
                    }
                    
                    // --- SMART PHONE CHECK (Strict Context Aware) ---
                    const phoneInput = document.getElementById('whatsapp_number');
                    const countrySelect = document.getElementById('country-code');
                    
                    // Remove non-digits
                    let cleanPhone = phoneInput.value.replace(/\D/g, ''); 
                    
                    // Remove leading zero if present (User habit: 06 12...)
                    if(cleanPhone.startsWith('0')) {
                        cleanPhone = cleanPhone.substring(1);
                    }
                    
                    const country = countrySelect.value;
                    let isPhoneValid = true;
                    let errMsg = "Numéro invalide.";

                    if(country === '+212' || country === '+33') {
                        // MOROCCO & FRANCE: Strict 9 digits (after removing 0)
                        if(cleanPhone.length !== 9) {
                            isPhoneValid = false;
                            errMsg = "9 chiffres requis (ex: 6 12 34 56 78)";
                        }
                    } else if(country === '+1') {
                        // USA: Strict 10 digits
                        if(cleanPhone.length !== 10) {
                            isPhoneValid = false;
                            errMsg = "10 chiffres requis";
                        }
                    } else {
                        // REST OF WORLD: 9 to 15 digits
                        if(cleanPhone.length < 9 || cleanPhone.length > 15) {
                            isPhoneValid = false;
                            errMsg = "Numéro invalide (trop court/long)";
                        }
                    }

                    if(!isPhoneValid) {
                        setFieldError('container-phone', 'error-phone', errMsg);
                        isValid = false;
                    } else {
                        clearFieldError('container-phone', 'error-phone');
                    }
                    
                    // Email Check (Regex)
                    const emailInput = document.getElementById('email');
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if(!emailRegex.test(emailInput.value.trim())) {
                        setFieldError('container-email', 'error-email');
                        isValid = false;
                    } else {
                        clearFieldError('container-email', 'error-email');
                    }
                    
                    // IF INVALID: Stop everything (including global listeners)
                    if(!isValid) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    
                    e.preventDefault(); 
                    
                    // IF VALID: Proceed with elite animation
                    
                    // 1. PREPARE THE ENVIRONMENT (The "Sanctuary" Setup)
                    // Close mobile keyboard
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                    // Lock Body Scroll
                    document.body.style.overflow = 'hidden';
                    
                    // 2. ACTIVATE OVERLAY (THE ANTI-GLITCH TECHNIQUE)
                    const overlay = document.getElementById('processing-overlay');
                    const textElement = document.getElementById('processing-text');
                    
                    if(overlay) {
                        overlay.style.display = 'flex'; // 1. Put it in the DOM
                        
                        // 2. Force Browser Repaint (Critical for Safari)
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                overlay.classList.add('active'); // 3. Animate Opacity/Scale
                            });
                        });
                    }
                    
                    // 3. THE NARRATIVE (Slow & Reassuring)
                    const steps = [
                        { text: "CONNEXION CONCIERGE...", delay: 0 },
                        { text: "VÉRIFICATION DISPO...", delay: 2000 },
                        { text: "PRIORISATION VIP...", delay: 4500 },
                        { text: "SÉCURISATION TABLE...", delay: 7000 },
                        { text: "CONFIRMATION...", delay: 9000 }
                    ];
                    
                    // 4. EXECUTE SEQUENCE (Blur Text Transition)
                    let stepIndex = 0;
                    if(window.sequenceTimer) clearTimeout(window.sequenceTimer);

                    const runSequence = () => {
                        if (!textElement) return;
                        
                        const step = steps[stepIndex];
                        if (!step) return; 

                        // A. Exit Previous Text (Blur Out)
                        if (stepIndex > 0) {
                            textElement.classList.remove('text-visible');
                            textElement.classList.add('text-hidden');
                        }

                        // Wait for fade out (longer for calmness)
                        const fadeDelay = stepIndex === 0 ? 0 : 700; 

                        setTimeout(() => {
                            // B. Change Text Content
                            textElement.textContent = step.text;

                            // C. Enter New Text (Blur In)
                            requestAnimationFrame(() => {
                                textElement.classList.remove('text-hidden');
                                textElement.classList.add('text-visible');
                            });

                            // D. Schedule Next
                            stepIndex++;
                            if (stepIndex < steps.length) {
                                const nextDelay = steps[stepIndex].delay - step.delay;
                                window.sequenceTimer = setTimeout(runSequence, nextDelay);
                            }
                        }, fadeDelay);
                    };

                    runSequence();      });
            </script>
        </section>


<section class="section reveal" id="faq">
            <div class="section-header">
                <h2>L'Excellence, en toute simplicité</h2>
                <p>Votre expérience commence dès maintenant.</p>
            </div>
            <div class="accordion">
                <!-- OBJECTION 1: PAYMENT (Framed as Liberty) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>Comment s'effectue le règlement ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
    <p><strong>En toute liberté.</strong> Notre service de conciergerie est entièrement offert. Vous réglez vos consommations directement sur place, auprès de l'établissement, à la fin de votre soirée. Aucune coordonnée bancaire n'est requise ici.</p>
                    </div>
                </div>

                <!-- OBJECTION 2: STATUS (Framed as Privilege) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>Quels sont les privilèges de votre service ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
    <p>En passant par Marrakech Top Spot, vous n'êtes pas un simple client, mais un <strong>invité attendu</strong>. Nos partenaires nous accordent une priorité sur le placement des tables afin de vous garantir la meilleure visibilité sur le spectacle.</p>
                    </div>
                </div>

                <!-- OBJECTION 3: CONCIERGE WORKFLOW (Framed as Support) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>Puis-je personnaliser ma soirée (Anniversaire, Transport) ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
                        <p>Absolument. Une fois votre Guestlist validée, vous aurez un accès direct à notre <strong>Ligne WhatsApp Prioritaire</strong>. Votre concierge sera à votre écoute pour orchestrer les détails : gâteau d'anniversaire, navette privée ou préférences alimentaires.</p>
                    </div>
                </div>

                <!-- OBJECTION 4: DRESS CODE (Removing Social Anxiety) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>Quel est le style vestimentaire recommandé ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
                        <p>L'esprit est à <strong>l'élégance décontractée</strong> ("Chic & Casual"). Marrakech est une ville de fête : sentez-vous libre d'être beau et à l'aise. Les tenues de soirée sont appréciées, tout comme le style vacancier soigné.</p>
                    </div>
                </div>

                <!-- OBJECTION 5: CUISINE (Quality Assurance) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>La cuisine est-elle variée ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
                        <p>Oui. Notre sélection privilégie les établissements offrant une double expérience : l'authenticité de la <strong>Gastronomie Marocaine Fine</strong> et des alternatives Internationales de qualité. Végétariens et palais exigeants trouveront leur bonheur.</p>
                    </div>
                </div>

                <!-- OBJECTION 6: SPEED (Framed as Instant Gratification) -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h4>La confirmation est-elle immédiate ?</h4>
                        <span class="accordion-toggle">+</span>
                    </div>
                    <div class="accordion-content">
                        <p>Oui, <strong>instantanée</strong>. Dès validation du formulaire, votre nom est inscrit sur la liste du soir. Vous recevez votre confirmation à l'écran et pouvez immédiatement contacter le concierge si vous avez une question de dernière minute.</p>
                    </div>
                </div>
            </div>
        </section>


    </main>

    <footer>
        <p>© 2025 Marrakech Top Spot. Le Curateur de Vos Soirées d'Exception.</p>
    </footer>

    <!-- === V24 ULTIMATE STORY OVERLAY === -->
    <div id="storyOverlay" class="story-overlay">
        <div class="story-container">
            <div class="story-ui-top">
                <div class="story-progress-bar" id="storyProgressBar"></div>
                <div class="story-controls-row">
                    <div class="story-brand" id="storyBrandName">RESTAURANT NAME</div>
                    <div class="story-actions">
                        <div class="story-icon" id="soundToggle">
                            <svg id="iconMute" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
                            <svg id="iconSound" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        </div>
                        <div class="story-icon" id="storyCloseBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="story-media-wrapper" id="storyMediaWrapper"></div>
            <div class="story-nav-zone nav-left" id="storyNavLeft"></div>
            <div class="story-nav-zone nav-center" id="storyNavHold"></div>
            <div class="story-nav-zone nav-right" id="storyNavRight"></div>
            <div class="story-footer" id="storyTextContent">
                <h3 class="story-title-text" id="storyTitle">Restaurant Name</h3>
                <p class="story-desc-text" id="storyDesc">Description here...</p>
                <button class="story-cta-btn" id="storyBookBtn">RÉSERVER CETTE TABLE</button>
                <div class="story-trust">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Réservation 100% gratuite
                </div>
            </div>
            <div class="story-climax-card" id="climaxCard">
                <div class="climax-phantom-layer" id="climaxBgContainer"></div>
                <div class="climax-gradient-overlay"></div>
                <div class="climax-content">
                    <h2 class="climax-title" id="climaxTitle">Restaurant Name</h2>
                    <div class="climax-badge">
                        <div class="climax-stars">
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                        <span class="climax-badge-text">Excellence Confirmée</span>
                    </div>
                    <p class="climax-desc" id="climaxDesc">Une soirée inoubliable vous attend. Tables limitées pour ce soir.</p>
                    <button class="climax-cta" id="climaxBtn">VALIDER MA TABLE VIP</button>
                    <div class="story-trust">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Réservation Gratuite & Instantanée
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- === V2 ELITE MENU MODAL (OPTIMIZED FOR PERFORMANCE & SCROLLING) === -->
<div class="menu-modal-overlay" id="menuModal">
    <div class="menu-modal-content">
        <div class="menu-header">
            <h3 id="menu-title">Carte & Menu</h3>
            <div class="close-menu" onclick="MenuEngine.close()">×</div>
        </div>
        <!-- This container is CRITICAL for smooth scrolling on iOS -->
        <div class="menu-iframe-container" id="iframeContainer">
            <!-- The PDF viewer and loader will be injected here by the Elite MenuEngine -->
        </div>
    </div>
</div>

    <!-- === V88 ELITE WHATSAPP CONSOLE === -->
    <a href="https://wa.me/212680802756?text=Bonjour%2C%20j%27aimerais%20v%C3%A9rifier%20les%20disponibilit%C3%A9s%20pour%20un%20d%C3®ner%20spectacle." target="_blank" class="wa-sticky-container" id="waSticky">
        <div class="wa-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFFFFF" width="26" height="26"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.68-2.031-.967-.272-.099-.47-.149-.669.198-.198.347-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.173.198-.297.297-.495.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413z"/></svg>
            <span class="wa-status-dot"></span>
        </div>
        <div class="wa-text-col">
            <span class="wa-title">Concierge Direct</span>
            <span class="wa-subtext" id="waDynamicText">Statut VIP : <span class="wa-highlight">Prioritaire</span></span>
        </div>
    </a>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // === GLOBAL STATE ===
            // This flag prevents the "Flicker" when clicking a card
            window.isProgrammaticScroll = false;

/* === HERO VIDEO CONTROLLER (ULTIMATE: FADE ENGINE + SCROLL AWARE) === */
window._wq = window._wq || [];
let heroVideoApi = null;
let heroIsMuted = true;
let fadeInterval = null; // Stores the active fade timer

// This single, robust handler will attach to whichever video was loaded by the inline script.
// We use the `initialVideoId` variable that was set globally by that script.
window._wq.push({
    id: window.initialVideoId, // CORRECTLY BINDING TO THE DYNAMICALLY LOADED VIDEO
    options: {
        autoPlay: true,
        muted: true, // Start muted for browser compliance
        controlsVisibleOnLoad: false,
        copyLinkAndThumbnailEnabled: false,
        playbar: false,
        volume: 0,
        endVideoBehavior: "default",
        wmode: "transparent",
        preload: "auto"
    },
    onReady: function(video) {
        heroVideoApi = video; // The API is now correctly captured.
        
        // 1. Force Immediate Play (Silent)
        video.volume(0);
        video.mute();
        video.play();

        // 2. Loop Logic (Seamless)
        video.bind('end', function() {
            heroIsMuted = true;
            video.volume(0);
            video.mute();
            video.time(0);
            video.play();
            updateBadgeUI();
        });

        // 3. SMART SCROLL OBSERVER
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) {
                    // LEFT VIEWPORT: Fade Out -> Pause
                    if (!heroIsMuted) {
                        fadeAudio(video, 0, 800, () => {
                            video.mute();
                            heroIsMuted = true;
                            video.pause();
                            updateBadgeUI();
                        });
                    } else {
                        // If already silent, just pause immediately
                        video.pause();
                    }
                } else {
                    // ENTERED VIEWPORT: Play
                    video.play();
                    
                    // If we were fading out but user scrolled back up quickly, 
                    // cancel fade out and restore volume (Optional Polish)
                    if (fadeInterval) clearInterval(fadeInterval);
                }
            });
        }, { threshold: 0.15 }); // Trigger when 15% of hero is visible

        const heroSection = document.getElementById('heroSection');
        if(heroSection) observer.observe(heroSection);
    }
});

// === THE AUDIO FADER ENGINE ===
function fadeAudio(video, targetVolume, duration, callback) {
    // Clear any running fades to prevent conflicts
    if (fadeInterval) clearInterval(fadeInterval);

    const startVolume = video.volume();
    const startTime = Date.now();
    
    fadeInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1); // 0.0 to 1.0
        
        // Calculate new volume based on progress
        const newVolume = startVolume + (targetVolume - startVolume) * progress;
        
        video.volume(newVolume);

        if (progress >= 1) {
            clearInterval(fadeInterval);
            fadeInterval = null;
            if (callback) callback(); // Run finish action (like pausing)
        }
    }, 50); // Update every 50ms for smoothness
}

window.toggleHeroSound = function() {
    if (!heroVideoApi) return; // Guard clause
    
    // Clear any active fades first
    if (fadeInterval) clearInterval(fadeInterval);
    
    if (heroIsMuted) {
        // === UNMUTE (Fade In) ===
        heroVideoApi.unmute();
        heroVideoApi.time(0); // Restart for impact
        heroVideoApi.play();
        heroIsMuted = false;
        
        // Fade from 0 to 1 over 600ms
        heroVideoApi.volume(0);
        fadeAudio(heroVideoApi, 1, 600);
        
    } else {
        // === MUTE (Fade Out) ===
        fadeAudio(heroVideoApi, 0, 600, () => {
            heroVideoApi.mute();
            heroIsMuted = true;
        });
    }
    updateBadgeUI();
};

function updateBadgeUI() {
    const badge = document.getElementById('videoSoundBadge');
    if(!badge) return;

    if (heroIsMuted) {
        badge.classList.remove('badge-hidden');
    } else {
        badge.classList.add('badge-hidden');
    }
}

/* === TRUST BAR COUNTER ANIMATION === */
function animateCounter(element, start, end, duration, isFloat = false) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        let currentValue = progress * (end - start) + start;
        if (isFloat) {
            element.innerHTML = `${currentValue.toFixed(2).replace('.',',')}/5`;
        } else {
            element.innerHTML = `${Math.floor(currentValue).toLocaleString('fr-FR')}+`;
        }
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

const trustBarObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const tablesCounter = document.getElementById('counter-tables');
            const ratingCounter = document.getElementById('counter-rating');
            
            animateCounter(tablesCounter, 0, 1200, 1500, false);
            animateCounter(ratingCounter, 0, 4.85, 1500, true);

            trustBarObserver.unobserve(entry.target);
        }
    });
}, { threshold: 0.8 });

trustBarObserver.observe(document.querySelector('.trust-bar'));


// === V88 ELITE WHATSAPP LOGIC (SMART COLLISION) ===
function initEliteWhatsApp() {
    const waBtn = document.getElementById('waSticky');
    const waText = document.getElementById('waDynamicText');
    
    // Triggers
    const reviewsSection = document.getElementById('testimonialsSection');
    const formContainer = document.querySelector('.form-container');
    const faqSection = document.getElementById('faq');

    // === CHANGED: TARGET THE 1ST CARD ===
    const firstReviewCard = document.querySelector('.testimonials-grid .testimonial-card-new:first-child');

    if (!waBtn || !reviewsSection || !formContainer) return;

    let isVisible = false;
    let currentContext = ''; 
    let ticking = false;

    // === UTILITIES ===
    const updateWidget = () => {
        // 1. GLOBAL KILL SWITCH (Prevents flicker during programmatic scroll)
        if (window.isProgrammaticScroll) {
            hide();
            return;
        }

        const viewportHeight = window.innerHeight;
        
        // Get Rects
        const rForm = formContainer.getBoundingClientRect();
        const rFaq = faqSection ? faqSection.getBoundingClientRect() : { top: 99999 };
        
        // === UPDATED TRIGGER LOGIC ===
        let hasReachedTrigger = false;

        if (firstReviewCard) {
            const rCard = firstReviewCard.getBoundingClientRect();
            // Trigger immediately when the top of the 1st card enters the viewport
            // We use -20px buffer just to make sure it's engaged
            hasReachedTrigger = rCard.top < (viewportHeight - 20);
        } else {
            // Fallback to section header if card not found
            const rReviews = reviewsSection.getBoundingClientRect();
            hasReachedTrigger = rReviews.top < (viewportHeight - 100);
        }

        // === 2. COLLISION DETECTION (THE FORM) ===
        // We define a "Danger Zone" where the button lives
        const dangerZoneHeight = 120; 
        const formIsCoveringButton = (rForm.top < (viewportHeight - dangerZoneHeight)) && (rForm.bottom > dangerZoneHeight);

        // === DECISION ENGINE ===
        
        // PRIORITY 1: If Form is covering the button area -> HIDE
        if (formIsCoveringButton) {
            hide();
        } 
        // PRIORITY 2: If we are deep in FAQ (past form) -> SHOW
        else if (rFaq.top < (viewportHeight - 100)) {
             show("Une question ? <span class='wa-highlight'>Réponse < 1 min</span>");
        }
        // PRIORITY 3: If we have reached the 1st Card (and not covering form) -> SHOW
        else if (hasReachedTrigger) {
            show("Dernières tables : <span class='wa-highlight'>Disponibles</span>");
        } 
        // DEFAULT: We are in Hero or Experiences -> HIDE
        else {
            hide();
        }
    };

    const show = (htmlContent) => {
        if (!isVisible || currentContext !== htmlContent) {
            waBtn.classList.remove('ducked');
            waBtn.classList.add('visible');
            
            if (waText && htmlContent && waText.innerHTML !== htmlContent) {
                // Smooth text swap
                waText.style.transition = 'opacity 0.2s ease';
                waText.style.opacity = '0';
                setTimeout(() => {
                    waText.innerHTML = htmlContent;
                    waText.style.opacity = '1';
                }, 200);
            }
            isVisible = true;
            currentContext = htmlContent;
        }
    };

    const hide = () => {
        if (isVisible) {
            waBtn.classList.remove('visible');
            waBtn.classList.add('ducked'); 
            isVisible = false;
        }
    };

    // 60FPS Scroll Handler
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateWidget();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });

    // Initial check on load
    setTimeout(updateWidget, 500);
}

// === V89 DATA: MULTI-CATEGORY ENABLED ===

const experiencesData = window.experiencesData = [
    {
        id: "malak",
        name: "Malak Emeraude",
        categories: ["grand-spectacle"],
        smartLabel: "Prestige Spectacle",
        price: "Hivernage",
        rating: "4.3",
        reviews: "2400+",
        time: "20h00 - 02h30",
        description: "Le show le plus éblouissant de Marrakech. Dînez face aux montagnes de l'Atlas et laissez-vous emporter par un spectacle live grandiose. Le mélange parfait entre haute gastronomie et magie pure.",
        image: "https://MTSZone.b-cdn.net/MalakV2/ThumbOfficial.jpg",
        gallery: ["https://MTSZone.b-cdn.net/MalakV2/Malak7.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak11.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak6.jpg", "https://MTSZone.b-cdn.net/MalakV2/Malak3.jpg", "https://MTSZone.b-cdn.net/Malak/Malak2.jpg", "https://MTSZone.b-cdn.net/Malak/NewMalak10.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak6.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak2.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak4.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak1.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak8.jpg", "https://MTSZone.b-cdn.net/MalakV2/NewMalak9.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Malak/Malak13.jpg",
        video: "https://player.mediadelivery.net/embed/555558/125da33f-a663-48d9-b111-cae2bfb4b268",
        audio: "https://MTSZone.b-cdn.net/Malak5.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Malak/Please_upgrade_this_202601051514%20(1)_compressed.pdf",
        menuPrice: 60,
        popular: true
    },
    {
        id: "ibrahim",
        name: "Ibrahim Pacha",
        categories: ["grand-spectacle"],
        smartLabel: "Épopée Royale",
        price: "Hivernage",
        rating: "4.7",
        reviews: "1000+",
        time: "20h00 - 02h30",
        description: "Entrez dans la peau d'un Sultan. Un palais somptueux pour un dîner-spectacle unique de 3 heures. Festin royal, décors incroyables et une ambiance digne des mille et une nuits.",
        image: "https://MTSZone.b-cdn.net/Brahim%20Pacha/BrahimThumb3%20(1).jpeg",
        gallery: ["https://MTSZone.b-cdn.net/Pacha%20V2/Brahim10.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/NewPacha2.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha7.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/NewPacha7.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha8.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha9.jpg", "https://MTSZone.b-cdn.net/Pacha%20V2/Brahim1.jpg", "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha88.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Brahim%20Pacha/NewPacha888.jpg",
        video: "https://player.mediadelivery.net/embed/555558/a267114f-9b0b-4fb8-9d7b-e0e01e5344bc",
        audio: "https://MTSpull.b-cdn.net/iBrahimPachaAudio.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Menus/ibrahim-pacha-menu-avec%20compression.pdf",
        menuPrice: 60,
        popular: true
    },
    {
        id: "nouba",
        name: "Nouba Restaurant",
        categories: ["grand-spectacle", "party"],
        smartLabel: "Aerial Jungle",
        price: "Agdal",
        rating: "4.2",
        reviews: "90+",
        time: "19h30 - 23h15",
        description: "Une jungle chic et festive. Dînez sous une végétation luxuriante pendant que des acrobates volent au-dessus de vous. Une explosion de saveurs qui se transforme en soirée clubbing inoubliable.",
        image: "https://MTSpull.b-cdn.net/Nouba/ThumbNoubaMeh1.jpg",
        gallery: ["https://MTSpull.b-cdn.net/Nouba/Nouba7.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba10.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba1.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba11.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba12.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba9.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba8.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba2.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba3.jpg", "https://MTSpull.b-cdn.net/Nouba/Nouba5.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/Nouba/Nouba4.jpg",
        video: "https://player.mediadelivery.net/embed/555558/2613ac43-fc55-4d5d-a837-94705b17e6db",
        audio: "https://MTSpull.b-cdn.net/NoubaAudio1.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Menus/Nouba-menu-avec%20compression.pdf",
        menuPrice: 75,
        popular: false
    },
    {
        id: "stah",
        name: "Stah Rooftop",
        categories: ["party", "grand-spectacle"],
        smartLabel: "Starlit Rooftop",
        price: "Agdal",
        rating: "4.5",
        reviews: "150+",
        time: "19h30 - 01h00",
        description: "Le rooftop incontournable. Tapas créatives, cocktails et bonne musique directement sous les étoiles. L'endroit idéal pour dominer la ville dans une ambiance décontractée et branchée.",
        image: "https://MTSpull.b-cdn.net/stah/StahThum2.jpg",
        gallery: ["https://MTSpull.b-cdn.net/stah/Stah4V2.jpg", "https://MTSpull.b-cdn.net/stah/Stah6V2.jpg", "https://MTSpull.b-cdn.net/stah/Stah1.jpg", "https://MTSpull.b-cdn.net/stah/Stah9.jpg", "https://MTSpull.b-cdn.net/stah/Untitled-LiveDoc-(37).jpg", "https://MTSpull.b-cdn.net/stah/Stah12.jpg", "https://MTSpull.b-cdn.net/stah/Stah11.jpg", "https://MTSpull.b-cdn.net/stah/Stah5.jpg", "https://MTSpull.b-cdn.net/stah/Stah8.jpg", "https://MTSpull.b-cdn.net/stah/Stah2.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/stah/Stah3.jpg",
        video: "https://player.mediadelivery.net/embed/555558/c9e02c8e-79a4-4325-95bc-27b4e2de904e",
        audio: "https://MTSpull.b-cdn.net/StahJBV5.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Menus/STA7_Menu-avec%20compression.pdf",
        menuPrice: 40,
        popular: false
    },
    {
        id: "noto",
        name: "Noto Marrakech",
        categories: ["party"],
        smartLabel: "Italian Euphoria",
        price: "Hivernage",
        rating: "4.5",
        reviews: "300+",
        time: "19h30 - 23h15",
        description: "La Dolce Vita en version festive. Savourez une cuisine italienne ensoleillée dans une ambiance électrique. Musiciens live et énergie débordante : c'est l'Italie qui fait la fête à Marrakech.",
        image: "https://MTSZone.b-cdn.net/NOTO/Thumbnail5.jpg",
        gallery: ["https://MTSZone.b-cdn.net/NOTO/Noto15.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto9.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto14.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto8.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto11.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto12.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto1.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto10.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto7.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto5.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto16.jpg", "https://MTSZone.b-cdn.net/NOTO/Noto17.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/NOTO/Noto18.jpg",
        video: "https://player.mediadelivery.net/embed/555558/6c744bc3-630c-4715-9b9d-563263c50a82",
        audio: "https://MTSZone.b-cdn.net/NOTO/NoubaFestifAudio1.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/NOTO/CARTE-NOTO-MAROC-compressed.pdf",
        menuPrice: 70,
        popular: false
    },
    {
        id: "ritziF",
        name: "Ritzi Restaurant",
        categories: ["party"],
        smartLabel: "Danse & Glamour",
        price: "Hivernage",
        rating: "4.4",
        reviews: "1000+",
        time: "12h00 - 23h30",
        description: "Le glamour à l'état pur. Une cuisine méditerranéenne raffinée qui laisse place à la danse. Chic, élégant et vibrant : la soirée parfaite pour ceux qui aiment faire la fête avec classe.",
        image: "https://MTSZone.b-cdn.net/Ritzi/Thumbnail2.jpg",
        gallery: ["https://MTSZone.b-cdn.net/Ritzi/Ritzi3-1.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi7.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi2.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi9.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi10.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi14.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi15.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi12.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi11.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi1.jpg", "https://MTSZone.b-cdn.net/Ritzi/RitziColored.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Ritzi/Ritzi18.jpg",
        video: "https://player.mediadelivery.net/embed/555558/120c46bd-d7c8-4d0e-88a3-46e51a1b92aa",
        audio: "https://MTSZone.b-cdn.net/Ritzi/AudioRitziF2.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Ritzi/MenuRitzi-1_compressed.pdf",
        menuPrice: 50,
        popular: true
    },
    {
        id: "ritziD",
        name: "Ritzi Restaurant",
        categories: ["grand-spectacle"],
        smartLabel: "Intimité Artistique",
        price: "Hivernage",
        rating: "4.4",
        reviews: "1000+",
        time: "12h00 - 23h30",
        description: "Un dîner-spectacle intime et chic. Laissez-vous séduire par des artistes de classe mondiale tout en dégustant des plats d'exception. Une parenthèse de luxe au cœur de l'Hivernage.",
        image: "https://MTSZone.b-cdn.net/Ritzi/Thumbnail2.jpg",
        gallery: ["https://MTSZone.b-cdn.net/Ritzi/Ritzi3-1.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi7.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi2.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi9.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi10.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi14.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi15.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi12.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi11.jpg", "https://MTSZone.b-cdn.net/Ritzi/Ritzi1.jpg", "https://MTSZone.b-cdn.net/Ritzi/RitziColored.jpg"],
        finalImage: "https://MTSZone.b-cdn.net/Ritzi/Ritzi18.jpg",
        video: "https://player.mediadelivery.net/embed/555558/63ac7535-b40c-40a9-a7fc-73bce4ef80fa",
        audio: "https://MTSZone.b-cdn.net/Ritzi/RitziAudio.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/Ritzi/MenuRitzi-1_compressed.pdf",
        menuPrice: 50,
        popular: true
    },
    {
        id: "folk",
        name: "Folk Restaurant",
        categories: ["authentic", "party"],
        smartLabel: "Danse & Gnaoua",
        price: "Guéliz",
        rating: "4.4",
        reviews: "400+",
        time: "19h30 - 23h15",
        description: "Vibrez au rythme de Marrakech. Une immersion totale dans la culture Gnaoua. Cuisine marocaine savoureuse et musique envoûtante pour une soirée qui touche l'âme.",
        image: "https://MTSZone.b-cdn.net/LeGrandBazar/Thumboff.jpg",
        gallery: ["https://MTSpull.b-cdn.net/Folk/Folk8.jpg", "https://MTSpull.b-cdn.net/Folk/Folk1.jpg", "https://MTSpull.b-cdn.net/Folk/Folk4.jpg", "https://MTSpull.b-cdn.net/Folk/Folk3.jpg", "https://MTSpull.b-cdn.net/Folk/Folk2.jpg", "https://MTSpull.b-cdn.net/Folk/Folk9.jpg", "https://MTSpull.b-cdn.net/Folk/Folk7.jpg"],
        finalImage: "https://MTSpull.b-cdn.net/Folk/Folk6.jpg",
        video: "https://player.mediadelivery.net/embed/555558/4e641eb3-3629-42db-b2f6-5ca55283e7fc",
        audio: "https://MTSpull.b-cdn.net/FolkAudio.MP3",
        menuUrl: "https://MTSZone.b-cdn.net/folk-menu-marrakechtopspot1_compressed.pdf",
        menuPrice: 45,
        popular: false
    },
    { 
        id: "tanjia", 
        name: "Le Tanjia", 
        categories: ["authentic"], 
        smartLabel: "Riad Légendaire",
        price: "Médina", 
        rating: "4.0", 
        reviews: "2500+", 
        time: "12h00 - 23h15", 
        description: "La magie d'un Riad historique. Plongez au cœur de la Médina pour un dîner marocain légendaire. Danseuses orientales et architecture traditionnelle pour une nuit 100% authentique.",
        image: "https://MTSpull.b-cdn.net/Tanjia/ThumbTanjia1.jpg", 
        gallery: ["https://MTSpull.b-cdn.net/Tanjia/Tanjia9.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia4.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia1.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia3.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia8.jpg", "https://MTSpull.b-cdn.net/Tanjia/Tanjia5.jpg"], 
        finalImage: "https://MTSpull.b-cdn.net/Tanjia/Tanjia7.jpg",
        video: "https://player.mediadelivery.net/embed/555558/7ae42fd5-ecf2-4b7f-bfe1-3695c1899bb2",
        audio: "https://MTSpull.b-cdn.net/TanjiaAudio.MP3",
        menuUrl: "https://MTSpull.b-cdn.net/TANJIA.pdf.pdf",
        menuPrice: 35,
        popular: false 
    }
];

            
            const grid = document.querySelector('.spectacles-grid');
            const select = document.getElementById('experience-select');
            const dateInput = document.getElementById('date');
            const timeInput = document.getElementById('booking_time');
            const timeContainer = document.getElementById('time-slot-container');
            const timeLoader = document.getElementById('time-loader');
            const partySizeButtons = document.querySelectorAll('.party-size-btn');
            const partySizeInput = document.getElementById('party_size');

            const fragment = document.createDocumentFragment();

            const buildTimeSlotsFromRange = (rangeStr) => {
                if(!rangeStr) return [];
                const parts = rangeStr.split('-').map(p => p.trim());
                if(parts.length !== 2) return [];
                
                const toMinutes = (str) => {
                    const [h, m] = str.replace('h', ':').split(':').map(n => parseInt(n, 10));
                    if(Number.isNaN(h) || Number.isNaN(m)) return null;
                    return h * 60 + m;
                };
                
                const start = toMinutes(parts[0]);
                const endRaw = toMinutes(parts[1]);
                if(start === null || endRaw === null) return [];
                
                // Support windows that pass midnight
                const end = endRaw <= start ? endRaw + 24 * 60 : endRaw;
                
                const slots = [];
                for(let t = start; t <= end; t += 30) {
                    const hh = Math.floor(t / 60) % 24;
                    const mm = t % 60;
                    const label = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
                    slots.push(label);
                }
                return slots;
            };

experiencesData.forEach((exp, index) => {
    const card = document.createElement('div');
    card.className = `spectacle-card reveal reveal-delay-${(index % 3) + 1}`;
    
    // CHANGE: Join categories with a space for the data attribute
    card.dataset.categories = exp.categories.join(" "); 
    card.dataset.id = exp.id;
    
    const popularBadge = exp.popular ? `<span class="popular-badge"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>` : '';
    
    card.innerHTML = `
        <div class="card-image" onclick="StoryManager.open('${exp.id}')">
            <img loading="lazy" decoding="async" src="${exp.image}" alt="${exp.name}" width="600" height="400">
            <div class="card-image-overlay"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg></div>
            <div class="media-badge"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> GALERIE & VIDÉO</div>
            <span class="spectacle-type-badge">${exp.smartLabel}</span>
            ${popularBadge}
        </div>
        <div class="card-content">
            <h3 class="card-title">${exp.name}</h3>
            <div class="card-rating"><span class="stars">★★★★★</span> <span class="review-count">${exp.rating}/5 (${exp.reviews} avis)</span></div>
            <p class="card-description">${exp.description}</p>
            <div class="card-meta"><span>${exp.time} • Tous les soirs</span> <span class="price-range">${exp.price}</span></div>
            <div class="trust-box"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> Aucun prépaiement requis • Paiement sur place</div>
            <div class="card-actions-container">
                <button class="card-btn btn-menu" onclick="openMenu('${exp.menuUrl}')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>VOIR CARTE (~ ${exp.menuPrice}€ / pers.)</button>
                <button class="card-btn btn-book" onclick="selectExperienceAndScroll('${exp.id}')">BLOQUER MA TABLE (0€)</button>
            </div>
        </div>`;
    fragment.appendChild(card);
    

if (exp.id !== 'ritziF') {
        const option = document.createElement('option');
        option.value = exp.id; 
        option.textContent = exp.name;
        select.appendChild(option);
    }
});
            grid.appendChild(fragment);

/* === OPTIMIZATION START: ELITE TEASER ENGINE (WITH VIDEO PRELOAD) === */
/* === OPTIMIZATION START: ELITE TEASER ENGINE (WITH CUSTOM TIMING) === */
function initTeaserEngine() {
    // Map to store timeout IDs
    const cardTimers = new Map();
    
    // Config
    const DEFAULT_DELAY = 1200; // 1.2s for Restaurant Cards
    const ELITE_DELAY = 5000;   // 5.0s for Testimonial Cards (Requested)

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const card = entry.target;
            const experienceId = card.dataset.id;
            
            // Determine Delay based on Card Type
            const isTestimonial = card.classList.contains('testimonial-card-new');
            const targetDelay = isTestimonial ? ELITE_DELAY : DEFAULT_DELAY;

            if (entry.isIntersecting) {
                // 1. Card entered view: Start the countdown
                if (!cardTimers.has(card)) {
                    const timerId = setTimeout(() => {
                        // 2. Timer finished: Trigger the animation
                        requestAnimationFrame(() => {
                            card.classList.add('teaser-active');
                        });

                        // Preload Video Logic (Only for cards with video IDs)
                        if (experienceId && !isTestimonial) {
                            const experience = window.experiencesData.find(e => e.id === experienceId);
                            if (experience && experience.video) {
                                const preloadId = `preload-story-${experienceId}`;
                                if (!document.getElementById(preloadId)) {
                                    const preloadLink = document.createElement('link');
                                    preloadLink.id = preloadId;
                                    preloadLink.rel = 'preload';
                                    preloadLink.href = experience.video;
                                    preloadLink.as = 'document';
                                    document.head.appendChild(preloadLink);
                                }
                            }
                        }

                    }, targetDelay); // <--- USES DYNAMIC DELAY HERE
                    
                    cardTimers.set(card, timerId);
                }
            } else {
                // 3. Card left view: Abort mission immediately
                if (cardTimers.has(card)) {
                    clearTimeout(cardTimers.get(card));
                    cardTimers.delete(card);
                }
                // Reset visual state
                requestAnimationFrame(() => {
                    card.classList.remove('teaser-active');
                });
            }
        });
    }, {
        threshold: 0.6, 
        rootMargin: "0px" 
    });

    // Initialize
    setTimeout(() => {
        const cards = document.querySelectorAll('.spectacle-card, .testimonial-card-new');
        cards.forEach(card => observer.observe(card));
    }, 100);
}
/* === OPTIMIZATION END === */

// Call this function at the end of your existing DOMContentLoaded
initTeaserEngine();
            
            // ACTIVATE WHATSAPP
            initEliteWhatsApp(); // <--- UPDATED
            
            dateInput.setAttribute('min', new Date().toISOString().split('T')[0]);

            partySizeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    partySizeButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    partySizeInput.value = button.dataset.value;
                }, {passive: true});
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0, rootMargin: "0px 0px 250px 0px" });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

function fetchTimeSlots() {
                const selectedSlug = select.value;
                const date = dateInput.value;
                if (!selectedSlug || !date) return;

                timeContainer.classList.remove('hidden');
                timeInput.disabled = true;
                timeInput.innerHTML = '<option>Chargement...</option>';
                timeLoader.classList.remove('hidden');
                
                // --- START: World-Class Time Slot Filtering Logic ---

                // 1. Determine if the selected date is today in a timezone-safe way.
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-11
                const dd = String(today.getDate()).padStart(2, '0');
                const todayString = `${yyyy}-${mm}-${dd}`;
                const isBookingForToday = (date === todayString);

                // 2. If it's for today, calculate the earliest possible booking time.
                let earliestTime = null;
                if (isBookingForToday) {
                    earliestTime = new Date(); // Get current time
                    earliestTime.setMinutes(earliestTime.getMinutes() + 15); // Add 15 minutes buffer
                }

                // --- END: World-Class Time Slot Filtering Logic ---

                const currentExp = (window.experiencesData || []).find(e => e.id === selectedSlug);
                const allSlots = buildTimeSlotsFromRange(currentExp ? currentExp.time : null);

                // 3. Filter the generated slots if booking for today.
                const finalSlots = isBookingForToday ? allSlots.filter(slot => {
                    const [hours, minutes] = slot.split(':').map(Number);
                    const slotTime = new Date();
                    slotTime.setHours(hours, minutes, 0, 0); // Create a date object for the slot time today
                    return slotTime >= earliestTime; // Only keep slots that are in the future
                }) : allSlots; // Otherwise, use all available slots.

                setTimeout(() => {
                    timeInput.innerHTML = '<option value="" disabled selected>-- Choisir une heure --</option>';
                    
                    // 4. Gracefully handle cases where no future slots are available today.
                    if (finalSlots.length > 0) {
                        finalSlots.forEach(time => {
                            const opt = document.createElement('option');
                            opt.value = time;
                            opt.textContent = time;
                            timeInput.appendChild(opt);
                        });
                        timeInput.disabled = false;
                    } else {
                        const noSlotOption = document.createElement('option');
                        noSlotOption.textContent = "Aucun créneau disponible";
                        noSlotOption.disabled = true;
                        timeInput.appendChild(noSlotOption);
                        // The select remains disabled, preventing selection.
                    }
                    
                    timeLoader.classList.add('hidden');
                }, 250); // This delay simulates a network request, it is safe to keep.
            }
            select.addEventListener('change', fetchTimeSlots);
            dateInput.addEventListener('change', fetchTimeSlots);



        });

        // GLOBAL
        let currentSessionId = null;
        const API_BASE_URL = "https://arletha-isobathic-nonadjudicatively.ngrok-free.dev";

        window.goToStep = function(step) {
            if (step === 2) {
                const sel = document.getElementById('experience-select');
                const dat = document.getElementById('date');
                const tim = document.getElementById('booking_time');
                let error = false;
                
                if(!sel.value) { sel.style.borderColor = '#D72347'; error=true; } else { sel.style.borderColor = ''; }
                if(!dat.value) { dat.style.borderColor = '#D72347'; error=true; } else { dat.style.borderColor = ''; }
                if(!tim.value || tim.disabled) { tim.style.borderColor = '#D72347'; error=true; } else { tim.style.borderColor = ''; }
                
                if(error) return;

                if (currentSessionId) {
                    fetch(API_BASE_URL + '/api/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({ session_id: currentSessionId })
                    });
                    currentSessionId = null;
                }

                const restId = sel.value;
                
                fetch(API_BASE_URL + '/api/prewarm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ restaurant_id: restId })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.status === "READY") {
                        currentSessionId = data.session_id;
                    } 
                })
                .catch(e => console.error("Network Error:", e));
            }
            
            document.querySelectorAll('.form-step').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
            const nextStep = document.getElementById(`form-step-${step}`);
            nextStep.style.display = 'block';
            setTimeout(() => nextStep.classList.add('active'), 10);
            
            const formSection = document.getElementById('form');
            if (formSection) {
                // SET FLAG TO PREVENT WHATSAPP FLICKER
                window.isProgrammaticScroll = true;
                
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        formSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // RELEASE FLAG AFTER SCROLL
                        setTimeout(() => {
                            window.isProgrammaticScroll = false;
                            // Trigger a check immediately after scroll finishes
                            window.dispatchEvent(new Event('scroll'));
                        }, 1200); // 1.2s buffer for smooth scroll to finish
                    }, 100);
                });
            }
        };

        function selectExperienceAndScroll(experienceId) {
            if (experienceId === 'ritziF') experienceId = 'ritziD';
            const select = document.getElementById('experience-select');
            select.value = experienceId;
            
            // SET FLAG TO PREVENT WHATSAPP FLICKER
            window.isProgrammaticScroll = true;
            
            document.getElementById('form').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // RELEASE FLAG
            setTimeout(() => {
                window.isProgrammaticScroll = false;
                window.dispatchEvent(new Event('scroll'));
            }, 1200);

            const formContainer = document.querySelector('.form-container');
            formContainer.style.willChange = 'transform';
            formContainer.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
            formContainer.style.transform = 'scale(1.02) translateZ(0)';
            formContainer.style.boxShadow = '0 0 30px rgba(236, 80, 117, 0.2)';
            setTimeout(() => { 
                formContainer.style.transform = 'scale(1) translateZ(0)'; 
                formContainer.style.boxShadow = ''; 
                formContainer.style.willChange = 'auto';
            }, 600);
            const event = new Event('change');
            select.dispatchEvent(event);
        }

        // ... [Rest of JS remains unchanged] ...
        function convertToAmPm(time24) {
            if (!time24) return "07:00 pm";
            let [hours, minutes] = time24.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'pm' : 'am';
            h = h % 12;
            h = h ? h : 12; 
            const strH = h < 10 ? '0' + h : h;
            return `${strH}:${minutes} ${ampm}`;
        }

        function showSuccessMessage(firstName) {
            document.getElementById('reservationForm').style.display = 'none';
            const successMsg = document.getElementById('success-message');
            document.getElementById('success-name').textContent = firstName;
            
            const expSelect = document.getElementById('experience-select');
            const timeSelect = document.getElementById('booking_time');
            
            document.getElementById('success-experience').textContent = expSelect.options[expSelect.selectedIndex].text;
            document.getElementById('success-date').textContent = document.getElementById('date').value;
            document.getElementById('success-time').textContent = timeSelect.options[timeSelect.selectedIndex].text;
            
            successMsg.style.display = 'block';
            successMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

document.getElementById('reservationForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // NEW CLEANUP CODE:
    if(window.sequenceTimer) {
        clearTimeout(window.sequenceTimer);
        window.sequenceTimer = null;
    }
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loader"></span> Sécurisation de la table en cours...';

            const countryCode = document.getElementById('country-code').value;
            const phoneBody = document.getElementById('whatsapp_number').value.replace(/^0+/, '');
            document.getElementById('whatsapp').value = countryCode + phoneBody;

            const fullName = document.getElementById('name').value.trim();
            const firstName = fullName.split(' ')[0];
            const rawTime = document.getElementById('booking_time').value;

            const requestData = {
                session_id: currentSessionId,
                restaurant_id: document.getElementById('experience-select').value,
                name: fullName,
                email: document.getElementById('email').value,
                phone: document.getElementById('whatsapp').value,
                adults: document.getElementById('party_size').value,
                children: document.getElementById('children_size').value, 
                target_date: document.getElementById('date').value,
                target_time: convertToAmPm(rawTime)
            };

            const VPS_API_URL = "https://arletha-isobathic-nonadjudicatively.ngrok-free.dev/api/reserve";

            fetch(VPS_API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                try {
                    if(typeof gtag !== 'undefined') {
                        const adsId = 'G-XXXXXXXXXX'; 
                        const adsLabel = 'YOUR_LABEL_HERE'; 
                        gtag('event', 'conversion', { 'send_to': `${adsId}/${adsLabel}` }); 
                    }
                } catch (e) {}

                if (data.status === "SUCCESS" && data.redirect_url) {
                    window.location.href = data.redirect_url;
                    return; 
                } else {
                    showSuccessMessage(firstName);
                }
            })
            .catch(error => {
                showSuccessMessage(firstName);
            });
        });

/* === OPTIMIZATION START: ELITE STORY MANAGER (WITH IMAGE PRELOAD) === */
window.StoryManager = {
    queue: [],
    currentIndex: 0,
    currentExp: null,
    timer: null,
    isPaused: false,
    isMuted: false, // Global mute state
    audioObj: new Audio(),
    currentVideoPlayer: null,
    imageDuration: 4000,
    hasUnlockedAudio: false,

    // 1. Initialization & Smart Controls
    init: function() {
        this.audioObj.loop = false;
        this.audioObj.volume = 1.0;
        this.audioObj.preload = 'auto';

        // Nav Controls
        document.getElementById('storyNavLeft').addEventListener('click', (e) => { e.stopPropagation(); this.prev(); });
        document.getElementById('storyNavRight').addEventListener('click', (e) => { e.stopPropagation(); this.next(); });
        
        // === NEW HYBRID CENTER CONTROL (Tap to Toggle / Hold to Pause) ===
        const holdZone = document.getElementById('storyNavHold');
        let touchStartTime = 0;
        let wasPausedBeforeTouch = false;

        const handleStart = (e) => {
            // Allow default for scrolling unless we are in the overlay (overlay handles scroll lock)
            if(e.cancelable && e.target.id === 'storyNavHold') e.preventDefault(); 
            
            touchStartTime = Date.now();
            wasPausedBeforeTouch = this.isPaused;
            
            // Visual feedback: Pause immediately on touch down
            this.pause(); 
        };

        const handleEnd = (e) => {
            if(e.cancelable && e.target.id === 'storyNavHold') e.preventDefault();
            
            const duration = Date.now() - touchStartTime;
            const isTap = duration < 250; // Anything under 250ms is a tap

            if (isTap) {
                // LOGIC: If it was paused before we touched, RESUME.
                // If it was playing, we paused it in handleStart, so we leave it PAUSED.
                if (wasPausedBeforeTouch) {
                    this.resume();
                }
            } else {
                // HOLD LOGIC: Always resume when finger leaves screen
                this.resume();
            }
        };

        // Bind events with passive: false to control behavior accurately
        holdZone.addEventListener('mousedown', handleStart);
        holdZone.addEventListener('mouseup', handleEnd);
        holdZone.addEventListener('touchstart', handleStart, {passive: false});
        holdZone.addEventListener('touchend', handleEnd, {passive: false});

        // Global Mute Toggle
        document.getElementById('soundToggle').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMute();
        });

        document.getElementById('storyCloseBtn').addEventListener('click', () => this.close());
        const bookAction = () => { this.close(); selectExperienceAndScroll(this.currentExp.id); };
        document.getElementById('storyBookBtn').addEventListener('click', bookAction);
        document.getElementById('climaxBtn').addEventListener('click', bookAction);

        // Silent Audio Unlocker (Primes the browser audio engine on first interaction)
        const unlockAudio = () => {
            if (this.hasUnlockedAudio) return;
            const p = this.audioObj.play();
            if (p !== undefined) {
                p.then(() => {
                    this.audioObj.pause();
                    this.audioObj.currentTime = 0;
                    this.hasUnlockedAudio = true;
                    ['click', 'touchstart', 'scroll'].forEach(evt => document.removeEventListener(evt, unlockAudio));
                }).catch(() => {});
            }
        };
        ['click', 'touchstart', 'scroll'].forEach(evt => document.addEventListener(evt, unlockAudio, { passive: true, once: true }));
    },

    // 2. Open Story
    open: function(id) {
        this.currentExp = (window.experiencesData || []).find(e => e.id === id);
        if(!this.currentExp) return;

        // Force Unlock if not done
        if(!this.hasUnlockedAudio) {
            this.audioObj.play().catch(()=>{}); 
            this.audioObj.pause();
            this.hasUnlockedAudio = true;
        }

        // UI Setup
        this.updateUI(this.currentExp);

        // Smart Duration Calculation based on Audio
if(this.currentExp.audio) {
    this.audioObj.src = this.currentExp.audio;
    this.audioObj.onloadedmetadata = () => {
        const total = this.audioObj.duration;
        if(total > 10) {
            const count = this.currentExp.gallery.length;

            // --- RESTORED V42 SYNC LOGIC ---
            // 1. Reserve 15% (or min 5s) for the Climax Card at the end
            const reservedForClimax = Math.max(5, total * 0.15);
            
            // 2. Subtract 15s buffer (This accounts for the Video Intro/Buildup)
            const availableTime = total - reservedForClimax - 15; 
            
            // 3. Calculate exact duration per image to fit the remaining window
            if(availableTime > 0 && count > 0) {
                this.imageDuration = (availableTime / count) * 1000;
                
                // 4. Clamp between 2.5s and 6s (V42 specific timing)
                this.imageDuration = Math.max(2500, Math.min(6000, this.imageDuration));
            }
            // --------------------------------
        }
    };
}

        // Build Queue
        this.queue = [];
        if(this.currentExp.video) this.queue.push({ type: 'video', src: this.currentExp.video });
        this.currentExp.gallery.forEach(img => this.queue.push({ type: 'image', src: img }));

        // Progress Bar
        const progContainer = document.getElementById('storyProgressBar');
        progContainer.innerHTML = '';
        this.queue.forEach(() => {
            const seg = document.createElement('div');
            seg.className = 'progress-segment';
            seg.innerHTML = '<div class="progress-fill"></div>';
            progContainer.appendChild(seg);
        });

        this.currentIndex = 0;
        this.isPaused = false;
        
        document.getElementById('storyOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        this.renderSlide();
    },

    // 3. Render Engine (Optimized)
    renderSlide: function() {
        const wrapper = document.getElementById('storyMediaWrapper');
        
        if(this.timer) clearTimeout(this.timer);
        this.timer = null;

        // Reset Progress Bars (Using Transform for GPU performance)
        const allFills = document.querySelectorAll('.progress-segment .progress-fill');
        allFills.forEach((fill, i) => {
            fill.style.transition = 'none';
            fill.style.transform = i < this.currentIndex ? 'scaleX(1)' : 'scaleX(0)';
        });

        if(this.currentIndex >= this.queue.length) {
            this.showClimax();
            return;
        }

        // --- OPTIMIZATION: PRELOAD NEXT IMAGE ---
        if(this.currentIndex + 1 < this.queue.length) {
            const next = this.queue[this.currentIndex + 1];
            if(next.type === 'image') {
                const img = new Image();
                img.src = next.src;
            }
        }
        // --- END OPTIMIZATION ---

        document.getElementById('climaxCard').classList.remove('active');
        document.getElementById('storyTextContent').classList.remove('hidden');

        const item = this.queue[this.currentIndex];
        const currentFill = allFills[this.currentIndex];
        wrapper.innerHTML = ''; 

        if(item.type === 'video') {
            this.playVideoSlide(item, wrapper, currentFill);
        } else {
            this.playImageSlide(item, wrapper, currentFill);
        }
    },

    // 4. Video Logic (FIXED FOR SOUND)
    playVideoSlide: function(item, container, progressBar) {
        if(this.isMuted) {
             this.audioObj.pause();
        } else {
             // Fade out music to let video audio take over
             this.fadeAudio(0, 300, true);
        }

        const iframe = document.createElement('iframe');
        const ts = new Date().getTime();
        
        // === THE SOUND FIX ===
        // We use muted=0 because this function runs AFTER a user click (open story).
        // Most browsers allow sound immediately in this context.
        let src = item.src;
        if(!src.includes('?')) src += '?';
        src += `&enablejsapi=1&autoplay=1&muted=0&playsinline=1&controls=0&modestbranding=1&ts=${ts}`;
        
        iframe.src = src;
        iframe.className = 'story-media-item';
        iframe.allow = "autoplay; fullscreen; accelerometer; encrypted-media; gyroscope; picture-in-picture";
        iframe.setAttribute('loading', 'eager');
        
        container.appendChild(iframe);
        
        requestAnimationFrame(() => iframe.classList.add('active'));

        const player = new playerjs.Player(iframe);
        this.currentVideoPlayer = player;

        player.on('ready', () => {
            // Safety: Ensure it plays
            player.play();
            
            // Double Check: Force volume if not globally muted
            if(!this.isMuted) {
                player.unmute();
                player.setVolume(100);
            }

            // Sync Progress
            player.getDuration((d) => {
                const dur = d ? d : 15;
                progressBar.style.transition = `transform ${dur}s linear`;
                progressBar.style.transform = 'scaleX(1)';
            });
        });

        player.on('ended', () => {
            this.next();
        });
    },

    // 5. Image Logic
    playImageSlide: function(item, container, progressBar) {
        this.currentVideoPlayer = null;
        
        if(!this.isMuted && this.audioObj.paused) {
            this.audioObj.play().catch(()=>{});
            this.fadeAudio(1, 400);
        }

        const img = document.createElement('img');
        img.src = item.src;
        img.className = 'story-media-item';
        
        container.appendChild(img);
        
        requestAnimationFrame(() => requestAnimationFrame(() => img.classList.add('active')));

        setTimeout(() => {
            progressBar.style.transition = `transform ${this.imageDuration}ms linear`;
            progressBar.style.transform = 'scaleX(1)';
        }, 50);

        this.timer = setTimeout(() => this.next(), this.imageDuration);
    },

    // 6. Audio Fader
    fadeAudio: function(targetVol, duration, pauseAtEnd = false) {
        const startVol = this.audioObj.volume;
        const steps = 10;
        const interval = duration / steps;
        const stepAmount = (targetVol - startVol) / steps;
        
        let counter = 0;
        const fadeTimer = setInterval(() => {
            counter++;
            let newVol = this.audioObj.volume + stepAmount;
            if(newVol < 0) newVol = 0;
            if(newVol > 1) newVol = 1;
            this.audioObj.volume = newVol;

            if(counter >= steps) {
                clearInterval(fadeTimer);
                this.audioObj.volume = targetVol;
                if(pauseAtEnd) this.audioObj.pause();
            }
        }, interval);
    },

    // 7. Toggle Mute
    toggleMute: function() {
        this.isMuted = !this.isMuted;
        
        document.getElementById('iconMute').classList.toggle('hidden', !this.isMuted);
        document.getElementById('iconSound').classList.toggle('hidden', this.isMuted);

        if(this.isMuted) {
            this.fadeAudio(0, 200, true);
            if(this.currentVideoPlayer) this.currentVideoPlayer.mute();
        } else {
            // If watching video, unmute video. If image, play music.
            if(this.currentVideoPlayer) {
                this.currentVideoPlayer.unmute();
                this.currentVideoPlayer.setVolume(100);
            } else {
                this.audioObj.play().catch(()=>{});
                this.fadeAudio(1, 200);
            }
        }
    },

    // 8. Navigation & Controls
    pause: function() {
        this.isPaused = true;
        const fill = document.querySelectorAll('.progress-segment')[this.currentIndex].querySelector('.progress-fill');
        if(fill) {
            const computed = window.getComputedStyle(fill);
            const matrix = computed.transform; 
            fill.style.transition = 'none';
            fill.style.transform = matrix;
        }
        clearTimeout(this.timer);
        if(this.currentVideoPlayer) this.currentVideoPlayer.pause();
        if(!this.audioObj.paused) this.audioObj.pause();
    },

    resume: function() {
        if(!this.isPaused) return;
        this.isPaused = false;
        
        const item = this.queue[this.currentIndex];
        const fill = document.querySelectorAll('.progress-segment')[this.currentIndex].querySelector('.progress-fill');

        if(item.type === 'video') {
            if(this.currentVideoPlayer) {
                this.currentVideoPlayer.play();
                fill.style.transition = 'transform 10s linear'; 
                fill.style.transform = 'scaleX(1)';
            }
        } else {
            if(!this.isMuted) {
                this.audioObj.play().catch(()=>{});
                this.fadeAudio(1, 200);
            }
            fill.style.transition = `transform ${this.imageDuration}ms linear`;
            fill.style.transform = 'scaleX(1)';
            this.timer = setTimeout(() => this.next(), this.imageDuration);
        }
    },

    next: function() {
        if(this.currentIndex < this.queue.length) {
            this.currentIndex++;
            this.renderSlide();
        }
    },

    prev: function() {
        if(this.currentIndex > 0) {
            this.currentIndex--;
            this.renderSlide();
        }
    },

    showClimax: function() {
        if(!this.isMuted) {
            this.audioObj.play().catch(()=>{});
            this.fadeAudio(1, 300);
        }
        document.getElementById('storyTextContent').classList.add('hidden');
        document.getElementById('storyMediaWrapper').innerHTML = ''; 
        document.getElementById('climaxCard').classList.add('active');
    },

    updateUI: function(exp) {
        document.getElementById('storyBrandName').textContent = exp.name;
        document.getElementById('storyTitle').textContent = exp.name;
        document.getElementById('storyDesc').textContent = exp.description;
        document.getElementById('climaxTitle').textContent = exp.name;
        document.getElementById('climaxDesc').textContent = exp.description;
        
        const bgContainer = document.getElementById('climaxBgContainer');
        if(exp.finalImage) {
           bgContainer.style.backgroundImage = `url('${exp.finalImage}')`; 
        }
    },

    close: function() {
        this.fadeAudio(0, 200, true);
        document.getElementById('storyOverlay').classList.remove('show');
        
        setTimeout(() => {
            document.getElementById('storyMediaWrapper').innerHTML = '';
            document.body.style.overflow = '';
            this.audioObj.pause();
            this.audioObj.currentTime = 0;
            this.currentVideoPlayer = null;
            clearTimeout(this.timer);
            this.currentIndex = 0;
            this.queue = [];
        }, 300);
    }
};
/* === OPTIMIZATION END === */

StoryManager.init();

/* ============================================================================
   ELITE MENU ENGINE V18 - ULTRA-RELIABLE MOBILE-FIRST PDF VIEWER
   ============================================================================
   
   ARCHITECTURE OVERVIEW:
   This engine uses a multi-strategy approach with automatic failover to ensure
   PDFs always display on all devices (Android, iOS, Desktop).
   
   STRATEGY PRIORITY:
   1. Native PDF.js rendering (most reliable, works everywhere)
   2. Google Docs Viewer (fallback for complex PDFs)
   3. Direct link (ultimate fallback)
   
   MOBILE OPTIMIZATIONS:
   - Prevents blank gray screen by using visibility checks
   - Multiple retry mechanisms with exponential backoff
   - Touch-optimized scrolling with proper viewport handling
   - Memory-efficient cleanup on close
   
   ============================================================================ */

const MenuEngine = (() => {
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        // Timing
        INITIAL_LOAD_TIMEOUT: 1500,      // Show content after this (optimistic)
        RETRY_DELAY: 2000,                // Wait before retry
        MAX_RETRIES: 3,                   // Maximum retry attempts
        SAFETY_TIMEOUT: 4000,             // Show fallback link after this
        VISIBILITY_CHECK_INTERVAL: 500,  // Check if content visible
        VISIBILITY_CHECK_MAX: 10,        // Max visibility checks
        
        // Prefetch
        HOVER_PREFETCH_DELAY: 150,
        SCROLL_PRELOAD_MARGIN: '300px',
        
        // PDF.js CDN (Mozilla's official CDN - highly reliable)
        PDFJS_CDN: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174',
        
        // Google Docs Viewer
        GDOCS_VIEWER: 'https://docs.google.com/gview?embedded=true&url='
    };

    // ==================== STATE ====================
    const state = {
        isOpen: false,
        currentUrl: null,
        retryCount: 0,
        timers: new Set(),
        prefetchCache: new Map(),
        hoverTimers: new Map(),
        savedScrollY: 0,
        visibilityCheckCount: 0,
        currentStrategy: null,
        isDestroyed: false
    };

    // ==================== DEVICE DETECTION ====================
    const device = {
        isAndroid: /Android/i.test(navigator.userAgent),
        isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        isMobile: /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        
        get bestStrategy() {
            // iOS Safari has issues with Google Docs viewer
            if (this.isIOS && this.isSafari) return 'pdfjs';
            // Android Chrome works best with Google Docs
            if (this.isAndroid) return 'gdocs';
            // Desktop: try native first
            return 'pdfjs';
        }
    };

    // ==================== UTILITIES ====================
    const utils = {
        log(msg, data) {
            console.log(`[MenuV18] ${msg}`, data || '');
        },
        
        warn(msg, data) {
            console.warn(`[MenuV18] ${msg}`, data || '');
        },
        
        clearAllTimers() {
            state.timers.forEach(t => clearTimeout(t));
            state.timers.clear();
        },
        
        addTimer(callback, delay) {
            const timer = setTimeout(() => {
                state.timers.delete(timer);
                if (!state.isDestroyed) callback();
            }, delay);
            state.timers.add(timer);
            return timer;
        },
        
        // Ensure URL is properly encoded for viewers
        sanitizeUrl(url) {
            try {
                // If already encoded, decode first to avoid double encoding
                const decoded = decodeURIComponent(url);
                return encodeURIComponent(decoded);
            } catch {
                return encodeURIComponent(url);
            }
        }
    };

    // ==================== PRELOAD SYSTEM ====================
    const preload = {
        initScrollObserver() {
            if (!('IntersectionObserver' in window)) return;
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const btn = entry.target;
                    const url = this.extractUrl(btn);
                    if (url) {
                        this.preconnect(url);
                        observer.unobserve(btn);
                    }
                });
            }, { rootMargin: CONFIG.SCROLL_PRELOAD_MARGIN });
            
            document.querySelectorAll('.btn-menu').forEach(btn => observer.observe(btn));
        },
        
        initHoverPrefetch() {
            document.querySelectorAll('.btn-menu').forEach(btn => {
                const url = this.extractUrl(btn);
                if (!url) return;
                
                btn.addEventListener('mouseenter', () => {
                    const timer = setTimeout(() => {
                        this.prefetch(url);
                        state.hoverTimers.delete(btn);
                    }, CONFIG.HOVER_PREFETCH_DELAY);
                    state.hoverTimers.set(btn, timer);
                }, { passive: true });
                
                btn.addEventListener('mouseleave', () => {
                    const timer = state.hoverTimers.get(btn);
                    if (timer) {
                        clearTimeout(timer);
                        state.hoverTimers.delete(btn);
                    }
                }, { passive: true });
                
                btn.addEventListener('touchstart', () => {
                    this.prefetch(url);
                }, { passive: true, once: true });
            });
        },
        
        extractUrl(btn) {
            const onclick = btn.getAttribute('onclick');
            const match = onclick?.match(/openMenu\(['"]([^'"]+)['"]\)/);
            return match?.[1] || null;
        },
        
        preconnect(url) {
            try {
                const origin = new URL(url).origin;
                const id = `preconnect-${btoa(origin).slice(0, 10)}`;
                if (document.getElementById(id)) return;
                
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'preconnect';
                link.href = origin;
                link.crossOrigin = 'anonymous';
                document.head.appendChild(link);
                
                // Also preconnect to Google Docs
                if (!document.getElementById('preconnect-gdocs')) {
                    const gdocs = document.createElement('link');
                    gdocs.id = 'preconnect-gdocs';
                    gdocs.rel = 'preconnect';
                    gdocs.href = 'https://docs.google.com';
                    document.head.appendChild(gdocs);
                }
            } catch (e) {}
        },
        
        prefetch(url) {
            if (state.prefetchCache.has(url)) return;
            state.prefetchCache.set(url, 'loading');
            
            fetch(url, { 
                method: 'HEAD', 
                cache: 'force-cache', 
                mode: 'no-cors' 
            })
            .then(() => state.prefetchCache.set(url, 'ready'))
            .catch(() => state.prefetchCache.set(url, 'failed'));
        }
    };

    // ==================== UI SYSTEM ====================
    const ui = {
        showLoader(container, url) {
            container.innerHTML = `
                <div id="menuLoader" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
                    z-index: 100;
                ">
                    <div class="menu-spinner"></div>
                    <div class="loading-text" id="menuLoadingText">Ouverture de la carte...</div>
                    <div id="menuRetryInfo" style="
                        font-size: 0.7rem;
                        color: #999;
                        margin-top: 8px;
                        display: none;
                    "></div>
                    <a href="${url}" target="_blank" rel="noopener" class="fallback-btn" id="safetyLink" style="
                        display: none;
                        margin-top: 20px;
                        background: var(--brand-raspberry, #EC5075);
                        color: white;
                        padding: 14px 28px;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 700;
                        font-size: 0.9rem;
                        box-shadow: 0 4px 15px rgba(236, 80, 117, 0.3);
                        transition: transform 0.2s ease;
                    ">📄 Ouvrir directement</a>
                </div>`;
        },
        
        updateLoadingText(text) {
            const el = document.getElementById('menuLoadingText');
            if (el) el.textContent = text;
        },
        
        showRetryInfo(attempt, max) {
            const el = document.getElementById('menuRetryInfo');
            if (el) {
                el.style.display = 'block';
                el.textContent = `Tentative ${attempt}/${max}...`;
            }
        },
        
        showSafetyLink() {
            const link = document.getElementById('safetyLink');
            if (link) {
                link.style.display = 'inline-block';
                link.style.animation = 'fadeIn 0.3s ease';
            }
        },
        
        hideLoader() {
            const loader = document.getElementById('menuLoader');
            if (!loader) return;
            
            loader.style.transition = 'opacity 0.3s ease';
            loader.style.opacity = '0';
            loader.style.pointerEvents = 'none';
            
            utils.addTimer(() => {
                if (loader.parentNode) {
                    loader.remove();
                }
            }, 300);
        },
        
        showError(container, url, message) {
            container.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    padding: 20px;
                    text-align: center;
                    background: #f8f8f8;
                ">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📄</div>
                    <div style="font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 8px;">
                        ${message || 'Impossible de charger la carte'}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                        Cliquez ci-dessous pour l'ouvrir dans un nouvel onglet
                    </div>
                    <a href="${url}" target="_blank" rel="noopener" style="
                        background: var(--brand-raspberry, #EC5075);
                        color: white;
                        padding: 14px 28px;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 700;
                        font-size: 0.9rem;
                        box-shadow: 0 4px 15px rgba(236, 80, 117, 0.3);
                    ">📄 Voir la carte</a>
                </div>`;
        }
    };

    // ==================== RENDERING STRATEGIES ====================
    const strategies = {
        
        // STRATEGY 1: PDF.js Viewer (Most reliable for mobile)
        pdfjs(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying PDF.js strategy');
                state.currentStrategy = 'pdfjs';
                
                const iframe = document.createElement('iframe');
                // Use PDF.js viewer with the PDF URL
                const viewerUrl = `${CONFIG.PDFJS_CDN}/web/viewer.html?file=${encodeURIComponent(url)}`;
                
                iframe.src = viewerUrl;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                iframe.setAttribute('importance', 'high');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                let hasContent = false;
                
                const checkVisibility = () => {
                    if (loaded || state.isDestroyed) return;
                    
                    state.visibilityCheckCount++;
                    
                    try {
                        // Check if iframe has any visible content
                        const rect = iframe.getBoundingClientRect();
                        if (rect.width > 0 && rect.height > 0 && iframe.contentWindow) {
                            hasContent = true;
                        }
                    } catch (e) {
                        // Cross-origin, assume it's loading
                        hasContent = true;
                    }
                    
                    if (state.visibilityCheckCount >= CONFIG.VISIBILITY_CHECK_MAX) {
                        if (hasContent) {
                            loaded = true;
                            iframe.style.opacity = '1';
                            ui.hideLoader();
                            resolve();
                        } else {
                            reject(new Error('Content not visible'));
                        }
                    } else {
                        utils.addTimer(checkVisibility, CONFIG.VISIBILITY_CHECK_INTERVAL);
                    }
                };
                
                // Start visibility checks
                utils.addTimer(checkVisibility, CONFIG.VISIBILITY_CHECK_INTERVAL);
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    loaded = true;
                    iframe.style.opacity = '1';
                    ui.hideLoader();
                    resolve();
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('PDF.js iframe error'));
                };
            });
        },
        
        // STRATEGY 2: Google Docs Viewer (Good for Android)
        gdocs(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying Google Docs strategy');
                state.currentStrategy = 'gdocs';
                
                const iframe = document.createElement('iframe');
                iframe.src = `${CONFIG.GDOCS_VIEWER}${encodeURIComponent(url)}`;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                iframe.setAttribute('importance', 'high');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                let checkCount = 0;
                
                const checkContent = () => {
                    if (loaded || state.isDestroyed) return;
                    checkCount++;
                    
                    // After several checks, consider it loaded
                    if (checkCount >= 4) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                        return;
                    }
                    
                    utils.addTimer(checkContent, 500);
                };
                
                // Start checking
                utils.addTimer(checkContent, 500);
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    
                    // Extra delay for Google Docs to render content
                    utils.addTimer(() => {
                        if (!loaded && !state.isDestroyed) {
                            loaded = true;
                            iframe.style.opacity = '1';
                            ui.hideLoader();
                            resolve();
                        }
                    }, 300);
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('Google Docs iframe error'));
                };
            });
        },
        
        // STRATEGY 3: Direct PDF (Desktop browsers)
        direct(url, container) {
            return new Promise((resolve, reject) => {
                utils.log('Trying direct PDF strategy');
                state.currentStrategy = 'direct';
                
                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.title = 'Menu PDF';
                iframe.setAttribute('loading', 'eager');
                this.applyStyles(iframe);
                container.appendChild(iframe);
                
                let loaded = false;
                
                // Optimistic display
                utils.addTimer(() => {
                    if (!loaded && !state.isDestroyed) {
                        loaded = true;
                        iframe.style.opacity = '1';
                        ui.hideLoader();
                        resolve();
                    }
                }, CONFIG.INITIAL_LOAD_TIMEOUT);
                
                iframe.onload = () => {
                    if (loaded || state.isDestroyed) return;
                    loaded = true;
                    iframe.style.opacity = '1';
                    ui.hideLoader();
                    resolve();
                };
                
                iframe.onerror = () => {
                    if (loaded) return;
                    reject(new Error('Direct iframe error'));
                };
            });
        },
        
        applyStyles(iframe) {
            iframe.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
                opacity: 0;
                transition: opacity 0.4s ease;
                background: #fff;
                z-index: 1;
                touch-action: pan-x pan-y;
                -webkit-overflow-scrolling: touch;
            `;
        }
    };

    // ==================== RENDER ORCHESTRATOR ====================
    const orchestrator = {
        async load(url, container) {
            const strategyOrder = this.getStrategyOrder();
            
            for (let i = 0; i < strategyOrder.length; i++) {
                const strategyName = strategyOrder[i];
                
                if (state.isDestroyed) return;
                
                // Clear previous attempt
                const existingIframe = container.querySelector('iframe');
                if (existingIframe) existingIframe.remove();
                
                // Reset visibility check counter
                state.visibilityCheckCount = 0;
                
                if (i > 0) {
                    ui.updateLoadingText('Changement de méthode...');
                    ui.showRetryInfo(i + 1, strategyOrder.length);
                }
                
                try {
                    await strategies[strategyName](url, container);
                    utils.log(`Success with ${strategyName}`);
                    return; // Success!
                } catch (error) {
                    utils.warn(`${strategyName} failed:`, error.message);
                    
                    if (i < strategyOrder.length - 1) {
                        // Wait before trying next strategy
                        await new Promise(r => utils.addTimer(r, 500));
                    }
                }
            }
            
            // All strategies failed
            utils.warn('All strategies failed, showing fallback');
            ui.showError(container, url, 'La carte n\'a pas pu être chargée');
        },
        
        getStrategyOrder() {
            const primary = device.bestStrategy;
            
            // Build fallback chain based on device
            if (device.isIOS) {
                return ['pdfjs', 'direct', 'gdocs'];
            } else if (device.isAndroid) {
                return ['gdocs', 'pdfjs', 'direct'];
            } else {
                // Desktop
                return ['direct', 'pdfjs', 'gdocs'];
            }
        }
    };

    // ==================== PUBLIC API ====================
    return {
        open(url) {
            if (!url) {
                utils.warn('No URL provided');
                return;
            }
            
            if (state.isOpen) {
                utils.log('Already open, ignoring');
                return;
            }
            
            state.isOpen = true;
            state.isDestroyed = false;
            state.currentUrl = url;
            state.retryCount = 0;
            state.visibilityCheckCount = 0;
            
            const modal = document.getElementById('menuModal');
            const container = document.getElementById('iframeContainer');
            
            if (!modal || !container) {
                utils.warn('Modal elements not found');
                state.isOpen = false;
                return;
            }
            
            utils.log('Opening menu', { url, device: device.bestStrategy });
            
            // 1. SAVE SCROLL POSITION & LOCK BODY
            state.savedScrollY = window.scrollY || window.pageYOffset || 0;
            
            // Use a more robust scroll lock
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.savedScrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            
            // Prevent iOS bounce
            if (device.isIOS) {
                document.body.style.height = '100%';
                document.documentElement.style.overflow = 'hidden';
            }
            
            // 2. SHOW MODAL
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            
            // Force reflow before adding active class
            modal.offsetHeight;
            
            requestAnimationFrame(() => {
                modal.classList.add('active');
            });
            
            // 3. SHOW LOADER & START LOADING
            ui.showLoader(container, url);
            
            // 4. Start loading with strategy orchestrator
            orchestrator.load(url, container);
            
            // 5. Show safety link after timeout
            utils.addTimer(() => {
                if (state.isOpen) {
                    ui.showSafetyLink();
                }
            }, CONFIG.SAFETY_TIMEOUT);
        },

        close() {
            if (!state.isOpen) return;
            
            utils.log('Closing menu');
            
            state.isOpen = false;
            state.isDestroyed = true;
            state.currentUrl = null;
            state.currentStrategy = null;
            
            // Clear all pending timers
            utils.clearAllTimers();
            
            const modal = document.getElementById('menuModal');
            const container = document.getElementById('iframeContainer');
            
            if (modal) {
                modal.classList.remove('active');
            }
            
            // Wait for animation to complete
            setTimeout(() => {
                if (modal) {
                    modal.style.display = 'none';
                    modal.style.visibility = 'hidden';
                }
                
                // Clean up container
                if (container) {
                    // Remove all iframes properly
                    const iframes = container.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        iframe.src = 'about:blank';
                        iframe.remove();
                    });
                    container.innerHTML = '';
                }
                
                // RESTORE SCROLL POSITION
                const scrollY = state.savedScrollY || 0;
                
                // Disable smooth scroll temporarily
                const htmlEl = document.documentElement;
                const originalScrollBehavior = htmlEl.style.scrollBehavior;
                htmlEl.style.scrollBehavior = 'auto';
                
                // Remove body lock
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.right = '';
                document.body.style.width = '';
                document.body.style.height = '';
                
                if (device.isIOS) {
                    htmlEl.style.overflow = '';
                }
                
                // Restore scroll position immediately
                window.scrollTo(0, scrollY);
                
                // Restore smooth scroll in next frame
                requestAnimationFrame(() => {
                    htmlEl.style.scrollBehavior = originalScrollBehavior || '';
                });
                
                state.savedScrollY = 0;
                
            }, 300);
        },

        init() {
            utils.log('Initializing MenuEngine V18');
            
            preload.initScrollObserver();
            preload.initHoverPrefetch();
            
            // Add click handler for modal background
            const modal = document.getElementById('menuModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.close();
                    }
                });
            }
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && state.isOpen) {
                    this.close();
                }
            });
            
            // Handle visibility change (close if tab hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && state.isOpen) {
                    // Keep open but pause any animations
                }
            });
            
            utils.log('MenuEngine V18 ready', { device: device.bestStrategy });
        }
    };
})();

// ==================== AUTO-INIT ====================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => MenuEngine.init());
} else {
    MenuEngine.init();
}

window.openMenu = (url) => MenuEngine.open(url);
window.closeMenu = () => MenuEngine.close();


        function toggleAccordion(header) {
            const item = header.parentElement;
            const isOpen = item.classList.contains('open');
            document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('open'));
            if (!isOpen) item.classList.add('open');
        }

        function initializeStickyCta() {
            const stickyCta = document.getElementById('stickyCta');
            const triggerSection = document.getElementById('testimonialsSection'); 
            if (!stickyCta || !triggerSection) return;
            const observer = new IntersectionObserver(([entry]) => {
                if (entry.isIntersecting) stickyCta.classList.add('visible');
                else stickyCta.classList.remove('visible');
            }, { rootMargin: "0px 0px -20% 0px", threshold: 0 });
            observer.observe(triggerSection);
        }
    </script>


<!-- === ELITE CONCIERGE MAP WIDGET V3 (STABILITY & LOCALIZATION FIX) === -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<!-- Language Plugin for fixing Arabic/Latin character rendering -->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>

<style>
    :root {
        --map-dark-bg: #0B0F1A;
        --wa-green: #25D366;
    }

    #mapbox-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.92); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        z-index: 10000; display: none; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.4s ease;
    }
    #mapbox-modal.active { display: flex; opacity: 1; }

    .map-wrapper {
        position: relative; width: 95%; max-width: 900px; height: 85vh; height: 85dvh;
        background: var(--map-dark-bg); border-radius: 40px; overflow: hidden;
        box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        transform: scale(0.9) translateY(30px);
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #mapbox-modal.active .map-wrapper { transform: scale(1) translateY(0); }

    /* Fix: Ensure canvas is always 100% of visible parent */
    #map-canvas { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; background: #111; }

    .map-close {
        position: absolute; top: 24px; right: 24px; z-index: 30;
        width: 48px; height: 48px; background: #fff; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .concierge-panel {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        width: calc(100% - 40px); max-width: 420px; z-index: 30;
        background: #FFFFFF; padding: 24px; border-radius: 32px;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; gap: 15px;
    }

    .concierge-header { display: flex; align-items: center; gap: 15px; }
    .concierge-avatar-wrapper { position: relative; width: 52px; height: 52px; flex-shrink: 0; }
    .concierge-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #F3F4F6; }
    .status-dot-live {
        position: absolute; bottom: 1px; right: 1px; width: 13px; height: 13px;
        background: var(--wa-green); border: 2.5px solid #fff; border-radius: 50%;
        animation: pulseLive 2s infinite;
    }

    .concierge-info h4 { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: #111; margin: 0; }
    .concierge-info p { font-size: 0.7rem; color: #6B7280; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }

    .venue-address-block { background: #F9FAFB; padding: 14px; border-radius: 18px; border: 1px solid #F3F4F6; }
    .venue-address-block h5 { font-size: 0.8rem; color: #111; margin-bottom: 2px; font-weight: 800; }
    .venue-address-block p { font-size: 0.75rem; color: #4B5563; line-height: 1.4; font-weight: 600; margin: 0; }

    .btn-wa-full {
        background: var(--wa-green); color: #fff; padding: 16px; border-radius: 100px;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        text-decoration: none; font-weight: 800; font-size: 0.85rem;
        text-transform: uppercase; letter-spacing: 1px;
        box-shadow: 0 10px 20px rgba(37, 211, 102, 0.25); transition: transform 0.2s;
    }
    .btn-wa-full.pulse-active {
        animation: gentlePulse 2s infinite ease-in-out;
    }
    .btn-wa-full:active { transform: scale(0.97); }

    .venue-marker { width: 30px; height: 30px; background: #EC5075; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 20px rgba(236, 80, 117, 0.4); }

    @keyframes pulseLive {
        0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(37, 211, 102, 0); }
        100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
    }
    
    @keyframes gentlePulse {
        0%, 100% { transform: scale(1); box-shadow: 0 10px 20px rgba(37, 211, 102, 0.25); }
        50% { transform: scale(1.03); box-shadow: 0 12px 25px rgba(37, 211, 102, 0.35); }
    }


    @media (max-width: 768px) {
        .map-wrapper { width: 100%; height: 100%; border-radius: 0; }
        .concierge-panel { bottom: 15px; width: calc(100% - 30px); padding: 18px; }
    }
</style>

<div id="mapbox-modal">
    <div class="map-wrapper">
        <div class="map-close" onclick="closeMapWidget()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        
        <div id="map-canvas"></div>

        <div class="concierge-panel">
            <div class="concierge-header">
                <div class="concierge-avatar-wrapper">
                    <img src="https://MTSZone.b-cdn.net/file%20(1)%20(1).png" class="concierge-avatar" alt="Concierge">
                    <span class="status-dot-live"></span>
                </div>
                <div class="concierge-info">
                    <h4>Concierge VIP</h4>
                    <p>En ligne • Prêt à vous aider</p>
                </div>
            </div>

            <div class="venue-address-block">
                <h5 id="v-name">--</h5>
                <p id="v-address">--</p>
            </div>

            <a href="#" id="v-wa-btn" target="_blank" class="btn-wa-full">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.68-2.031-.967-.272-.099-.47-.149-.669.198-.198.347-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.52.149-.173.198-.297.297-.495.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413z"/></svg>
                Contacter le Concierge
            </a>
        </div>
    </div>
</div>

<script>
    const MAPBOX_TOKEN = 'pk.eyJ1IjoidnBzbW9lcm9ja3MiLCJhIjoiY21qaWY1czlsMHAzNzNnc2Nmc21qNXM3bSJ9.EWmJAoL7TH7Dx5mm_v7tIg';
const VENUES = {
        'malak': { name: 'Malak Emeraude', address: 'Intersection entre Bd Mohamed 6 et Bd de la Menara, 1er étage, N°16, Marrakesh 40001', coords: [-8.0102153, 31.6174768] },
        'ibrahim': { name: 'Ibrahim Pacha', address: 'Av. Prince Moulay Rachid, Marrakech 40000', coords: [-8.0107559, 31.6172768] },
        'nouba': { name: 'Nouba', address: 'Zone de l, Bd Mohamed VI, Marrakech', coords: [-7.9826729, 31.5782496] },
        'stah': { name: 'Restaurant Stah', address: "Route de l'Ourika, Zone Touristique Agdal, Marrakech 40000", coords: [-7.98495, 31.58853] },
        'noto': { name: 'Noto Marrakech', address: 'Villa Yvette, angle avenue Ibn Khattib, Rue Abdelaziz Ettaalibi, Marrakech 40000', coords: [-8.0044133, 31.6261171] },
        'ritziF': { name: 'Ritzi Restaurant', address: 'N 8 RDV residence AMALFI, Rue Zoubeir, Av. Hassan II, Marrakech', coords: [-8.0178521, 31.6291417] },
        'ritziD': { name: 'Ritzi Restaurant', address: 'N 8 RDV residence AMALFI, Rue Zoubeir, Av. Hassan II, Marrakech', coords: [-8.0178521, 31.6291417] },
        'folk': { name: 'Folk Restaurant', address: 'Rue el Imam Chafii, Marrakech 40000', coords: [-8.0103, 31.62867] },
        'tanjia': { name: 'Le Tanjia', address: 'Place des Ferblantiers, Marrakech 40000', coords: [-7.98909, 31.61997] }
    };

    let map = null;
    let mapMarker = null;

    document.addEventListener('click', function(e) {
        const badge = e.target.closest('.price-range');
        if (badge) {
            const card = badge.closest('.spectacle-card');
            if (card && card.dataset.id) {
                e.preventDefault();
                openMapWidget(card.dataset.id);
            }
        }
    });

    function openMapWidget(id) {
        const venue = VENUES[id];
        if (!venue) return;

        const modal = document.getElementById('mapbox-modal');
        modal.style.display = 'flex';
        
        // Use timeout to ensure display: flex is applied before opacity
        setTimeout(() => {
            modal.classList.add('active');
            
            // CRITICAL FIX: Trigger resize 500ms after animation starts
            // This prevents the "Black Screen" on mobile.
            if (map) {
                setTimeout(() => map.resize(), 550);
            }
        }, 10);
        
        document.getElementById('v-name').textContent = venue.name;
        document.getElementById('v-address').textContent = venue.address;
        document.getElementById('v-wa-btn').href = `https://wa.me/212680802756?text=Bonjour Concierge, je suis intéressé par ${venue.name}. Pouvez-vous m'aider pour l'accès ou une navette ?`;

        if (!map) {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            map = new mapboxgl.Map({
                container: 'map-canvas',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: venue.coords,
                zoom: 15,
                pitch: 45,
                antialias: true
            });

            // LANGUAGE FIX: Force Latin/French characters
            const language = new MapboxLanguage({ defaultLanguage: 'fr' });
            map.addControl(language);

            map.on('load', () => {
                map.resize(); 
                addMarker(venue.coords);
            });
        } else {
            map.jumpTo({ center: venue.coords }); // Instant move to avoid glitch
            map.flyTo({ center: venue.coords, zoom: 15, duration: 1200 });
            addMarker(venue.coords);
        }
    }

    function addMarker(coords) {
        if (mapMarker) mapMarker.remove();
        const el = document.createElement('div');
        el.className = 'venue-marker';
        mapMarker = new mapboxgl.Marker(el).setLngLat(coords).addTo(map);
    }

    function closeMapWidget() {
        const modal = document.getElementById('mapbox-modal');
        modal.classList.remove('active');
        setTimeout(() => { modal.style.display = 'none'; }, 400);
    }
</script>


<script>
/* ============================================================================
   ELITE CONTEXT ENGINE V4 - STABLE VIDEO, DYNAMIC TEXT
   ============================================================================ */

// 1. CONFIGURATION
const CONTEXT_CONFIG = {
    'default': {
        heroTitle: 'Dîners Spectacles',
        sectionTitle: '7 Spectacles Uniques.<br>Quelle magie choisirez-vous ce soir ?',
        priorityId: 'ritziD', 
        hideId: 'ritziF'      
    },
    'festif': {
        heroTitle: 'Restaurants Festifs',
        sectionTitle: '7 Ambiances Uniques.<br>Où ferez-vous la fête ce soir ?',
        priorityId: 'ritziF',
        hideId: 'ritziD'
    }
};

// Global state
let currentContextKey = 'default';

// 2. MASTER FILTER FUNCTION
// 2. MASTER FILTER FUNCTION
window.filterExperiences = function(category, btn) {
    // A. Update Button UI
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        const target = document.querySelector(`button[onclick*="'${category}'"]`);
        if(target) target.classList.add('active');
    }

    // B. Determine Text/Card Context based on Category
    let newContext = 'default';
    
    // Logic: If filter is Party/Festif OR Intent was Festif (and user clicked All), set context to Festif
    if (category === 'party' || category === 'festif') {
        newContext = 'festif';
    } else if (category === 'grand-spectacle') {
        newContext = 'default';
    } else if (category === 'all') {
        newContext = currentContextKey; // Revert to URL intent (Default or Festif)
    }
    
    const config = CONTEXT_CONFIG[newContext];

    // C. Update Titles (Dynamic Text)
    const heroHighlight = document.querySelector('.hero h1 .text-highlight');
    if(heroHighlight) {
        if(heroHighlight.textContent !== config.heroTitle) {
            heroHighlight.textContent = config.heroTitle;
            heroHighlight.classList.remove('ready');
            setTimeout(() => heroHighlight.classList.add('ready'), 50);
        } else {
             heroHighlight.classList.add('ready');
        }
    }

    const sectionTitle = document.getElementById('experiences-title');
    if(sectionTitle) sectionTitle.innerHTML = config.sectionTitle;

    // D. Filter Cards & Handle Duplicates (Ritzi)
    const cards = document.querySelectorAll('.spectacle-card');
    
    cards.forEach(card => {
        const cardId = card.dataset.id;
        const cardCategories = card.dataset.categories || "";
        
        let shouldShow = false;

        // 1. Basic Category Match
        if (category === 'all') {
            shouldShow = true;
        } else {
            if (category === 'authentic' && (cardCategories.includes('authentic') || cardCategories.includes('music'))) shouldShow = true;
            else if (category === 'grand-spectacle' && cardCategories.includes('grand-spectacle')) shouldShow = true;
            else if (category === 'party' && cardCategories.includes('party')) shouldShow = true;
        }

        // 2. DUPLICATE MANAGEMENT (THE FIX)
        // We use 'newContext' (Dynamic) instead of 'currentContextKey' (Static)
        if (newContext === 'festif') { 
            // FESTIF MODE: Hide RitziD, Show RitziF
            if (cardId === CONTEXT_CONFIG.festif.hideId) shouldShow = false; 
            if (cardId === CONTEXT_CONFIG.festif.priorityId && category === 'all') shouldShow = true; 
        } 
        else { 
            // DEFAULT MODE: Hide RitziF, Show RitziD
            // FIXED: Used 'default.hideId' (which targets RitziF) instead of 'festif.hideId'
            if (cardId === CONTEXT_CONFIG.default.hideId) shouldShow = false; 
            if (cardId === CONTEXT_CONFIG.default.priorityId && category === 'all') shouldShow = true;
        }

        // Apply Visibility
        if(shouldShow) {
            card.classList.remove('hidden');
            card.style.display = '';
            card.classList.remove('active');
            setTimeout(() => card.classList.add('active'), 50);
        } else {
            card.classList.add('hidden');
            card.style.display = 'none';
        }
    });
};

// 3. INITIALIZATION ON LOAD
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const intent = (urlParams.get('intent') || '').toLowerCase();
    
    let initialCategory = 'all';
    
    // Determine start state based on URL
    if (intent.includes('festif') || intent.includes('party') || intent.includes('vip')) {
        currentContextKey = 'festif';
        initialCategory = 'party';
    } else if (intent.includes('spectacle') || intent.includes('cabaret')) {
        currentContextKey = 'default';
        initialCategory = 'grand-spectacle';
    } else {
        currentContextKey = 'default';
        initialCategory = 'all';
    }

    // Run the filter immediately to set up text and cards
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => filterExperiences(initialCategory));
    } else {
        filterExperiences(initialCategory);
    }
})();
</script>

<!-- === ELITE REAL-TIME AVAILABILITY ENGINE === -->
<script>
    // 1. CONFIGURATION & STATE
    const SHEET_ID = '1flTpiOoNjTdxpPTo0wEYk_q-IW2-eovCVxWUQaw_N-w';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
    
    // Cache to store the rules from your sheet
    let availabilityRules = {}; 
    let isAvailabilityLoaded = false;

    // 2. THE SILENT CONCIERGE (Fetches Data)
    async function syncAvailabilityData() {
        try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();
            
            // Parse CSV (Skip header row)
            const rows = text.split('\n').slice(1);
            
            rows.forEach(row => {
                // Handle CSV parsing (splitting by comma, cleaning quotes/spaces)
                const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());

                if(cleanCols.length >= 1) {
                    const id = cleanCols[0].toLowerCase(); // Restaurant ID (e.g., 'nouba')
                    
                    availabilityRules[id] = {
                        forbiddenDays: [
                            (cleanCols[1] || "").toLowerCase(), // Day1 Forbidden
                            (cleanCols[2] || "").toLowerCase()  // Day2 Forbidden
                        ].filter(d => d), // Remove empty entries
                        fullyBooked: (cleanCols[3] || "").toLowerCase() === 'yes' // Fully Booked Today
                    };
                }
            });
            
            isAvailabilityLoaded = true;
            console.log("Elite Concierge: Availability Synced", availabilityRules);

        } catch (error) {
            console.warn("Elite Concierge: Sync failed, defaulting to open.", error);
            // Fallback: If sheet fails, we allow bookings to prevent blocking valid users
            isAvailabilityLoaded = true; 
        }
    }

    // Initialize immediately
    syncAvailabilityData();

    // 3. UTILITY: Convert Date to Day Name (English)
    function getDayName(dateString) {
        const date = new Date(dateString);
        // Create an array matching your Sheet's language (English)
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        return days[date.getDay()];
    }

    // 4. UTILITY: Check if Date is "Today"
    function isDateToday(dateString) {
        const inputDate = new Date(dateString).setHours(0,0,0,0);
        const today = new Date().setHours(0,0,0,0);
        return inputDate === today;
    }

    // ============================================================
    // 5. OVERRIDE EXISTING VALIDATION FUNCTION
    // This replaces the window.validateStep1 from your original code
    // ============================================================
    
    window.validateStep1 = function() {
        let isValid = true;
        
        // --- A. STANDARD VALIDATION (Fields Empty?) ---
        
        // 1. Check Experience
        const expSelect = document.getElementById('experience-select');
        const selectedId = expSelect.value ? expSelect.value.toLowerCase() : null;
        
        if(!selectedId) {
            setFieldError('container-experience', 'error-experience');
            isValid = false;
        } else {
            clearFieldError('container-experience', 'error-experience');
        }
        
        // 2. Check Date
        const dateInput = document.getElementById('date');
        const selectedDate = dateInput.value;
        
        if(!selectedDate) {
            setFieldError('container-date', 'error-date');
            isValid = false;
        } else {
            clearFieldError('container-date', 'error-date');
        }
        
        // 3. Check Time (Standard)
        const timeSelect = document.getElementById('booking_time');
        const timeLoader = document.getElementById('time-loader');
        
        if(!timeSelect.value || timeSelect.disabled) {
            let msg = "Veuillez sélectionner une heure.";
            if(!selectedDate) msg = "Sélectionnez d'abord une date.";
            else if(timeLoader && !timeLoader.classList.contains('hidden')) msg = "Chargement des horaires en cours...";
            
            setFieldError('container-time', 'error-time', msg);
            isValid = false;
        } else {
            clearFieldError('container-time', 'error-time');
        }

        // --- B. ELITE AVAILABILITY CHECK (The Upgrade) ---
        
        // Only run this check if basic fields are valid and we have data
        if (isValid && selectedId && selectedDate && isAvailabilityLoaded) {
            const rules = availabilityRules[selectedId];
            
            if (rules) {
                const dayName = getDayName(selectedDate); // e.g., 'tuesday'
                const isToday = isDateToday(selectedDate);

                // CHECK 1: FORBIDDEN DAYS (Closed/Privatized)
                if (rules.forbiddenDays.includes(dayName)) {
                    // Update Error Message for Elite Context
                    const errorMsg = document.getElementById('error-date');
                    if(errorMsg) {
                        // Premium Copy: "Weekly Closure"
                        errorMsg.textContent = "Indisponible : Cet établissement est fermé ou privatisé ce jour-là.";
                    }
                    setFieldError('container-date', 'error-date');
                    
                    // Shake the form to indicate rejection
                    const formContainer = document.querySelector('.form-container');
                    formContainer.classList.add('shake-anim');
                    setTimeout(() => formContainer.classList.remove('shake-anim'), 500);
                    
                    isValid = false;
                }

                // CHECK 2: FULLY BOOKED TODAY
                // Only triggers if the user selected TODAY and the sheet says "Yes"
                else if (rules.fullyBooked && isToday) {
                    // Update Error Message for Elite Context
                    const errorMsg = document.getElementById('experience-select').closest('.form-group').querySelector('.elite-input-error-msg');
                    if(errorMsg) {
                        errorMsg.textContent = "Complet ce soir. Veuillez choisir une autre date ou un autre lieu.";
                        // Make sure the element is targetable for the error function
                        errorMsg.id = 'error-experience-full'; 
                    }
                    
                    setFieldError('container-experience', 'error-experience-full', "Complet ce soir. La Guestlist est fermée pour ce soir.");
                    isValid = false;
                }
            }
        } else if (isValid && !isAvailabilityLoaded) {
            // Optional: If data hasn't loaded yet (rare), you might want to wait or just let them through.
            // Currently set to let them through to avoid blocking sales on network errors.
            console.log("Availability data not yet loaded, bypassing check.");
        }
        
        // --- C. PROCEED IF VALID ---
        if(isValid) {
            // Success: Move to Step 2
            if(typeof window.updateStepIndicator === 'function') window.updateStepIndicator(2);
            if(typeof window.goToStep === 'function') window.goToStep(2);
        }
    };
    
    // Add Animation Style for the Form Shake
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes elite-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .shake-anim { animation: elite-shake 0.4s ease-in-out; }
    `;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>